<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Van | Nobreak Company</title>

  <style>
    @font-face{
      font-family:"Rokiest";
      src:url("https://raw.githubusercontent.com/WAYCOMPANYGG/roteiro/main/assets/fonts/Rokiest-Extrabold.otf") format("opentype");
      font-weight:800;
      font-display:swap;
    }

    :root{
      --bg:#0a0e1a;
      --surface:#141825;
      --elevated:#1a1f2e;
      --border:rgba(255,255,255,.06);
      --text:#f1f5f9;
      --text-dim:#94a3b8;
      --text-muted:#64748b;
      --primary:#a78bfa;
      --primary-light:#c4b5fd;
      --accent:#22d3ee;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
      --slate:#64748b;
    }

    *{box-sizing:border-box; margin:0; padding:0}

    body{
      font-family:'Rokiest','Inter',system-ui,sans-serif;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      padding:20px;
    }

    .container{ max-width:1400px; margin:0 auto; }

    .header{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      padding:24px 32px;
      margin-bottom:24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:20px;
      flex-wrap:wrap;
    }

    .header-title h1{ font-size:32px; letter-spacing:0.5px; margin-bottom:6px; }

    .header-subtitle{ font-size:13px; color:var(--text-muted); font-weight:600; }

    .badge{
      padding:8px 16px;
      border-radius:20px;
      background:var(--elevated);
      border:1px solid var(--border);
      font-size:12px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .home-btn{
      position:fixed;
      top:20px;
      left:20px;
      width:48px;
      height:48px;
      border-radius:12px;
      background:var(--surface);
      border:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:24px;
      text-decoration:none;
      transition:all .2s;
      z-index:100;
    }

    .home-btn:hover{
      transform:translateY(-2px);
      border-color:var(--primary);
      box-shadow:0 8px 24px rgba(167,139,250,.3);
    }

    .card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      padding:32px;
      margin-bottom:24px;
    }

    .card-title{ font-size:20px; font-weight:700; letter-spacing:0.5px; margin-bottom:8px; }

    .card-desc{ font-size:13px; color:var(--text-dim); margin-bottom:24px; font-weight:600; }

    .stats{
      display:flex;
      justify-content:center;
      gap:20px;
      margin-bottom:32px;
      flex-wrap:wrap;
    }

    .stat{
      background:var(--elevated);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px 24px;
      text-align:center;
      min-width:160px;
    }

    .stat-label{
      font-size:11px;
      color:var(--text-muted);
      text-transform:uppercase;
      letter-spacing:1px;
      font-weight:700;
      margin-bottom:6px;
    }

    .stat-value{ font-size:28px; font-weight:900; color:var(--primary-light); }

    .van-container{
      max-width:1200px;
      margin:0 auto;
      padding:10px 10px 40px;
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:24px;
      align-items:start;
    }

    .passenger-side{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      padding:18px;
      position:sticky;
      top:20px;
      height:fit-content;
    }

    .passenger-tools{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }

    .passenger-tools .btn{
      height:38px;
      padding:0 12px;
    }

    .passenger-row{
      display:grid;
      grid-template-columns:54px 1fr 120px;
      align-items:center;
      gap:10px;
      padding:9px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      box-shadow:0 10px 26px rgba(0,0,0,.18);
    }

    .passenger-row input{
      width:100%;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      font-weight:700;
      font-size:13px;
    }

    .passenger-row select{
      background:rgba(20,24,37,.75);
      border:1px solid var(--border);
      border-radius:10px;
      color:var(--text);
      font-weight:800;
      padding:7px 8px;
      font-size:12px;
      outline:none;
    }

    .passenger-row.status-livre{ background:rgba(37,99,235,.25); border-color:rgba(37,99,235,.6); }
    .passenger-row.status-reservado{ background:rgba(249,115,22,.28); border-color:rgba(249,115,22,.65); }
    .passenger-row.status-confirmado{ background:rgba(16,185,129,.28); border-color:rgba(16,185,129,.7); }
    .passenger-row.status-bloqueado{ background:rgba(220,38,38,.32); border-color:rgba(220,38,38,.8); }

    @media(max-width:980px){
      .van-container{ grid-template-columns:1fr; }
      .passenger-side{ position:static; }
    }

    .seat-editor{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      padding:24px;
      margin-bottom:40px;
    }

    .editor-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
      gap:16px;
      flex-wrap:wrap;
    }

    .editor-tools{ display:flex; gap:12px; flex-wrap:wrap; }

    .editor-canvas{
      background:var(--elevated);
      border:2px dashed var(--border);
      border-radius:12px;
      min-height:640px;
      position:relative;
      overflow:hidden;
      background-image:
        repeating-linear-gradient(to right, rgba(255,255,255,.05) 0 1px, transparent 1px 2px),
        repeating-linear-gradient(to bottom, rgba(255,255,255,.05) 0 1px, transparent 1px 2px);
    }

    .editor-canvas::before{
      content:"";
      position:absolute;
      left:50%;
      top:50%;
      width:2px;
      height:110%;
      background:rgba(167,139,250,.18);
      transform:translate(-50%,-50%);
      z-index:2;
      pointer-events:none;
    }

    .editor-canvas::after{
      content:"";
      position:absolute;
      left:50%;
      top:50%;
      width:110%;
      height:2px;
      background:rgba(34,211,238,.14);
      transform:translate(-50%,-50%);
      z-index:2;
      pointer-events:none;
    }

    .canvas-background{
      position:absolute;
      inset:0;
      margin:auto;
      width:95%;
      height:95%;
      opacity:.35;
      pointer-events:none;
      z-index:1;
      object-fit:contain;
      transform:none;
      filter:contrast(1.05) saturate(1.05);
    }

    .canvas-placeholder{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      color:var(--text-muted);
      font-size:14px;
      text-align:center;
      pointer-events:none;
      z-index:3;
      width:90%;
      line-height:1.6;
    }

    .editor-info{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:16px;
      padding-top:16px;
      border-top:1px solid var(--border);
      gap:16px;
      flex-wrap:wrap;
    }

    .info-item{ display:flex; align-items:center; gap:8px; font-size:13px; }

    .info-label{ color:var(--text-dim); font-weight:600; }

    .info-value{ color:var(--primary-light); font-weight:900; font-size:16px; }

    .draggable-seat{
      position:absolute;
      width:38px;
      height:40px;
      overflow:hidden;
      background:linear-gradient(135deg, rgba(167,139,250,.18), rgba(34,211,238,.10));
      border:1px solid rgba(167,139,250,.35);
      border-radius:7px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:1px;
      cursor:grab;
      user-select:none;
      transition:transform .08s, box-shadow .08s, border-color .08s;
      box-shadow:0 4px 10px rgba(0,0,0,.25);
      z-index:10;
    }

    .draggable-seat .seat-num{ font-size:12px; line-height:1; font-weight:900; white-space:nowrap; }

    .draggable-seat .seat-label{ font-size:5px; letter-spacing:.4px; font-weight:800; color:rgba(241,245,249,.55); line-height:1; white-space:nowrap; }

    .draggable-seat:hover{
      transform:scale(1.04);
      border-color:rgba(196,181,253,.8);
      box-shadow:0 8px 18px rgba(167,139,250,.18);
      z-index:100;
    }

    .draggable-seat.dragging{
      cursor:grabbing;
      opacity:0.95;
      transform:scale(1.06);
      z-index:1000;
      box-shadow:0 12px 28px rgba(167,139,250,.22);
    }

    .draggable-seat .delete-btn{
      position:absolute;
      top:2px;
      right:2px;
      width:14px;
      height:14px;
      background:rgba(239,68,68,.95);
      border:1px solid rgba(20,24,37,.9);
      border-radius:50%;
      display:none;
      align-items:center;
      justify-content:center;
      font-size:10px;
      cursor:pointer;
      color:#fff;
      z-index:20;
      line-height:1;
    }

    .draggable-seat:hover .delete-btn{ display:flex; }

    .draggable-seat.locked{
      opacity:.9;
      border-color:rgba(148,163,184,.55);
      background:linear-gradient(135deg, rgba(148,163,184,.22), rgba(100,116,139,.14));
      box-shadow:0 4px 10px rgba(0,0,0,.28);
    }

    .draggable-seat.locked:hover{ transform:none; box-shadow:0 3px 8px rgba(0,0,0,.22); border-color:rgba(148,163,184,.35); }

    .draggable-seat.locked .delete-btn{ display:none !important; }

    .draggable-seat.locked::after{ content:"üîí"; position:absolute; bottom:2px; right:2px; font-size:10px; opacity:.85; pointer-events:none; }

    .draggable-seat.status-livre{
      border-color:rgba(37,99,235,1);
      background:linear-gradient(135deg, rgba(37,99,235,.9), rgba(29,78,216,.6));
      color:#eff6ff;
      box-shadow:0 6px 16px rgba(37,99,235,.45);
    }

    .draggable-seat.status-reservado{
      border-color:rgba(249,115,22,1);
      background:linear-gradient(135deg, rgba(249,115,22,.95), rgba(194,65,12,.6));
      color:#fff7ed;
      box-shadow:0 6px 16px rgba(249,115,22,.45);
    }

    .draggable-seat.status-confirmado{
      border-color:rgba(16,185,129,1);
      background:linear-gradient(135deg, rgba(16,185,129,1), rgba(5,150,105,.7));
      color:#ecfdf5;
      box-shadow:0 8px 20px rgba(16,185,129,.55);
    }

    .draggable-seat.status-bloqueado{
      border-color:rgba(220,38,38,1);
      background:linear-gradient(135deg, rgba(220,38,38,1), rgba(153,27,27,.75));
      color:#fef2f2;
      box-shadow:0 8px 22px rgba(220,38,38,.6);
      opacity:1;
    }

    .editor-locked .draggable-seat{ cursor:not-allowed; }
    .editor-locked .draggable-seat:hover{ transform:none; }
    .editor-locked .draggable-seat .delete-btn{ display:none !important; }

    .btn{
      height:44px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--elevated);
      color:var(--text);
      padding:0 16px;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
      transition:all .15s;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    .btn:hover{ transform:translateY(-2px); border-color:var(--primary); box-shadow:0 10px 26px rgba(0,0,0,.35); }

    .btn-primary{ background:linear-gradient(135deg, var(--primary), var(--accent)); border-color:transparent; color:#fff; }

    .btn-success{ border-color:rgba(16,185,129,.35); }

    .toast{
      position:fixed;
      bottom:20px;
      right:20px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px 20px;
      font-size:14px;
      font-weight:700;
      box-shadow:0 20px 50px rgba(0,0,0,.8);
      transform:translateY(100px);
      opacity:0;
      transition:all .25s;
      z-index:2000;
    }

    .toast.show{ transform:translateY(0); opacity:1; }

    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.7);
      backdrop-filter:blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
      padding:20px;
    }

    .modal{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:20px;
      padding:32px;
      max-width:500px;
      width:100%;
      box-shadow:0 40px 100px rgba(0,0,0,.8);
    }

    .modal-title{ font-size:24px; font-weight:700; margin-bottom:20px; }

    .modal-content{ font-size:14px; color:var(--text-dim); line-height:1.6; margin-bottom:24px; font-weight:600; }

    @media(max-width:768px){
  body{ padding:10px; }

  .header{
    padding:14px;
    gap:10px;
  }

  .header-title h1{ font-size:22px; }

  .stats{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }

  .stat{ min-width:unset; }

  .van-container{
    grid-template-columns:1fr;
    gap:16px;
  }

  .seat-editor{
    padding:14px;
  }

  .editor-header{
    flex-direction:column;
    align-items:flex-start;
    gap:12px;
  }

  .editor-tools{
    width:100%;
    overflow-x:auto;
    flex-wrap:nowrap;
    padding-bottom:6px;
  }

  .editor-canvas{
    min-height:70vh;
    border-radius:14px;
  }

  .canvas-background{
    width:100%;
    height:100%;
  }

  .passenger-side{
    padding:14px;
  }

  .passenger-tools{
    overflow-x:auto;
    flex-wrap:nowrap;
  }

  .passenger-row{
    grid-template-columns:44px 1fr 96px;
    gap:6px;
    padding:8px 8px;
  }

  .passenger-row input{ font-size:12px; }
  .passenger-row select{ font-size:11px; }

  .toast{ bottom:12px; right:12px; }
}

@media(max-width:420px){
  .stats{ grid-template-columns:1fr; }
}

      .home-btn{ top:12px; left:12px; width:44px; height:44px; border-radius:12px; font-size:22px; }
      .header{ padding:16px 16px; border-radius:14px; gap:12px; }
      .header-title h1{ font-size:26px; }
      .badge{ padding:7px 12px; font-size:11px; }
      .card{ padding:18px; border-radius:14px; }
      .stats{ gap:12px; margin-bottom:18px; }
      .stat{ min-width:140px; padding:12px 14px; }
      .stat-value{ font-size:24px; }

      .van-container{ grid-template-columns:1fr; gap:14px; padding:6px 4px 24px; }
      .seat-editor{ padding:16px; margin-bottom:0; }

      .editor-header{ gap:10px; }
      .editor-tools{
        width:100%;
        overflow-x:auto;
        -webkit-overflow-scrolling:touch;
        padding-bottom:6px;
        flex-wrap:nowrap;
      }
      .editor-tools::-webkit-scrollbar{ height:6px; }
      .editor-tools::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.12); border-radius:999px; }

      .btn{ height:40px; padding:0 12px; font-size:13px; white-space:nowrap; }

      .editor-canvas{
        min-height:62vh;
        max-height:72vh;
        touch-action:none;
      }

      .draggable-seat{ width:42px; height:44px; }
      .draggable-seat .seat-num{ font-size:13px; }
      .draggable-seat .seat-label{ font-size:6px; }
      .draggable-seat .delete-btn{ width:16px; height:16px; font-size:11px; }

      .passenger-side{ padding:14px; border-radius:14px; }
      .passenger-tools{ overflow-x:auto; flex-wrap:nowrap; padding-bottom:6px; }
      .passenger-tools::-webkit-scrollbar{ height:6px; }
      .passenger-tools::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.12); border-radius:999px; }

      .passenger-row{ grid-template-columns:50px 1fr 110px; gap:8px; padding:9px 10px; }
      .passenger-row input{ font-size:13px; }
      .passenger-row select{ font-size:12px; }

      .toast{ right:12px; bottom:12px; }
    }

    @media(max-width:420px){
      .stat{ min-width:46%; }
      .passenger-row{ grid-template-columns:46px 1fr 104px; }
      .passenger-row select{ padding:6px 7px; }
    }
  </style>
</head>

<body>
<a class="home-btn" href="index.html">üè†</a>

<div class="container">
  <header class="header">
    <div class="header-title">
      <h1>VAN</h1>
      <div class="header-subtitle">Nobreak Company ‚Ä¢ Gest√£o de Transporte</div>
    </div>
    <div style="display:flex; gap:12px">
      <div class="badge">üöê Transporte</div>
      <div class="badge">‚ö†Ô∏è Em Pausa</div>
    </div>
  </header>

  <div class="card">
    <h2 class="card-title">STATUS DO M√ìDULO</h2>
    <p class="card-desc">Sistema de van temporariamente em pausa</p>

    <div style="background:rgba(245,158,11,.1); border:1px solid rgba(245,158,11,.3); border-radius:12px; padding:20px; margin-bottom:24px">
      <strong style="color:var(--warning)">‚ö†Ô∏è M√ìDULO EM PAUSA</strong>
      <p style="margin-top:8px; font-size:13px; line-height:1.6; color:var(--text-dim)">
        O sistema de van est√° pausado no momento. Quando voc√™ quiser reativar, podemos conectar com o Apps Script
        para reservas em tempo real, bloqueio de assentos, expira√ß√£o autom√°tica e painel admin.
      </p>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="stat-label">Total Assentos</div>
        <div class="stat-value" id="totalSeats">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Livres</div>
        <div class="stat-value" style="color:var(--success)" id="freeSeats">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Ocupados</div>
        <div class="stat-value" style="color:var(--warning)" id="takenSeats">0</div>
      </div>
    </div>

    <div class="van-container">
      <div class="seat-editor">
        <div class="editor-header">
          <h3 style="margin:0; font-size:18px">EDITOR DE MAPA</h3>
          <div class="editor-tools">
            <button class="btn btn-primary" onclick="addSeat()">‚ûï Adicionar Assento</button>
            <button class="btn" onclick="toggleSnap()" id="btnSnap">üß≤ Snap: ON</button>
            <button class="btn" onclick="toggleVanOpacity()" id="btnVan">üñºÔ∏è Van: 35%</button>
            <button class="btn" onclick="toggleEditorLock()" id="btnLock">üîì Destravado</button>
            <button class="btn" onclick="clearMap()">üóëÔ∏è Limpar Tudo</button>
            <button class="btn btn-success" onclick="saveMap()">üíæ Salvar Mapa</button>
          </div>
        </div>

        <div class="editor-canvas" id="editorCanvas">
          <img src="assets/images/van.png" alt="Van" class="canvas-background" id="vanBg">
          <div class="canvas-placeholder" id="canvasPlaceholder">
            Clique em <b>‚ÄúAdicionar Assento‚Äù</b> e arraste.<br>
            Dica: com o <b>Snap</b> ligado, os assentos encaixam certinho na grade.
          </div>
        </div>

        <div class="editor-info">
          <div class="info-item">
            <span class="info-label">Total de assentos:</span>
            <span class="info-value" id="totalSeatsEditor">0</span>
          </div>
          <div class="info-item">
            <span class="info-label">Duplo clique no assento para editar</span>
          </div>
        </div>
      </div>

      <div class="passenger-side">
        <h3 style="font-size:14px; margin-bottom:12px; color:var(--text-dim); font-weight:700; text-transform:uppercase; letter-spacing:1px">PASSAGEIROS</h3>

        <div class="passenger-tools">
          <button class="btn" onclick="setAllStatus('livre')">üü¢ Livre</button>
          <button class="btn" onclick="setAllStatus('reservado')">üü† Reservado</button>
          <button class="btn" onclick="setAllStatus('confirmado')">‚úÖ Confirmado</button>
          <button class="btn" onclick="setAllStatus('bloqueado')">‚õî Bloqueado</button>
        </div>

        <div id="passengerPanel" style="display:grid; grid-template-columns:1fr; gap:8px"></div>
      </div>
    </div>
  </div>
</div>

<div id="modalOverlay" class="modal-overlay">
  <div class="modal">
    <h3 class="modal-title">üöê M√ìDULO EM PAUSA</h3>
    <div class="modal-content">
      O sistema de van est√° temporariamente desativado. Quando voc√™ quiser reativar, podemos implementar:
      <ul style="margin-top:12px; margin-left:20px; color:var(--text-dim)">
        <li>Reserva de assentos em tempo real</li>
        <li>Bloqueio autom√°tico durante reserva</li>
        <li>Expira√ß√£o de reservas</li>
        <li>Painel administrativo</li>
        <li>Sincroniza√ß√£o via Apps Script</li>
      </ul>
    </div>
    <button class="btn btn-primary" onclick="closeModal()">Entendi</button>
  </div>
</div>

<div id="toast" class="toast">‚úÖ Sucesso</div>

<script>
  const GRID = 2;
  let snapEnabled = true;
  let vanOpacity = 0.35;
  let editorLocked = false;

  let seatCounter = 1;
  let seats = [];

  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 1800);
  }

  function openModal(){
    document.getElementById("modalOverlay").style.display = "flex";
  }

  function closeModal(){
    document.getElementById("modalOverlay").style.display = "none";
  }

  function toggleSnap(){
    snapEnabled = !snapEnabled;
    const btn = document.getElementById("btnSnap");
    if(btn) btn.textContent = snapEnabled ? "üß≤ Snap: ON" : "üß≤ Snap: OFF";
    toast(snapEnabled ? "üß≤ Snap ativado" : "üß≤ Snap desativado");
  }

  function toggleVanOpacity(){
    const img = document.getElementById("vanBg");
    if(!img) return;

    vanOpacity = (vanOpacity === 0.35) ? 0.15 : (vanOpacity === 0.15 ? 0.55 : 0.75);
    img.style.opacity = vanOpacity;

    const btn = document.getElementById("btnVan");
    if(btn) btn.textContent = `üñºÔ∏è Van: ${Math.round(vanOpacity*100)}%`;
    toast(`üñºÔ∏è Opacidade ${Math.round(vanOpacity*100)}%`);
  }

  function setEditorLockedState(){
    const canvas = document.getElementById("editorCanvas");
    const btn = document.getElementById("btnLock");

    if(canvas) canvas.classList.toggle("editor-locked", editorLocked);
    if(btn) btn.textContent = editorLocked ? "üîí Travado" : "üîì Destravado";
  }

  function toggleEditorLock(){
    editorLocked = !editorLocked;
    setEditorLockedState();
    toast(editorLocked ? "üîí Edi√ß√£o travada" : "üîì Edi√ß√£o destravada");
  }

  function normalizeStatus(st){
    if(st === "reservado" || st === "confirmado" || st === "bloqueado") return st;
    return "livre";
  }

  function applySeatVisual(seatEl, seatData){
    if(!seatEl || !seatData) return;

    seatEl.classList.remove("status-livre","status-reservado","status-confirmado","status-bloqueado");
    seatEl.classList.add(`status-${normalizeStatus(seatData.status)}`);

    seatEl.classList.toggle("locked", !!seatData.locked);
  }

  function toggleSeatLock(seatId){
    const seatEl = document.getElementById(seatId);
    const seatData = seats.find(s => s.id === seatId);
    if(!seatEl || !seatData) return;

    seatData.locked = !seatData.locked;
    applySeatVisual(seatEl, seatData);
    toast(seatData.locked ? `üîí Assento #${seatData.number} travado` : `üîì Assento #${seatData.number} destravado`);
  }

  const vanImg = document.getElementById('vanBg');
  const paths = [
    'assets/images/van.png',
    './assets/images/van.png',
    'assets/images/van.png',
    'van.png'
  ];
  let currentPath = 0;

  if(vanImg){
    vanImg.onerror = function(){
      currentPath++;
      if(currentPath < paths.length){
        vanImg.src = paths[currentPath];
      }else{
        vanImg.style.display = 'none';
        toast("‚ùå N√£o carregou a imagem da van");
      }
    };

    vanImg.onload = function(){
      vanImg.style.opacity = vanOpacity;
    };
  }

  function placeSeatFromSaved(seatEl, seatData){
    const canvas = document.getElementById("editorCanvas");
    if(!canvas) return;

    const canvasRect = canvas.getBoundingClientRect();
    const w = seatEl.offsetWidth;
    const h = seatEl.offsetHeight;

    const maxX = Math.max(1, canvasRect.width  - w);
    const maxY = Math.max(1, canvasRect.height - h);

    let x;
    let y;

    if(typeof seatData.x === "string" && seatData.x.includes("%")){
      const xPct = parseFloat(seatData.x) || 0;
      const yPct = parseFloat(seatData.y) || 0;
      x = (xPct / 100) * maxX;
      y = (yPct / 100) * maxY;
    }else{
      x = parseFloat(seatData.x) || 0;
      y = parseFloat(seatData.y) || 0;
    }

    x = Math.max(0, Math.min(x, maxX));
    y = Math.max(0, Math.min(y, maxY));

    if(snapEnabled){
      x = Math.round((x + w/2) / GRID) * GRID - w/2;
      y = Math.round((y + h/2) / GRID) * GRID - h/2;
      x = Math.max(0, Math.min(x, maxX));
      y = Math.max(0, Math.min(y, maxY));
    }

    seatEl.style.left = x + "px";
    seatEl.style.top  = y + "px";
  }

  function addSeat(){
    const canvas = document.getElementById("editorCanvas");
    const placeholder = document.getElementById("canvasPlaceholder");
    if(!canvas) return;

    if(placeholder) placeholder.style.display = "none";

    const seat = document.createElement("div");
    seat.className = "draggable-seat";
    seat.id = `seat-${seatCounter}`;
    seat.innerHTML = `
      <div class="seat-num">#${seatCounter}</div>
      <div class="seat-label">ASSENTO</div>
      <div class="delete-btn" onclick="deleteSeat('${seat.id}')">‚úï</div>
    `;

    seat.style.left = "0px";
    seat.style.top  = "0px";
    canvas.appendChild(seat);

    const canvasRect = canvas.getBoundingClientRect();
    const w = seat.offsetWidth;
    const h = seat.offsetHeight;

    let x = (canvasRect.width  / 2) - (w / 2);
    let y = (canvasRect.height / 2) - (h / 2);

    if(snapEnabled){
      x = Math.round(x / GRID) * GRID;
      y = Math.round(y / GRID) * GRID;
    }

    x = Math.max(0, Math.min(x, canvasRect.width  - w));
    y = Math.max(0, Math.min(y, canvasRect.height - h));

    seat.style.left = x + "px";
    seat.style.top  = y + "px";

    makeDraggable(seat);

    const maxX = Math.max(1, canvasRect.width  - w);
    const maxY = Math.max(1, canvasRect.height - h);

    const xPct = (x / maxX) * 100;
    const yPct = (y / maxY) * 100;

    const seatData = {
      id: seat.id,
      number: String(seatCounter),
      x: `${xPct.toFixed(2)}%`,
      y: `${yPct.toFixed(2)}%`,
      locked: false,
      status: "livre",
      name: ""
    };

    seats.push(seatData);
    applySeatVisual(seat, seatData);

    seatCounter++;
    updateSeatCount();
    toast(`‚úÖ Assento #${seatCounter - 1} adicionado`);
  }

  function rectsOverlap(a,b){
    return !(a.right <= b.left || a.left >= b.right || a.bottom <= b.top || a.top >= b.bottom);
  }

  function isOverlapping(element, x, y){
    const w = element.offsetWidth;
    const h = element.offsetHeight;
    const r1 = { left:x, top:y, right:x+w, bottom:y+h };

    return Array.from(document.querySelectorAll('.draggable-seat')).some(el => {
      if(el === element) return false;
      const ex = parseFloat(el.style.left)||0;
      const ey = parseFloat(el.style.top)||0;
      const ew = el.offsetWidth;
      const eh = el.offsetHeight;
      const r2 = { left:ex, top:ey, right:ex+ew, bottom:ey+eh };
      return rectsOverlap(r1, r2);
    });
  }

  function makeDraggable(element){
    element.addEventListener("contextmenu", (e) => {
      e.preventDefault();
      toggleSeatLock(element.id);
    });

    let isDragging = false;
    let pointerId = null;

    element.addEventListener("pointerdown", dragStart);
    document.addEventListener("pointermove", drag);
    document.addEventListener("pointerup", dragEnd);
    document.addEventListener("pointercancel", dragEnd);

    function dragStart(e){
      if(e.target.classList.contains("delete-btn")) return;
      if(editorLocked) return;

      if(e.pointerType === "touch"){
        e.preventDefault();
      }

      isDragging = true;
      pointerId = e.pointerId;
      element.setPointerCapture?.(pointerId);
      element.classList.add("dragging");
    }

    function drag(e){
      if(!isDragging) return;
      if(pointerId !== null && e.pointerId !== pointerId) return;

      const canvas = document.getElementById("editorCanvas");
      const canvasRect = canvas.getBoundingClientRect();

      let currentX = e.clientX - canvasRect.left - element.offsetWidth / 2;
      let currentY = e.clientY - canvasRect.top  - element.offsetHeight / 2;

      currentX = Math.max(0, Math.min(currentX, canvasRect.width  - element.offsetWidth));
      currentY = Math.max(0, Math.min(currentY, canvasRect.height - element.offsetHeight));

      if(snapEnabled){
        currentX = Math.round((currentX + element.offsetWidth/2) / GRID) * GRID - element.offsetWidth/2;
        currentY = Math.round((currentY + element.offsetHeight/2) / GRID) * GRID - element.offsetHeight/2;
        currentX = Math.max(0, Math.min(currentX, canvasRect.width  - element.offsetWidth));
        currentY = Math.max(0, Math.min(currentY, canvasRect.height - element.offsetHeight));
      }

      if(!isOverlapping(element, currentX, currentY)){
        element.style.left = currentX + "px";
        element.style.top  = currentY + "px";
      }
    }

    function dragEnd(e){
      if(!isDragging) return;
      if(pointerId !== null && e.pointerId !== pointerId) return;

      isDragging = false;
      element.classList.remove("dragging");
      try{ element.releasePointerCapture?.(pointerId); }catch(_e){}
      pointerId = null;

      const canvas = document.getElementById("editorCanvas");
      const canvasRect = canvas.getBoundingClientRect();

      const leftPx = parseFloat(element.style.left) || 0;
      const topPx  = parseFloat(element.style.top)  || 0;

      const maxX = Math.max(1, canvasRect.width  - element.offsetWidth);
      const maxY = Math.max(1, canvasRect.height - element.offsetHeight);

      const xPct = (leftPx / maxX) * 100;
      const yPct = (topPx  / maxY) * 100;

      const seatData = seats.find(s => s.id === element.id);
      if(seatData){
        seatData.x = `${xPct.toFixed(2)}%`;
        seatData.y = `${yPct.toFixed(2)}%`;
      }
    }

    element.addEventListener("dblclick", function(){
      if(editorLocked) return;
      if(element.classList.contains("locked")) return;

      const numEl = element.querySelector(".seat-num");
      const currentNum = (numEl?.textContent || "").replace('#','').trim();
      const newNumber = prompt("Digite o novo n√∫mero do assento:", currentNum);
      if(!newNumber) return;

      const deleteBtn = element.querySelector('.delete-btn');
      element.innerHTML = `
        <div class="seat-num">#${newNumber}</div>
        <div class="seat-label">ASSENTO</div>
      `;
      if(deleteBtn) element.appendChild(deleteBtn);

      const seatData = seats.find(s => s.id === element.id);
      if(seatData) seatData.number = String(newNumber);

      toast(`‚úÖ Assento renomeado para #${newNumber}`);
      renderPassengerList();
    });
  }

  function deleteSeat(seatId){
    const seat = document.getElementById(seatId);
    if(!seat) return;

    if(editorLocked || seat.classList.contains("locked")){
      toast("üîí Assento travado ‚Äî destrave para remover");
      return;
    }

    seat.remove();
    seats = seats.filter(s => s.id !== seatId);
    updateSeatCount();
    toast("üóëÔ∏è Assento removido");

    const canvas = document.getElementById("editorCanvas");
    if(canvas && canvas.querySelectorAll(".draggable-seat").length === 0){
      const placeholder = document.getElementById("canvasPlaceholder");
      if(placeholder) placeholder.style.display = "block";
    }
  }

  function clearMap(){
    if(!confirm("Tem certeza que deseja limpar todos os assentos?")) return;

    const canvas = document.getElementById("editorCanvas");
    if(!canvas) return;

    canvas.querySelectorAll(".draggable-seat").forEach(s => s.remove());

    seats = [];
    seatCounter = 1;
    updateSeatCount();

    const placeholder = document.getElementById("canvasPlaceholder");
    if(placeholder) placeholder.style.display = "block";

    toast("üóëÔ∏è Mapa limpo");
  }

  function saveMap(){
    if(seats.length === 0){
      toast("‚ö†Ô∏è Adicione assentos primeiro");
      return;
    }

    const mapData = {
      seats,
      editorLocked,
      timestamp: new Date().toISOString(),
      grid: GRID,
      snapEnabled,
      vanOpacity
    };

    localStorage.setItem("vanSeatMap", JSON.stringify(mapData));
    toast("üíæ Mapa salvo com sucesso!");
  }

  function loadSavedMap(){
    const saved = localStorage.getItem("vanSeatMap");
    if(!saved) return;

    try{
      const mapData = JSON.parse(saved);
      const canvas = document.getElementById("editorCanvas");
      const placeholder = document.getElementById("canvasPlaceholder");

      if(typeof mapData.editorLocked === "boolean"){
        editorLocked = mapData.editorLocked;
        setEditorLockedState();
      }

      if(typeof mapData.snapEnabled === "boolean"){
        snapEnabled = mapData.snapEnabled;
        const btn = document.getElementById("btnSnap");
        if(btn) btn.textContent = snapEnabled ? "üß≤ Snap: ON" : "üß≤ Snap: OFF";
      }

      if(typeof mapData.vanOpacity === "number"){
        vanOpacity = mapData.vanOpacity;
        const img = document.getElementById("vanBg");
        if(img) img.style.opacity = vanOpacity;
        const btnVan = document.getElementById("btnVan");
        if(btnVan) btnVan.textContent = `üñºÔ∏è Van: ${Math.round(vanOpacity*100)}%`;
      }

      if(!canvas) return;
      canvas.querySelectorAll(".draggable-seat").forEach(el => el.remove());

      const loadedSeats = (mapData.seats || []).map(s => ({
        id: String(s.id),
        number: String(s.number ?? ""),
        x: String(s.x ?? "0%"),
        y: String(s.y ?? "0%"),
        locked: !!s.locked,
        status: normalizeStatus(s.status),
        name: typeof s.name === "string" ? s.name : ""
      }));

      loadedSeats.forEach(seatData => {
        const seat = document.createElement("div");
        seat.className = "draggable-seat";
        seat.id = seatData.id;
        seat.innerHTML = `
          <div class="seat-num">#${seatData.number}</div>
          <div class="seat-label">ASSENTO</div>
          <div class="delete-btn" onclick="deleteSeat('${seatData.id}')">‚úï</div>
        `;

        makeDraggable(seat);
        canvas.appendChild(seat);
        placeSeatFromSaved(seat, seatData);
        applySeatVisual(seat, seatData);
      });

      seats = loadedSeats;

      const nums = seats.map(s => parseInt(s.number, 10)).filter(n => !Number.isNaN(n));
      seatCounter = (nums.length ? Math.max(...nums) : 0) + 1;

      if(placeholder) placeholder.style.display = seats.length ? "none" : "block";
      updateSeatCount();

      toast("‚úÖ Mapa carregado");
    }catch(e){
      toast("‚ùå Erro ao carregar mapa");
    }
  }

  function updateSeatCount(){
    const totalEditor = document.getElementById("totalSeatsEditor");
    if(totalEditor) totalEditor.textContent = seats.length;

    renderPassengerList();
    updateStats();
  }

  function updateStats(){
    const totalEl = document.getElementById("totalSeats");
    const freeEl = document.getElementById("freeSeats");
    const takenEl = document.getElementById("takenSeats");

    const total = seats.length;
    const free = seats.filter(s => normalizeStatus(s.status) === "livre").length;
    const taken = total - free;

    if(totalEl) totalEl.textContent = total;
    if(freeEl) freeEl.textContent = free;
    if(takenEl) takenEl.textContent = taken;
  }

  function renderPassengerList(){
    const panel = document.getElementById("passengerPanel");
    if(!panel) return;

    panel.innerHTML = "";

    seats
      .slice()
      .sort((a,b) => String(a.number).localeCompare(String(b.number), undefined, {numeric:true}))
      .forEach(seat => {
        const st = normalizeStatus(seat.status);
        const row = document.createElement("div");
        row.className = `passenger-row status-${st}`;

        row.innerHTML = `
          <div style="font-weight:900; color:var(--primary-light)">#${seat.number}</div>
          <input type="text" placeholder="Nome" value="${seat.name || ""}" onchange="updatePassengerName('${seat.id}', this.value)" />
          <select onchange="updateSeatStatus('${seat.id}', this.value)">
            <option value="livre" ${st==='livre'?'selected':''}>Livre</option>
            <option value="reservado" ${st==='reservado'?'selected':''}>Reservado</option>
            <option value="confirmado" ${st==='confirmado'?'selected':''}>Confirmado</option>
            <option value="bloqueado" ${st==='bloqueado'?'selected':''}>Bloqueado</option>
          </select>
        `;

        panel.appendChild(row);
      });
  }

  function updatePassengerName(seatId, name){
    const seat = seats.find(s => s.id === seatId);
    if(!seat) return;
    seat.name = name;
    toast(name ? "üë§ Passageiro atualizado" : "üë§ Nome removido");
  }

  function updateSeatStatus(seatId, status){
    const seat = seats.find(s => s.id === seatId);
    const seatEl = document.getElementById(seatId);
    if(!seat || !seatEl) return;

    seat.status = normalizeStatus(status);
    applySeatVisual(seatEl, seat);
    updateStats();
    renderPassengerList();
    toast(`üé´ Assento #${seat.number} ‚Üí ${seat.status}`);
  }

  function setAllStatus(status){
    const st = normalizeStatus(status);

    seats.forEach(s => {
      s.status = st;
      const el = document.getElementById(s.id);
      if(el) applySeatVisual(el, s);
    });

    updateStats();
    renderPassengerList();
    toast(`‚ö° Status aplicado: ${st}`);
  }

  document.getElementById("modalOverlay").addEventListener("click", (e) => {
    if(e.target.id === "modalOverlay") closeModal();
  });

  window.addEventListener("DOMContentLoaded", () => {
    setEditorLockedState();
    loadSavedMap();
    updateSeatCount();
  });

  window.addEventListener("resize", () => {
    seats.forEach(s => {
      const el = document.getElementById(s.id);
      if(el) placeSeatFromSaved(el, s);
    });
  });
</script>
</body>
</html>
