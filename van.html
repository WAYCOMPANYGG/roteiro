<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Van | Nobreak Company</title>

  <style>
    @font-face{
      font-family:"Rokiest";
      src:url("https://raw.githubusercontent.com/WAYCOMPANYGG/roteiro/main/assets/fonts/Rokiest-Extrabold.otf") format("opentype");
      font-weight:800;
      font-display:swap;
    }

    :root{
      --bg:#0a0e1a;
      --surface:#141825;
      --elevated:#1a1f2e;
      --border:rgba(255,255,255,.06);
      --text:#f1f5f9;
      --text-dim:#94a3b8;
      --text-muted:#64748b;
      --primary:#a78bfa;
      --primary-light:#c4b5fd;
      --accent:#22d3ee;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
      --slate:#64748b;
    }

    *{box-sizing:border-box; margin:0; padding:0}

    body{
      font-family:'Rokiest','Inter',system-ui,sans-serif;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      padding:20px;
    }

    .container{
      max-width:1600px;
      margin:0 auto;
    }

    /* HEADER */
    .header{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      padding:28px 36px;
      margin-bottom:24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:24px;
      flex-wrap:wrap;
      position:relative;
      overflow:hidden;
    }

    .header::before{
      content:"";
      position:absolute;
      top:-50%;
      right:-10%;
      width:400px;
      height:400px;
      background:radial-gradient(circle, rgba(167,139,250,0.15), transparent 70%);
      pointer-events:none;
    }

    .header-content{
      position:relative;
      z-index:1;
    }

    .header-title{
      font-size:42px;
      letter-spacing:1px;
      margin-bottom:8px;
      background:linear-gradient(135deg, var(--primary-light), var(--accent));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }

    .header-subtitle{
      font-size:14px;
      color:var(--text-dim);
      font-weight:700;
      letter-spacing:0.5px;
    }

    .header-badges{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }

    .badge{
      padding:10px 18px;
      border-radius:24px;
      background:var(--elevated);
      border:1px solid var(--border);
      font-size:13px;
      font-weight:800;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow:0 8px 20px rgba(0,0,0,0.2);
    }

    /* STATS BAR */
    .stats-bar{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
      gap:20px;
      margin-bottom:24px;
    }

    .stat-box{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:14px;
      padding:24px;
      position:relative;
      overflow:hidden;
      transition:all 0.3s;
    }

    .stat-box:hover{
      border-color:var(--primary);
      transform:translateY(-4px);
      box-shadow:0 12px 32px rgba(167,139,250,0.25);
    }

    .stat-box::before{
      content:"";
      position:absolute;
      top:-50%;
      right:-30%;
      width:200px;
      height:200px;
      background:radial-gradient(circle, var(--primary), transparent 60%);
      opacity:0.08;
      pointer-events:none;
    }

    .stat-label{
      font-size:12px;
      color:var(--text-muted);
      text-transform:uppercase;
      letter-spacing:1.5px;
      font-weight:800;
      margin-bottom:12px;
    }

    .stat-value{
      font-size:48px;
      font-weight:900;
      line-height:1;
      background:linear-gradient(135deg, var(--primary-light), var(--accent));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }

    /* MAIN LAYOUT */
    .main-layout{
      display:grid;
      grid-template-columns:1fr 400px;
      gap:24px;
      align-items:start;
    }

    /* CANVAS SECTION */
    .canvas-section{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      padding:20px;
      box-shadow:0 10px 30px rgba(0,0,0,0.3);
    }

    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:18px;
      gap:16px;
      flex-wrap:wrap;
    }

    .section-title{
      font-size:20px;
      font-weight:800;
      letter-spacing:0.5px;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .section-icon{
      font-size:24px;
    }

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .btn{
      height:42px;
      padding:0 18px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--elevated);
      color:var(--text);
      font-size:13px;
      font-weight:800;
      cursor:pointer;
      transition:all 0.2s;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
    }

    .btn:hover{
      transform:translateY(-2px);
      border-color:var(--primary);
      box-shadow:0 8px 24px rgba(167,139,250,0.3);
    }

    .btn-primary{
      background:linear-gradient(135deg, var(--primary), var(--accent));
      border:none;
      color:#fff;
    }

    .btn-primary:hover{
      box-shadow:0 12px 32px rgba(167,139,250,0.5);
    }

    .btn-success{
      background:var(--success);
      border:none;
      color:#fff;
    }

    .btn-danger{
      background:var(--danger);
      border:none;
      color:#fff;
    }

    .btn-danger:hover{
      opacity:0.9;
    }

    /* WHATSAPP BUTTON */
    .btn-whatsapp{
      background:#25d366 !important;
      border:none !important;
      color:#fff !important;
      position:relative;
      animation:whatsappPulse 2s ease-in-out infinite;
      box-shadow:0 4px 15px rgba(37,211,102,0.4) !important;
    }

    .btn-whatsapp:hover{
      animation:none;
      transform:translateY(-3px) !important;
      box-shadow:0 8px 25px rgba(37,211,102,0.6) !important;
    }

    .btn-whatsapp::before{
      content:"NOVO";
      position:absolute;
      top:-8px;
      right:-8px;
      background:linear-gradient(135deg, #ff3b3b, #ff6b6b);
      color:#fff;
      font-size:9px;
      font-weight:900;
      padding:3px 8px;
      border-radius:10px;
      box-shadow:0 2px 8px rgba(255,59,59,0.5);
      animation:badgeBounce 1s ease-in-out infinite;
      z-index:10;
    }

    @keyframes whatsappPulse{
      0%, 100%{ transform:scale(1); }
      50%{ transform:scale(1.05); }
    }

    @keyframes badgeBounce{
      0%, 100%{ transform:translateY(0); }
      50%{ transform:translateY(-3px); }
    }

    /* CANVAS */
    .canvas{
      background:var(--elevated);
      border:2px dashed var(--border);
      border-radius:14px;
      min-height:750px;
      position:relative;
      overflow:hidden;
    }

    .canvas-bg{
      position:absolute;
      inset:0;
      margin:auto;
      width:70%;
      height:90%;
      opacity:0.3;
      pointer-events:none;
      object-fit:contain;
      filter:brightness(1.1) contrast(1.05);
    }

    .canvas-hint{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      color:var(--text-muted);
      font-size:15px;
      text-align:center;
      pointer-events:none;
      z-index:5;
      line-height:1.8;
    }

    .canvas-hint strong{
      color:var(--primary-light);
      font-weight:800;
    }

    .canvas-info{
      margin-top:16px;
      padding-top:16px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:12px;
    }

    .info-item{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:13px;
    }

    .info-label{
      color:var(--text-dim);
      font-weight:700;
    }

    .info-value{
      color:var(--primary-light);
      font-weight:900;
      font-size:18px;
    }

    /* SEAT */
    .seat{
      position:absolute;
      width:44px;
      height:48px;
      background:linear-gradient(135deg, rgba(167,139,250,.2), rgba(34,211,238,.12));
      border:2px solid rgba(167,139,250,.4);
      border-radius:8px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:2px;
      cursor:grab;
      user-select:none;
      transition:all 0.12s;
      box-shadow:0 6px 16px rgba(0,0,0,0.3);
      z-index:10;
    }

    .seat:hover{
      transform:scale(1.12);
      border-color:rgba(196,181,253,.8);
      box-shadow:0 10px 28px rgba(167,139,250,0.4);
      z-index:100;
    }

    .seat.dragging{
      cursor:grabbing;
      opacity:0.9;
      transform:scale(1.15);
      z-index:999;
      box-shadow:0 14px 36px rgba(167,139,250,0.5);
    }

    .seat-num{
      font-size:14px;
      font-weight:900;
      line-height:1;
    }

    .seat-tag{
      font-size:7px;
      font-weight:800;
      color:rgba(241,245,249,.6);
      letter-spacing:0.5px;
      line-height:1;
    }

    .seat-delete{
      position:absolute;
      top:-8px;
      right:-8px;
      width:20px;
      height:20px;
      background:var(--danger);
      border:2px solid var(--bg);
      border-radius:50%;
      display:none;
      align-items:center;
      justify-content:center;
      font-size:12px;
      cursor:pointer;
      color:#fff;
      z-index:20;
      font-weight:900;
    }

    .seat:hover .seat-delete{
      display:flex;
    }

    .seat.status-livre{
      background:linear-gradient(135deg, rgba(37,99,235,1), rgba(29,78,216,0.8));
      border-color:rgba(37,99,235,1);
      color:#fff;
      box-shadow:0 8px 22px rgba(37,99,235,0.5);
    }

    .seat.status-reservado{
      background:linear-gradient(135deg, rgba(245,158,11,1), rgba(217,119,6,0.8));
      border-color:rgba(245,158,11,1);
      color:#fff;
      box-shadow:0 8px 22px rgba(245,158,11,0.5);
    }

    .seat.status-confirmado{
      background:linear-gradient(135deg, rgba(16,185,129,1), rgba(5,150,105,0.8));
      border-color:rgba(16,185,129,1);
      color:#fff;
      box-shadow:0 8px 22px rgba(16,185,129,0.5);
    }

    .seat.status-bloqueado{
      background:linear-gradient(135deg, rgba(239,68,68,1), rgba(220,38,38,0.8));
      border-color:rgba(239,68,68,1);
      color:#fff;
      box-shadow:0 8px 22px rgba(239,68,68,0.5);
    }

    .seat.locked{
      opacity:0.7;
      cursor:not-allowed;
    }

    .seat.locked::after{
      content:"üîí";
      position:absolute;
      bottom:3px;
      right:3px;
      font-size:9px;
    }

    /* SIDEBAR */
    .sidebar{
      position:sticky;
      top:20px;
      display:flex;
      flex-direction:column;
      gap:20px;
    }

    .side-card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      padding:24px;
      box-shadow:0 10px 30px rgba(0,0,0,0.3);
    }

    .side-title{
      font-size:16px;
      font-weight:800;
      letter-spacing:0.5px;
      margin-bottom:18px;
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--text-dim);
      text-transform:uppercase;
    }

    .quick-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:20px;
    }

    .quick-grid .btn{
      height:38px;
      padding:0 12px;
      font-size:12px;
      justify-content:center;
    }

    /* PASSENGER LIST */
    .passenger-list{
      display:flex;
      flex-direction:column;
      gap:12px;
      max-height:calc(100vh - 420px);
      overflow-y:auto;
      padding-right:6px;
    }

    .passenger-list::-webkit-scrollbar{
      width:8px;
    }

    .passenger-list::-webkit-scrollbar-track{
      background:var(--elevated);
      border-radius:10px;
    }

    .passenger-list::-webkit-scrollbar-thumb{
      background:var(--primary);
      border-radius:10px;
    }

    .passenger-card{
      background:var(--elevated);
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
      display:grid;
      grid-template-columns:56px 1fr 130px;
      align-items:center;
      gap:14px;
      transition:all 0.2s;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
    }

    .passenger-card:hover{
      border-color:var(--primary);
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(167,139,250,0.3);
    }

    .passenger-num{
      font-size:24px;
      font-weight:900;
      text-align:center;
      background:linear-gradient(135deg, var(--primary-light), var(--accent));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }

    .passenger-input{
      width:100%;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      font-size:13px;
      font-weight:700;
      padding:6px 0;
    }

    .passenger-input::placeholder{
      color:var(--text-muted);
    }

    .passenger-select{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:8px;
      color:var(--text);
      font-weight:800;
      padding:10px 12px;
      font-size:12px;
      outline:none;
      cursor:pointer;
    }

    .passenger-card.status-livre{
      border-left:4px solid rgba(59,130,246,1);
      background:linear-gradient(90deg, rgba(59,130,246,0.08), transparent 50%);
    }

    .passenger-card.status-reservado{
      border-left:4px solid rgba(245,158,11,1);
      background:linear-gradient(90deg, rgba(245,158,11,0.08), transparent 50%);
    }

    .passenger-card.status-confirmado{
      border-left:4px solid rgba(16,185,129,1);
      background:linear-gradient(90deg, rgba(16,185,129,0.08), transparent 50%);
    }

    .passenger-card.status-bloqueado{
      border-left:4px solid rgba(239,68,68,1);
      background:linear-gradient(90deg, rgba(239,68,68,0.08), transparent 50%);
    }

    /* TOAST */
    .toast{
      position:fixed;
      bottom:28px;
      right:28px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:14px;
      padding:18px 24px;
      font-size:14px;
      font-weight:800;
      box-shadow:0 24px 60px rgba(0,0,0,0.8);
      transform:translateX(500px);
      opacity:0;
      transition:all 0.35s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index:9999;
      display:flex;
      align-items:center;
      gap:12px;
    }

    .toast.show{
      transform:translateX(0);
      opacity:1;
    }

    /* MODAL */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.85);
      backdrop-filter:blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10000;
      padding:20px;
    }

    .modal{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:20px;
      padding:0;
      max-width:600px;
      width:100%;
      box-shadow:0 40px 100px rgba(0,0,0,0.9);
      animation:modalIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes modalIn{
      from{
        transform:scale(0.9);
        opacity:0;
      }
      to{
        transform:scale(1);
        opacity:1;
      }
    }

    .modal-header{
      padding:28px 32px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .modal-title{
      font-size:24px;
      font-weight:800;
      letter-spacing:0.5px;
    }

    .modal-close{
      width:36px;
      height:36px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--elevated);
      color:var(--text);
      font-size:18px;
      font-weight:700;
      cursor:pointer;
      transition:all 0.2s;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .modal-close:hover{
      background:var(--danger);
      border-color:var(--danger);
      color:#fff;
    }

    .modal-content{
      padding:28px 32px;
    }

    .export-options{
      display:grid;
      gap:14px;
    }

    .export-btn{
      background:var(--elevated);
      border:1px solid var(--border);
      border-radius:12px;
      padding:20px;
      display:flex;
      align-items:center;
      gap:18px;
      cursor:pointer;
      transition:all 0.2s;
      text-align:left;
    }

    .export-btn:hover{
      border-color:var(--primary);
      transform:translateY(-2px);
      box-shadow:0 8px 24px rgba(167,139,250,0.3);
    }

    .export-icon{
      font-size:36px;
      flex-shrink:0;
    }

    .export-info strong{
      display:block;
      font-size:16px;
      font-weight:800;
      color:var(--text);
      margin-bottom:4px;
    }

    .export-info small{
      display:block;
      font-size:13px;
      color:var(--text-muted);
      font-weight:600;
    }

    .preset-item{
      background:var(--elevated);
      border:1px solid var(--border);
      border-radius:10px;
      padding:14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      transition:all 0.2s;
    }

    .preset-item:hover{
      border-color:var(--primary);
    }

    .preset-info{
      flex:1;
    }

    .preset-info strong{
      display:block;
      font-size:14px;
      font-weight:800;
      color:var(--text);
      margin-bottom:4px;
    }

    .preset-info small{
      display:block;
      font-size:11px;
      color:var(--text-muted);
      font-weight:600;
    }

    .preset-actions{
      display:flex;
      gap:8px;
    }

    .preset-btn{
      width:36px;
      height:36px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--elevated);
      color:var(--text);
      font-size:14px;
      cursor:pointer;
      transition:all 0.2s;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .preset-btn:hover{
      transform:translateY(-2px);
    }

    .preset-btn.load{
      background:var(--primary);
      border-color:var(--primary);
      color:#fff;
    }

    .preset-btn.load:hover{
      background:var(--primary-light);
    }

    .preset-btn.delete{
      background:var(--danger);
      border-color:var(--danger);
      color:#fff;
    }

    /* RESPONSIVE */
    @media(max-width:1200px){
      .main-layout{
        grid-template-columns:1fr;
      }

      .sidebar{
        position:static;
      }

      .passenger-list{
        max-height:400px;
      }
    }

    @media(max-width:768px){
      body{
        padding:12px;
      }

      .header{
        padding:20px;
      }

      .header-title{
        font-size:32px;
      }

      .stats-bar{
        grid-template-columns:1fr;
        gap:12px;
      }

      .toolbar{
        width:100%;
      }

      .btn{
        flex:1;
        min-width:0;
        padding:0 12px;
      }

      .canvas{
        min-height:400px;
      }

      .passenger-card{
        grid-template-columns:48px 1fr 110px;
        gap:10px;
        padding:12px;
      }

      .modal{
        max-width:calc(100vw - 24px);
      }

      .modal-header{
        padding:20px;
      }

      .modal-content{
        padding:20px;
      }

      .export-btn{
        padding:16px;
      }

      .export-icon{
        font-size:28px;
      }
    }
  </style>
</head>

<body>
<div class="container">
  <!-- HEADER -->
  <header class="header">
    <div class="header-content">
      <h1 class="header-title">VAN</h1>
      <p class="header-subtitle">Nobreak Company ‚Ä¢ Gest√£o de Transporte</p>
    </div>
    <div class="header-badges">
      <div class="badge">üöê Transporte</div>
      <div class="badge">‚ö° Sistema Ativo</div>
    </div>
  </header>

  <!-- STATS -->
  <div class="stats-bar">
    <div class="stat-box">
      <div class="stat-label">Total de Assentos</div>
      <div class="stat-value" id="statTotal">0</div>
    </div>
    <div class="stat-box" style="background:linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.05));">
      <div class="stat-label">Assentos Livres</div>
      <div class="stat-value" id="statLivres" style="background:linear-gradient(135deg, #10b981, #059669); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;">0</div>
    </div>
    <div class="stat-box" style="background:linear-gradient(135deg, rgba(245,158,11,0.1), rgba(239,68,68,0.05));">
      <div class="stat-label">Assentos Ocupados</div>
      <div class="stat-value" id="statOcupados" style="background:linear-gradient(135deg, #f59e0b, #ef4444); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;">0</div>
    </div>
  </div>

  <!-- MAIN LAYOUT -->
  <div class="main-layout">
    <!-- CANVAS -->
    <section class="canvas-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">üé®</span>
          Editor de Layout
        </h2>
        <div class="toolbar">
          <button class="btn btn-primary" onclick="addSeat()">
            <span>‚ûï</span> Adicionar Assento
          </button>
          <button class="btn" onclick="toggleSnap()" id="btnSnap">
            <span>üß≤</span> Snap: ON
          </button>
          <button class="btn" onclick="toggleVan()" id="btnVan">
            <span>üñºÔ∏è</span> Van: 30%
          </button>
          <button class="btn" onclick="toggleLock()" id="btnLock">
            <span>üîì</span> Destravado
          </button>
          <button class="btn" onclick="managePresets()">
            <span>‚≠ê</span> Presets
          </button>
          <button class="btn btn-danger" onclick="clearAll()">
            <span>üóëÔ∏è</span> Limpar
          </button>
          <button class="btn btn-success" onclick="saveLayout()">
            <span>üíæ</span> Salvar Layout
          </button>
          <button class="btn" style="background:#a78bfa; border:none; color:#fff" onclick="exportLayout()">
            <span>üì•</span> Exportar
          </button>
          <button class="btn btn-whatsapp" onclick="shareWhatsApp()">
            <span>üì±</span> WhatsApp
          </button>
        </div>
      </div>

      <div class="canvas" id="canvas">
        <img src="assets/images/van.png" alt="Van" class="canvas-bg" id="vanBg">
        <div class="canvas-hint" id="hint">
          Clique em <strong>Adicionar Assento</strong> para come√ßar<br>
          Arraste para posicionar ‚Ä¢ Duplo clique para renomear
        </div>
      </div>

      <div class="canvas-info">
        <div class="info-item">
          <span class="info-label">Assentos configurados:</span>
          <span class="info-value" id="canvasCount">0</span>
        </div>
        <div class="info-item">
          <span class="info-label">Clique direito para travar/destravar</span>
        </div>
      </div>
    </section>

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="side-card">
        <h3 class="side-title">‚ö° A√ß√µes R√°pidas</h3>
        <div class="quick-grid">
          <button class="btn" onclick="setAll('livre')">üü¢ Livre</button>
          <button class="btn" onclick="setAll('reservado')">üü† Reservado</button>
          <button class="btn" onclick="setAll('confirmado')">‚úÖ Confirmado</button>
          <button class="btn" onclick="setAll('bloqueado')">‚õî Bloqueado</button>
        </div>
      </div>

      <div class="side-card">
        <h3 class="side-title">üë• Passageiros</h3>
        <div class="passenger-list" id="passengerList"></div>
      </div>
    </aside>
  </div>
</div>

<!-- TOAST -->
<div id="toast" class="toast">
  <span id="toastIcon">‚úÖ</span>
  <span id="toastMsg">Sucesso</span>
</div>

<!-- EXPORT MODAL -->
<div id="exportModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">üì• Exportar Layout</h3>
      <button class="modal-close" onclick="closeExportModal()">‚úï</button>
    </div>
    <div class="modal-content">
      <p style="margin-bottom:20px; color:var(--text-dim)">
        Escolha o formato de exporta√ß√£o do layout da van com os assentos e passageiros:
      </p>
      <div class="export-options">
        <button class="export-btn" onclick="exportAsPDF()">
          <span class="export-icon">üìÑ</span>
          <div class="export-info">
            <strong>PDF Completo (Horizontal)</strong>
            <small>Layout visual + lista de passageiros (Imagem: 1920x1080px)</small>
          </div>
        </button>
        <button class="export-btn" onclick="exportAsImage()">
          <span class="export-icon">üñºÔ∏è</span>
          <div class="export-info">
            <strong>Imagem PNG</strong>
            <small>Apenas o layout visual dos assentos</small>
          </div>
        </button>
        <button class="export-btn" onclick="exportAsExcel()">
          <span class="export-icon">üìä</span>
          <div class="export-info">
            <strong>Planilha Excel</strong>
            <small>Lista completa de passageiros</small>
          </div>
        </button>
        <button class="export-btn" onclick="exportAsJSON()">
          <span class="export-icon">üíæ</span>
          <div class="export-info">
            <strong>Backup JSON</strong>
            <small>Arquivo de backup completo</small>
          </div>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- PRESETS MODAL -->
<div id="presetsModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">‚≠ê Gerenciar Presets</h3>
      <button class="modal-close" onclick="closePresetsModal()">‚úï</button>
    </div>
    <div class="modal-content">
      <p style="margin-bottom:20px; color:var(--text-dim)">
        Salve layouts como presets para reutilizar rapidamente:
      </p>
      
      <div style="margin-bottom:24px">
        <label style="display:block; font-size:13px; font-weight:700; color:var(--text-dim); margin-bottom:8px">
          SALVAR PRESET ATUAL
        </label>
        <div style="display:flex; gap:10px">
          <input 
            type="text" 
            id="presetName" 
            placeholder="Nome do preset (ex: Van 15 lugares)"
            style="flex:1; background:var(--elevated); border:1px solid var(--border); border-radius:8px; padding:12px; color:var(--text); font-size:13px; font-weight:600"
          />
          <button class="btn btn-primary" onclick="savePreset()">
            <span>üíæ</span> Salvar
          </button>
        </div>
      </div>

      <label style="display:block; font-size:13px; font-weight:700; color:var(--text-dim); margin-bottom:12px">
        PRESETS SALVOS
      </label>
      <div id="presetsList" style="display:flex; flex-direction:column; gap:10px; max-height:300px; overflow-y:auto">
        <p style="color:var(--text-muted); font-size:13px; text-align:center; padding:20px">
          Nenhum preset salvo ainda
        </p>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
const GRID = 2;
let snap = true;
let vanOpacity = 0.3;
let locked = false;
let counter = 1;
let seats = [];

function toast(msg, icon = '‚úÖ'){
  const t = document.getElementById('toast');
  document.getElementById('toastIcon').textContent = icon;
  document.getElementById('toastMsg').textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2400);
}

function toggleSnap(){
  snap = !snap;
  document.getElementById('btnSnap').innerHTML = 
    `<span>üß≤</span> Snap: ${snap ? 'ON' : 'OFF'}`;
  toast(snap ? 'Snap ativado' : 'Snap desativado', 'üß≤');
}

function toggleVan(){
  const img = document.getElementById('vanBg');
  vanOpacity = vanOpacity === 0.3 ? 0.15 : vanOpacity === 0.15 ? 0.5 : 0.7;
  img.style.opacity = vanOpacity;
  document.getElementById('btnVan').innerHTML = 
    `<span>üñºÔ∏è</span> Van: ${Math.round(vanOpacity * 100)}%`;
  toast(`Opacidade: ${Math.round(vanOpacity * 100)}%`, 'üñºÔ∏è');
}

function toggleLock(){
  locked = !locked;
  document.getElementById('btnLock').innerHTML = 
    locked ? '<span>üîí</span> Travado' : '<span>üîì</span> Destravado';
  toast(locked ? 'Editor travado' : 'Editor destravado', locked ? 'üîí' : 'üîì');
}

function addSeat(){
  const canvas = document.getElementById('canvas');
  const hint = document.getElementById('hint');
  if(hint) hint.style.display = 'none';

  const seat = document.createElement('div');
  seat.className = 'seat status-livre';
  seat.id = `seat-${counter}`;
  seat.innerHTML = `
    <div class="seat-num">#${counter}</div>
    <div class="seat-tag">ASSENTO</div>
    <div class="seat-delete" onclick="removeSeat('${seat.id}')">‚úï</div>
  `;

  const rect = canvas.getBoundingClientRect();
  const x = (rect.width / 2) - 22;
  const y = (rect.height / 2) - 24;

  seat.style.left = x + 'px';
  seat.style.top = y + 'px';

  canvas.appendChild(seat);
  makeDraggable(seat);

  seats.push({
    id: seat.id,
    number: counter,
    x: x,
    y: y,
    status: 'livre',
    name: '',
    locked: false
  });

  counter++;
  updateAll();
  toast(`Assento #${counter - 1} criado`, '‚ûï');
}

function removeSeat(id){
  if(locked){
    toast('Editor travado', 'üîí');
    return;
  }

  const seat = document.getElementById(id);
  if(seat){
    seat.remove();
    seats = seats.filter(s => s.id !== id);
    updateAll();
    toast('Assento removido', 'üóëÔ∏è');

    if(seats.length === 0){
      document.getElementById('hint').style.display = 'block';
    }
  }
}

function clearAll(){
  if(!confirm('Limpar todos os assentos?')) return;

  document.querySelectorAll('.seat').forEach(s => s.remove());
  seats = [];
  counter = 1;
  updateAll();
  document.getElementById('hint').style.display = 'block';
  toast('Layout limpo', 'üóëÔ∏è');
}

function saveLayout(){
  if(seats.length === 0){
    toast('Nenhum assento para salvar', '‚ö†Ô∏è');
    return;
  }

  const data = {
    seats,
    config: { snap, vanOpacity, locked },
    timestamp: new Date().toISOString()
  };

  localStorage.setItem('vanLayoutNobreak', JSON.stringify(data));
  toast('Layout salvo com sucesso!', 'üíæ');
}

function loadLayout(){
  const saved = localStorage.getItem('vanLayoutNobreak');
  if(!saved) return;

  try{
    const data = JSON.parse(saved);
    const canvas = document.getElementById('canvas');

    document.querySelectorAll('.seat').forEach(s => s.remove());

    if(data.config){
      snap = data.config.snap ?? true;
      vanOpacity = data.config.vanOpacity ?? 0.3;
      locked = data.config.locked ?? false;

      document.getElementById('vanBg').style.opacity = vanOpacity;
      document.getElementById('btnSnap').innerHTML = 
        `<span>üß≤</span> Snap: ${snap ? 'ON' : 'OFF'}`;
      document.getElementById('btnVan').innerHTML = 
        `<span>üñºÔ∏è</span> Van: ${Math.round(vanOpacity * 100)}%`;
      document.getElementById('btnLock').innerHTML = 
        locked ? '<span>üîí</span> Travado' : '<span>üîì</span> Destravado';
    }

    data.seats.forEach(sd => {
      const seat = document.createElement('div');
      seat.className = `seat status-${sd.status}`;
      seat.id = sd.id;
      seat.innerHTML = `
        <div class="seat-num">#${sd.number}</div>
        <div class="seat-tag">ASSENTO</div>
        <div class="seat-delete" onclick="removeSeat('${sd.id}')">‚úï</div>
      `;

      seat.style.left = sd.x + 'px';
      seat.style.top = sd.y + 'px';

      if(sd.locked) seat.classList.add('locked');

      canvas.appendChild(seat);
      makeDraggable(seat);
    });

    seats = data.seats;
    counter = Math.max(...seats.map(s => s.number), 0) + 1;

    if(seats.length > 0){
      document.getElementById('hint').style.display = 'none';
    }

    updateAll();
    toast('Layout carregado', '‚úÖ');
  }catch(e){
    console.error('Erro ao carregar layout:', e);
    toast('Erro ao carregar layout', '‚ùå');
  }
}

function makeDraggable(el){
  let dragging = false;
  let offsetX, offsetY;

  el.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    const sd = seats.find(s => s.id === el.id);
    if(sd){
      sd.locked = !sd.locked;
      el.classList.toggle('locked', sd.locked);
      toast(sd.locked ? `#${sd.number} travado` : `#${sd.number} destravado`, sd.locked ? 'üîí' : 'üîì');
    }
  });

  el.addEventListener('pointerdown', (e) => {
    if(e.target.classList.contains('seat-delete')) return;
    if(locked) return;

    dragging = true;
    const rect = el.getBoundingClientRect();
    const canvasRect = document.getElementById('canvas').getBoundingClientRect();

    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;

    el.classList.add('dragging');
    el.setPointerCapture(e.pointerId);
  });

  document.addEventListener('pointermove', (e) => {
    if(!dragging) return;

    const canvas = document.getElementById('canvas');
    const rect = canvas.getBoundingClientRect();

    let x = e.clientX - rect.left - offsetX;
    let y = e.clientY - rect.top - offsetY;

    x = Math.max(0, Math.min(x, rect.width - el.offsetWidth));
    y = Math.max(0, Math.min(y, rect.height - el.offsetHeight));

    if(snap){
      x = Math.round((x + el.offsetWidth/2) / GRID) * GRID - el.offsetWidth/2;
      y = Math.round((y + el.offsetHeight/2) / GRID) * GRID - el.offsetHeight/2;
      x = Math.max(0, Math.min(x, rect.width - el.offsetWidth));
      y = Math.max(0, Math.min(y, rect.height - el.offsetHeight));
    }

    el.style.left = x + 'px';
    el.style.top = y + 'px';
  });

  document.addEventListener('pointerup', (e) => {
    if(!dragging) return;

    dragging = false;
    el.classList.remove('dragging');

    const sd = seats.find(s => s.id === el.id);
    if(sd){
      sd.x = parseFloat(el.style.left);
      sd.y = parseFloat(el.style.top);
    }
  });

  el.addEventListener('dblclick', () => {
    if(locked) return;

    const sd = seats.find(s => s.id === el.id);
    if(!sd) return;

    const num = prompt('Novo n√∫mero:', sd.number);
    if(!num) return;

    sd.number = parseInt(num);
    el.querySelector('.seat-num').textContent = '#' + num;

    renderList();
    toast(`Renomeado para #${num}`, '‚úèÔ∏è');
  });
}

function updateAll(){
  const total = seats.length;
  const livre = seats.filter(s => s.status === 'livre').length;
  const reservado = seats.filter(s => s.status === 'reservado').length;
  const confirmado = seats.filter(s => s.status === 'confirmado').length;
  const bloqueado = seats.filter(s => s.status === 'bloqueado').length;
  const ocupados = reservado + confirmado + bloqueado;

  const totalEl = document.getElementById('statTotal');
  const livresEl = document.getElementById('statLivres');
  const ocupadosEl = document.getElementById('statOcupados');
  const countEl = document.getElementById('canvasCount');

  if(totalEl) totalEl.textContent = total;
  if(livresEl) livresEl.textContent = livre;
  if(ocupadosEl) ocupadosEl.textContent = ocupados;
  if(countEl) countEl.textContent = total;

  renderList();
}

function renderList(){
  const list = document.getElementById('passengerList');
  list.innerHTML = '';

  seats
    .sort((a, b) => a.number - b.number)
    .forEach(s => {
      const card = document.createElement('div');
      card.className = `passenger-card status-${s.status}`;
      card.innerHTML = `
        <div class="passenger-num">#${s.number}</div>
        <input 
          type="text" 
          class="passenger-input"
          placeholder="Nome do passageiro"
          value="${s.name || ''}"
          onchange="updateName('${s.id}', this.value)"
        />
        <select class="passenger-select" onchange="updateStatus('${s.id}', this.value)">
          <option value="livre" ${s.status === 'livre' ? 'selected' : ''}>üü¢ Livre</option>
          <option value="reservado" ${s.status === 'reservado' ? 'selected' : ''}>üü† Reservado</option>
          <option value="confirmado" ${s.status === 'confirmado' ? 'selected' : ''}>‚úÖ Confirmado</option>
          <option value="bloqueado" ${s.status === 'bloqueado' ? 'selected' : ''}>‚õî Bloqueado</option>
        </select>
      `;
      list.appendChild(card);
    });
}

function updateName(id, name){
  const s = seats.find(x => x.id === id);
  if(s){
    s.name = name;
    toast('Nome atualizado', 'üë§');
  }
}

function updateStatus(id, status){
  const s = seats.find(x => x.id === id);
  const el = document.getElementById(id);

  if(s && el){
    s.status = status;
    el.className = `seat status-${status}`;
    if(s.locked) el.classList.add('locked');

    updateAll();
    toast(`#${s.number} ‚Üí ${status}`, 'üé´');
  }
}

function setAll(status){
  seats.forEach(s => {
    s.status = status;
    const el = document.getElementById(s.id);
    if(el){
      el.className = `seat status-${status}`;
      if(s.locked) el.classList.add('locked');
    }
  });

  updateAll();
  toast(`Todos os assentos ‚Üí ${status}`, '‚ö°');
}

// EXPORT FUNCTIONS
function exportLayout(){
  if(seats.length === 0){
    toast('Nenhum assento para exportar', '‚ö†Ô∏è');
    return;
  }
  document.getElementById('exportModal').style.display = 'flex';
}

function closeExportModal(){
  document.getElementById('exportModal').style.display = 'none';
}

async function exportAsPDF(){
  closeExportModal();
  toast('Gerando PDF HORIZONTAL em 1920x1080...', '‚è≥');

  try{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape', 'mm', 'a4'); // ‚Üê LANDSCAPE MODE

    // Header - AJUSTADO PARA LANDSCAPE (297mm wide x 210mm tall)
    doc.setFillColor(20, 24, 37);
    doc.rect(0, 0, 297, 35, 'F');
    
    doc.setTextColor(167, 139, 250);
    doc.setFontSize(24);
    doc.setFont('helvetica', 'bold');
    doc.text('VAN NOBREAK', 148.5, 16, { align: 'center' });
    
    doc.setTextColor(148, 163, 184);
    doc.setFontSize(9);
    doc.text('Layout de Assentos', 148.5, 23, { align: 'center' });
    doc.text(new Date().toLocaleDateString('pt-BR', { 
      day: '2-digit', 
      month: 'long', 
      year: 'numeric' 
    }), 148.5, 29, { align: 'center' });

    // Stats - AJUSTADO PARA LANDSCAPE
    const total = seats.length;
    const livre = seats.filter(s => s.status === 'livre').length;
    const reservado = seats.filter(s => s.status === 'reservado').length;
    const confirmado = seats.filter(s => s.status === 'confirmado').length;
    const bloqueado = seats.filter(s => s.status === 'bloqueado').length;
    const ocupados = reservado + confirmado + bloqueado;

    doc.setFillColor(26, 31, 46);
    doc.roundedRect(15, 40, 267, 12, 3, 3, 'F');
    
    doc.setTextColor(241, 245, 249);
    doc.setFontSize(8);
    doc.setFont('helvetica', 'bold');
    doc.text(`TOTAL: ${total}`, 50, 48);
    doc.setTextColor(16, 185, 129);
    doc.text(`LIVRES: ${livre}`, 135, 48);
    doc.setTextColor(245, 158, 11);
    doc.text(`OCUPADOS: ${ocupados}`, 220, 48);

    // Screenshot - 1920x1080 PIXELS
    const canvas = document.getElementById('canvas');
    const hint = document.getElementById('hint');
    const hintWasVisible = hint && hint.style.display !== 'none';
    if(hint) hint.style.display = 'none';
    
    const TARGET_WIDTH = 1920;
    const TARGET_HEIGHT = 1080;
    
    const canvasElement = document.getElementById('canvas');
    const currentWidth = canvasElement.offsetWidth;
    const currentHeight = canvasElement.offsetHeight;
    
    const scaleX = TARGET_WIDTH / currentWidth;
    const scaleY = TARGET_HEIGHT / currentHeight;
    const scale = Math.min(scaleX, scaleY);
    
    console.log(`Capturando canvas LANDSCAPE em ${TARGET_WIDTH}x${TARGET_HEIGHT} (scale: ${scale.toFixed(2)})`);
    
    const screenshot = await html2canvas(canvas, {
      backgroundColor: '#1a1f2e',
      scale: scale,
      width: currentWidth,
      height: currentHeight,
      useCORS: true,
      allowTaint: true,
      logging: false
    });
    
    if(hint && hintWasVisible) hint.style.display = 'block';
    
    console.log(`Screenshot gerado: ${screenshot.width}x${screenshot.height} pixels`);
    
    const imgData = screenshot.toDataURL('image/png');
    
    // LANDSCAPE: 297mm wide, 210mm tall
    const pageWidth = 297;
    const pageHeight = 210;
    const headerHeight = 57;
    const sideMargin = 10;
    const topMargin = 5;
    const bottomMargin = 15;
    
    // Fit image to landscape
    const availableWidth = pageWidth - (sideMargin * 2);
    const availableHeight = pageHeight - headerHeight - topMargin - bottomMargin;
    
    const REAL_RATIO = TARGET_WIDTH / TARGET_HEIGHT; // 16:9
    
    let pdfWidth, pdfHeight;
    
    if(REAL_RATIO > (availableWidth / availableHeight)){
      // Fit to width
      pdfWidth = availableWidth;
      pdfHeight = pdfWidth / REAL_RATIO;
    }else{
      // Fit to height
      pdfHeight = availableHeight;
      pdfWidth = pdfHeight * REAL_RATIO;
    }
    
    const xPos = (pageWidth - pdfWidth) / 2;
    const remainingSpace = availableHeight - pdfHeight;
    const yPos = headerHeight + topMargin + (remainingSpace / 2);
    
    console.log(`Inserindo imagem LANDSCAPE no PDF: ${pdfWidth}mm x ${pdfHeight}mm na posi√ß√£o (${xPos}, ${yPos})`);
    
    doc.addImage(imgData, 'PNG', xPos, yPos, pdfWidth, pdfHeight);

    // Passenger list - NEW PAGE (back to portrait)
    doc.addPage('portrait');
    
    let y = 20;
    
    doc.setTextColor(167, 139, 250);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('Lista de Passageiros', 105, y, { align: 'center' });
    
    y += 12;

    const sortedSeats = [...seats].sort((a, b) => a.number - b.number);

    // Table header
    doc.setFillColor(26, 31, 46);
    doc.rect(15, y - 5, 180, 8, 'F');
    
    doc.setTextColor(148, 163, 184);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(9);
    doc.text('ASSENTO', 25, y);
    doc.text('PASSAGEIRO', 55, y);
    doc.text('STATUS', 160, y);
    
    y += 10;

    sortedSeats.forEach((s, idx) => {
      if(y > 275){
        doc.addPage();
        y = 20;
        
        doc.setFillColor(26, 31, 46);
        doc.rect(15, y - 5, 180, 8, 'F');
        doc.setTextColor(148, 163, 184);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.text('ASSENTO', 25, y);
        doc.text('PASSAGEIRO', 55, y);
        doc.text('STATUS', 160, y);
        y += 10;
      }

      if(idx % 2 === 0){
        doc.setFillColor(22, 27, 40);
        doc.rect(15, y - 6, 180, 9, 'F');
      }

      const statusColors = {
        livre: [59, 130, 246],
        reservado: [245, 158, 11],
        confirmado: [16, 185, 129],
        bloqueado: [239, 68, 68]
      };

      const color = statusColors[s.status] || [148, 163, 184];
      
      doc.setFillColor(...color);
      doc.circle(20, y - 2, 2, 'F');

      doc.setTextColor(241, 245, 249);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      doc.text(`#${s.number}`, 27, y);

      doc.setFont('helvetica', 'normal');
      doc.setTextColor(200, 210, 225);
      const name = s.name || '‚Äî';
      doc.text(name.substring(0, 35), 55, y);

      doc.setTextColor(...color);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(9);
      const statusText = {
        livre: 'LIVRE',
        reservado: 'RESERVADO',
        confirmado: 'CONFIRMADO',
        bloqueado: 'BLOQUEADO'
      }[s.status];
      doc.text(statusText, 160, y);

      y += 9;
    });

    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    for(let i = 1; i <= pageCount; i++){
      doc.setPage(i);
      doc.setFontSize(7);
      doc.setTextColor(100, 116, 139);
      
      // Different footer for landscape page
      if(i === 1){
        doc.text(
          `Sistema Van Nobreak ‚Ä¢ Gerado em ${new Date().toLocaleString('pt-BR')} ‚Ä¢ Imagem: 1920x1080px HORIZONTAL`, 
          148.5, 
          205, 
          { align: 'center' }
        );
      }else{
        doc.text(
          `Sistema Van Nobreak ‚Ä¢ Gerado em ${new Date().toLocaleString('pt-BR')}`, 
          105, 
          287, 
          { align: 'center' }
        );
        doc.text(`P√°gina ${i} de ${pageCount}`, 105, 292, { align: 'center' });
      }
    }

    doc.save(`van-layout-horizontal-${Date.now()}.pdf`);
    toast('PDF HORIZONTAL exportado!', 'üìÑ');
  }catch(e){
    console.error('Erro no PDF:', e);
    toast('Erro ao gerar PDF', '‚ùå');
  }
}

async function exportAsImage(){
  closeExportModal();
  toast('Gerando imagem...', '‚è≥');

  try{
    const canvas = document.getElementById('canvas');
    const canvasData = await html2canvas(canvas, {
      backgroundColor: '#1a1f2e',
      scale: 3
    });

    canvasData.toBlob((blob) => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `van-layout-${Date.now()}.png`;
      a.click();
      URL.revokeObjectURL(url);
      toast('Imagem exportada com sucesso!', 'üñºÔ∏è');
    });
  }catch(e){
    console.error(e);
    toast('Erro ao gerar imagem', '‚ùå');
  }
}

function exportAsExcel(){
  closeExportModal();
  toast('Gerando planilha...', '‚è≥');

  try{
    const sortedSeats = seats.sort((a, b) => a.number - b.number);

    const data = sortedSeats.map(s => ({
      'Assento': `#${s.number}`,
      'Passageiro': s.name || 'Sem passageiro',
      'Status': {
        livre: 'Livre',
        reservado: 'Reservado',
        confirmado: 'Confirmado',
        bloqueado: 'Bloqueado'
      }[s.status],
      'Travado': s.locked ? 'Sim' : 'N√£o'
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    ws['!cols'] = [
      { wch: 10 },
      { wch: 25 },
      { wch: 15 },
      { wch: 10 }
    ];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Passageiros');

    const summary = [
      ['RESUMO DO LAYOUT'],
      [''],
      ['Total de Assentos', seats.length],
      ['Assentos Livres', seats.filter(s => s.status === 'livre').length],
      ['Assentos Reservados', seats.filter(s => s.status === 'reservado').length],
      ['Assentos Confirmados', seats.filter(s => s.status === 'confirmado').length],
      ['Assentos Bloqueados', seats.filter(s => s.status === 'bloqueado').length],
      [''],
      ['Gerado em', new Date().toLocaleString('pt-BR')]
    ];

    const wsSummary = XLSX.utils.aoa_to_sheet(summary);
    wsSummary['!cols'] = [{ wch: 25 }, { wch: 15 }];
    XLSX.utils.book_append_sheet(wb, wsSummary, 'Resumo');

    XLSX.writeFile(wb, `van-passageiros-${Date.now()}.xlsx`);
    toast('Planilha exportada com sucesso!', 'üìä');
  }catch(e){
    console.error(e);
    toast('Erro ao gerar planilha', '‚ùå');
  }
}

function exportAsJSON(){
  closeExportModal();
  toast('Gerando backup...', '‚è≥');

  try{
    const backup = {
      metadata: {
        exportDate: new Date().toISOString(),
        totalSeats: seats.length,
        version: '1.0'
      },
      config: {
        snap,
        vanOpacity,
        locked
      },
      seats: seats.map(s => ({
        id: s.id,
        number: s.number,
        x: s.x,
        y: s.y,
        status: s.status,
        name: s.name,
        locked: s.locked
      }))
    };

    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `van-backup-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);

    toast('Backup exportado com sucesso!', 'üíæ');
  }catch(e){
    console.error(e);
    toast('Erro ao gerar backup', '‚ùå');
  }
}

// PRESET FUNCTIONS
function managePresets(){
  document.getElementById('presetsModal').style.display = 'flex';
  loadPresetsList();
}

function closePresetsModal(){
  document.getElementById('presetsModal').style.display = 'none';
  document.getElementById('presetName').value = '';
}

function savePreset(){
  if(seats.length === 0){
    toast('Adicione assentos antes de salvar preset', '‚ö†Ô∏è');
    return;
  }

  const name = document.getElementById('presetName').value.trim();
  if(!name){
    toast('Digite um nome para o preset', '‚ö†Ô∏è');
    return;
  }

  const presets = JSON.parse(localStorage.getItem('vanPresets') || '[]');

  const preset = {
    id: Date.now(),
    name: name,
    seats: seats.map(s => ({...s})),
    config: { snap, vanOpacity, locked },
    createdAt: new Date().toISOString(),
    totalSeats: seats.length
  };

  presets.push(preset);
  localStorage.setItem('vanPresets', JSON.stringify(presets));

  document.getElementById('presetName').value = '';
  loadPresetsList();
  toast(`Preset "${name}" salvo!`, '‚≠ê');
}

function loadPresetsList(){
  const presets = JSON.parse(localStorage.getItem('vanPresets') || '[]');
  const list = document.getElementById('presetsList');

  if(presets.length === 0){
    list.innerHTML = `
      <p style="color:var(--text-muted); font-size:13px; text-align:center; padding:20px">
        Nenhum preset salvo ainda
      </p>
    `;
    return;
  }

  list.innerHTML = presets.map(p => `
    <div class="preset-item">
      <div class="preset-info">
        <strong>${p.name}</strong>
        <small>${p.totalSeats} assentos ‚Ä¢ ${new Date(p.createdAt).toLocaleDateString('pt-BR')}</small>
      </div>
      <div class="preset-actions">
        <button class="preset-btn load" onclick="loadPreset(${p.id})" title="Carregar">
          üìÇ
        </button>
        <button class="preset-btn delete" onclick="deletePreset(${p.id})" title="Excluir">
          üóëÔ∏è
        </button>
      </div>
    </div>
  `).join('');
}

function loadPreset(id){
  const presets = JSON.parse(localStorage.getItem('vanPresets') || '[]');
  const preset = presets.find(p => p.id === id);

  if(!preset){
    toast('Preset n√£o encontrado', '‚ùå');
    return;
  }

  if(!confirm(`Carregar preset "${preset.name}"? O layout atual ser√° substitu√≠do.`)){
    return;
  }

  document.querySelectorAll('.seat').forEach(s => s.remove());

  snap = preset.config.snap ?? true;
  vanOpacity = preset.config.vanOpacity ?? 0.3;
  locked = preset.config.locked ?? false;

  document.getElementById('vanBg').style.opacity = vanOpacity;
  document.getElementById('btnSnap').innerHTML = 
    `<span>üß≤</span> Snap: ${snap ? 'ON' : 'OFF'}`;
  document.getElementById('btnVan').innerHTML = 
    `<span>üñºÔ∏è</span> Van: ${Math.round(vanOpacity * 100)}%`;
  document.getElementById('btnLock').innerHTML = 
    locked ? '<span>üîí</span> Travado' : '<span>üîì</span> Destravado';

  const canvas = document.getElementById('canvas');
  preset.seats.forEach(sd => {
    const seat = document.createElement('div');
    seat.className = `seat status-${sd.status}`;
    seat.id = sd.id;
    seat.innerHTML = `
      <div class="seat-num">#${sd.number}</div>
      <div class="seat-tag">ASSENTO</div>
      <div class="seat-delete" onclick="removeSeat('${sd.id}')">‚úï</div>
    `;

    seat.style.left = sd.x + 'px';
    seat.style.top = sd.y + 'px';

    if(sd.locked) seat.classList.add('locked');

    canvas.appendChild(seat);
    makeDraggable(seat);
  });

  seats = preset.seats.map(s => ({...s}));
  counter = Math.max(...seats.map(s => s.number), 0) + 1;

  document.getElementById('hint').style.display = 'none';

  updateAll();
  closePresetsModal();
  toast(`Preset "${preset.name}" carregado!`, '‚≠ê');
}

function deletePreset(id){
  const presets = JSON.parse(localStorage.getItem('vanPresets') || '[]');
  const preset = presets.find(p => p.id === id);

  if(!preset){
    toast('Preset n√£o encontrado', '‚ùå');
    return;
  }

  if(!confirm(`Excluir preset "${preset.name}"?`)){
    return;
  }

  const filtered = presets.filter(p => p.id !== id);
  localStorage.setItem('vanPresets', JSON.stringify(filtered));

  loadPresetsList();
  toast('Preset exclu√≠do', 'üóëÔ∏è');
}

async function shareWhatsApp(){
  if(seats.length === 0){
    toast('Nenhum assento para compartilhar', '‚ö†Ô∏è');
    return;
  }

  toast('Gerando PDF HORIZONTAL para WhatsApp...', '‚è≥');

  try{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape', 'mm', 'a4');

    // Same as exportAsPDF - shortened for WhatsApp
    doc.setFillColor(20, 24, 37);
    doc.rect(0, 0, 297, 35, 'F');
    
    doc.setTextColor(167, 139, 250);
    doc.setFontSize(24);
    doc.setFont('helvetica', 'bold');
    doc.text('VAN NOBREAK', 148.5, 16, { align: 'center' });
    
    doc.setTextColor(148, 163, 184);
    doc.setFontSize(9);
    doc.text('Layout de Assentos', 148.5, 23, { align: 'center' });
    doc.text(new Date().toLocaleDateString('pt-BR', { 
      day: '2-digit', 
      month: 'long', 
      year: 'numeric' 
    }), 148.5, 29, { align: 'center' });

    const total = seats.length;
    const livre = seats.filter(s => s.status === 'livre').length;
    const reservado = seats.filter(s => s.status === 'reservado').length;
    const confirmado = seats.filter(s => s.status === 'confirmado').length;
    const bloqueado = seats.filter(s => s.status === 'bloqueado').length;
    const ocupados = reservado + confirmado + bloqueado;

    doc.setFillColor(26, 31, 46);
    doc.roundedRect(15, 40, 267, 12, 3, 3, 'F');
    
    doc.setTextColor(241, 245, 249);
    doc.setFontSize(8);
    doc.setFont('helvetica', 'bold');
    doc.text(`TOTAL: ${total}`, 50, 48);
    doc.setTextColor(16, 185, 129);
    doc.text(`LIVRES: ${livre}`, 135, 48);
    doc.setTextColor(245, 158, 11);
    doc.text(`OCUPADOS: ${ocupados}`, 220, 48);

    // Screenshot
    const canvas = document.getElementById('canvas');
    const hint = document.getElementById('hint');
    const hintWasVisible = hint && hint.style.display !== 'none';
    if(hint) hint.style.display = 'none';
    
    const TARGET_WIDTH = 1920;
    const TARGET_HEIGHT = 1080;
    
    const canvasElement = document.getElementById('canvas');
    const currentWidth = canvasElement.offsetWidth;
    const currentHeight = canvasElement.offsetHeight;
    
    const scaleX = TARGET_WIDTH / currentWidth;
    const scaleY = TARGET_HEIGHT / currentHeight;
    const scale = Math.min(scaleX, scaleY);
    
    const screenshot = await html2canvas(canvas, {
      backgroundColor: '#1a1f2e',
      scale: scale,
      width: currentWidth,
      height: currentHeight,
      useCORS: true,
      allowTaint: true,
      logging: false
    });
    
    if(hint && hintWasVisible) hint.style.display = 'block';
    
    const imgData = screenshot.toDataURL('image/png');
    
    const pageWidth = 297;
    const pageHeight = 210;
    const headerHeight = 57;
    const sideMargin = 10;
    const topMargin = 5;
    const bottomMargin = 15;
    
    const availableWidth = pageWidth - (sideMargin * 2);
    const availableHeight = pageHeight - headerHeight - topMargin - bottomMargin;
    
    const REAL_RATIO = TARGET_WIDTH / TARGET_HEIGHT;
    
    let pdfWidth, pdfHeight;
    
    if(REAL_RATIO > (availableWidth / availableHeight)){
      pdfWidth = availableWidth;
      pdfHeight = pdfWidth / REAL_RATIO;
    }else{
      pdfHeight = availableHeight;
      pdfWidth = pdfHeight * REAL_RATIO;
    }
    
    const xPos = (pageWidth - pdfWidth) / 2;
    const remainingSpace = availableHeight - pdfHeight;
    const yPos = headerHeight + topMargin + (remainingSpace / 2);
    
    doc.addImage(imgData, 'PNG', xPos, yPos, pdfWidth, pdfHeight);

    // Passenger list
    doc.addPage('portrait');
    let y = 20;
    
    doc.setTextColor(167, 139, 250);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('Lista de Passageiros', 105, y, { align: 'center' });
    y += 12;

    const sortedSeats = [...seats].sort((a, b) => a.number - b.number);

    doc.setFillColor(26, 31, 46);
    doc.rect(15, y - 5, 180, 8, 'F');
    doc.setTextColor(148, 163, 184);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(9);
    doc.text('ASSENTO', 25, y);
    doc.text('PASSAGEIRO', 55, y);
    doc.text('STATUS', 160, y);
    y += 10;

    sortedSeats.forEach((s, idx) => {
      if(y > 275){
        doc.addPage();
        y = 20;
        doc.setFillColor(26, 31, 46);
        doc.rect(15, y - 5, 180, 8, 'F');
        doc.setTextColor(148, 163, 184);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.text('ASSENTO', 25, y);
        doc.text('PASSAGEIRO', 55, y);
        doc.text('STATUS', 160, y);
        y += 10;
      }

      if(idx % 2 === 0){
        doc.setFillColor(22, 27, 40);
        doc.rect(15, y - 6, 180, 9, 'F');
      }

      const statusColors = {
        livre: [59, 130, 246],
        reservado: [245, 158, 11],
        confirmado: [16, 185, 129],
        bloqueado: [239, 68, 68]
      };

      const color = statusColors[s.status] || [148, 163, 184];
      doc.setFillColor(...color);
      doc.circle(20, y - 2, 2, 'F');

      doc.setTextColor(241, 245, 249);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      doc.text(`#${s.number}`, 27, y);

      doc.setFont('helvetica', 'normal');
      doc.setTextColor(200, 210, 225);
      const name = s.name || '‚Äî';
      doc.text(name.substring(0, 35), 55, y);

      doc.setTextColor(...color);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(9);
      const statusText = {
        livre: 'LIVRE',
        reservado: 'RESERVADO',
        confirmado: 'CONFIRMADO',
        bloqueado: 'BLOQUEADO'
      }[s.status];
      doc.text(statusText, 160, y);

      y += 9;
    });

    const pageCount = doc.internal.getNumberOfPages();
    for(let i = 1; i <= pageCount; i++){
      doc.setPage(i);
      doc.setFontSize(7);
      doc.setTextColor(100, 116, 139);
      
      if(i === 1){
        doc.text(
          `Sistema Van Nobreak ‚Ä¢ ${new Date().toLocaleString('pt-BR')} ‚Ä¢ 1920x1080px HORIZONTAL`, 
          148.5, 
          205, 
          { align: 'center' }
        );
      }else{
        doc.text(
          `Sistema Van Nobreak ‚Ä¢ ${new Date().toLocaleString('pt-BR')}`, 
          105, 
          287, 
          { align: 'center' }
        );
        doc.text(`P√°gina ${i} de ${pageCount}`, 105, 292, { align: 'center' });
      }
    }

    const pdfBlob = doc.output('blob');
    const file = new File([pdfBlob], `van-horizontal-${Date.now()}.pdf`, { type: 'application/pdf' });

    if(navigator.share && navigator.canShare && navigator.canShare({ files: [file] })){
      await navigator.share({
        title: 'Layout Van Nobreak (Horizontal)',
        text: `Layout da van com ${total} assentos (${livre} livres, ${ocupados} ocupados) - 1920x1080px HORIZONTAL`,
        files: [file]
      });
      toast('Compartilhado com sucesso!', '‚úÖ');
    }else{
      const url = URL.createObjectURL(pdfBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `van-horizontal-${Date.now()}.pdf`;
      a.click();
      URL.revokeObjectURL(url);
      
      setTimeout(() => {
        alert('PDF HORIZONTAL baixado! Abra o WhatsApp e envie o arquivo baixado.');
      }, 500);
      toast('PDF HORIZONTAL baixado!', 'üì±');
    }
  }catch(e){
    console.error('Erro no WhatsApp:', e);
    toast('Erro ao gerar PDF', '‚ùå');
  }
}

// Export functions to window
window.addSeat = addSeat;
window.removeSeat = removeSeat;
window.clearAll = clearAll;
window.saveLayout = saveLayout;
window.toggleSnap = toggleSnap;
window.toggleVan = toggleVan;
window.toggleLock = toggleLock;
window.setAll = setAll;
window.updateName = updateName;
window.updateStatus = updateStatus;
window.exportLayout = exportLayout;
window.closeExportModal = closeExportModal;
window.exportAsPDF = exportAsPDF;
window.exportAsImage = exportAsImage;
window.exportAsExcel = exportAsExcel;
window.exportAsJSON = exportAsJSON;
window.managePresets = managePresets;
window.closePresetsModal = closePresetsModal;
window.savePreset = savePreset;
window.loadPreset = loadPreset;
window.deletePreset = deletePreset;
window.shareWhatsApp = shareWhatsApp;

window.addEventListener('DOMContentLoaded', () => {
  loadLayout();
  updateAll();
});
</script>
</body>
</html>
