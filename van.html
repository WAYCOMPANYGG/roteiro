<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Van | Voltz</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="voltz.css">
  <style>
    /* Estilos espec√≠ficos da Van */
    .container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: rgba(30, 30, 46, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-content h1 {
      font-size: 36px;
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .header-subtitle {
      color: var(--text-tertiary);
      font-size: 14px;
    }

    .header-badges {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .badge {
      padding: 10px 20px;
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 12px;
      color: var(--success);
      font-size: 13px;
      font-weight: 600;
    }

    .btn-home {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      color: var(--text-primary);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-home:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .stat-box {
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .main-layout {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 25px;
    }

    .canvas-section {
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 25px;
    }

    .section-header {
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-icon {
      font-size: 24px;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: var(--font-family);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    .btn-primary {
      background: var(--gradient-primary);
      border: none;
    }

    .btn-success {
      background: var(--gradient-success);
      border: none;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border: none;
    }

    .btn-whatsapp {
      background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
      border: none;
    }

    .canvas {
      position: relative;
      width: 100%;
      height: 700px;
      background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      margin-bottom: 15px;
      overflow: hidden;
    }

    .canvas-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      opacity: 0.3;
      pointer-events: none;
      user-select: none;
    }

    .canvas-hint {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: var(--text-tertiary);
      font-size: 14px;
      pointer-events: none;
    }

    .seat {
      position: absolute;
      width: 44px;
      height: 48px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      cursor: move;
      transition: all 0.2s ease;
      user-select: none;
      touch-action: none;
    }

    .seat:hover {
      transform: scale(1.1);
      z-index: 10;
      box-shadow: 0 8px 24px rgba(236, 72, 153, 0.4);
    }

    .seat.dragging {
      z-index: 100;
      opacity: 0.8;
      transform: scale(1.15);
    }

    .seat.locked {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .seat-num {
      text-align: center;
      font-size: 14px;
      font-weight: 700;
      margin-top: 6px;
      color: var(--text-primary);
    }

    .seat-tag {
      text-align: center;
      font-size: 9px;
      font-weight: 600;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .seat-delete {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 20px;
      height: 20px;
      background: #ef4444;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      color: white;
    }

    .seat:hover .seat-delete {
      display: flex;
    }

    .status-livre {
      background: rgba(59, 130, 246, 0.2);
      border-color: #3b82f6;
    }

    .status-reservado {
      background: rgba(245, 158, 11, 0.2);
      border-color: #f59e0b;
    }

    .status-confirmado {
      background: rgba(16, 185, 129, 0.2);
      border-color: #10b981;
    }

    .status-bloqueado {
      background: rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
    }

    .canvas-info {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      font-size: 13px;
    }

    .info-label {
      color: var(--text-tertiary);
    }

    .info-value {
      color: var(--text-primary);
      font-weight: 600;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .side-card {
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 20px;
    }

    .side-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .quick-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .quick-grid .btn {
      justify-content: center;
    }

    .passenger-list {
      max-height: 600px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .passenger-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px;
    }

    .passenger-header {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      align-items: center;
    }

    .passenger-num {
      width: 36px;
      height: 36px;
      background: var(--gradient-primary);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 13px;
      flex-shrink: 0;
    }

    .passenger-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text-primary);
      font-size: 13px;
      font-family: var(--font-family);
    }

    .passenger-input:focus {
      outline: none;
      border-color: var(--primary-pink);
      background: rgba(255, 255, 255, 0.08);
    }

    .passenger-select {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text-primary);
      font-size: 12px;
      font-family: var(--font-family);
      cursor: pointer;
    }

    .passenger-docs {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .doc-row {
      display: flex;
      gap: 8px;
    }

    .doc-field {
      flex: 1;
    }

    .doc-label {
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 4px;
      display: block;
      font-weight: 600;
    }

    .doc-input {
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      padding: 6px 10px;
      color: var(--text-primary);
      font-size: 12px;
      font-family: var(--font-family);
    }

    .doc-input:focus {
      outline: none;
      border-color: var(--primary-pink);
    }

    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      font-weight: 500;
      z-index: 10000;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
      pointer-events: none;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: rgba(30, 30, 46, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 25px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .modal-content {
      padding: 25px;
      overflow-y: auto;
    }

    .export-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .export-btn {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 18px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: var(--font-family);
      color: var(--text-primary);
    }

    .export-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--primary-pink);
      transform: translateX(5px);
    }

    .export-icon {
      font-size: 32px;
    }

    .export-info {
      flex: 1;
      text-align: left;
    }

    .export-info strong {
      display: block;
      font-size: 15px;
      margin-bottom: 4px;
    }

    .export-info small {
      color: var(--text-tertiary);
      font-size: 12px;
    }

    .preset-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
    }

    .preset-info strong {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .preset-info small {
      color: var(--text-tertiary);
      font-size: 12px;
    }

    .preset-actions {
      display: flex;
      gap: 8px;
    }

    .preset-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .preset-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }

    .preset-btn.load {
      background: rgba(16, 185, 129, 0.2);
    }

    .preset-btn.delete {
      background: rgba(239, 68, 68, 0.2);
    }

    body.dragging-seat {
      position: fixed;
      width: 100%;
      overflow: hidden;
    }

    @media (max-width: 1200px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .toolbar {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .stats-bar {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- HEADER -->
    <header class="header">
      <div class="header-content">
        <h1 class="header-title">VAN</h1>
        <p class="header-subtitle">Voltz ‚Ä¢ Gest√£o de Transporte</p>
      </div>
      <div class="header-badges">
        <div class="badge">‚ö° Sistema Ativo</div>
        <a href="dashboard.html" class="btn-home">
          <span>üè†</span> Home
        </a>
      </div>
    </header>

    <!-- STATS -->
    <div class="stats-bar">
      <div class="stat-box">
        <div class="stat-label">Total de Assentos</div>
        <div class="stat-value" id="statTotal">0</div>
      </div>
      <div class="stat-box" style="background:linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.05));">
        <div class="stat-label">Assentos Livres</div>
        <div class="stat-value" id="statLivres" style="background:linear-gradient(135deg, #10b981, #059669); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;">0</div>
      </div>
      <div class="stat-box" style="background:linear-gradient(135deg, rgba(245,158,11,0.1), rgba(239,68,68,0.05));">
        <div class="stat-label">Assentos Ocupados</div>
        <div class="stat-value" id="statOcupados" style="background:linear-gradient(135deg, #f59e0b, #ef4444); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;">0</div>
      </div>
    </div>

    <!-- MAIN LAYOUT -->
    <div class="main-layout">
      <!-- CANVAS -->
      <section class="canvas-section">
        <div class="section-header">
          <h2 class="section-title">
            <span class="section-icon">üé®</span>
            Editor de Layout
          </h2>
          <div class="toolbar">
            <button class="btn btn-primary" onclick="addSeat()">
              <span>‚ûï</span> Adicionar Assento
            </button>
            <button class="btn" onclick="toggleSnap()" id="btnSnap">
              <span>üß≤</span> Snap: ON
            </button>
            <button class="btn" onclick="toggleVan()" id="btnVan">
              <span>üñºÔ∏è</span> Van: 30%
            </button>
            <button class="btn" onclick="toggleLock()" id="btnLock">
              <span>üîì</span> Destravado
            </button>
            <button class="btn" onclick="managePresets()">
              <span>‚≠ê</span> Presets
            </button>
            <button class="btn btn-danger" onclick="clearAll()">
              <span>üóëÔ∏è</span> Limpar
            </button>
            <button class="btn btn-success" onclick="saveLayout()">
              <span>üíæ</span> Salvar Layout
            </button>
            <button class="btn" style="background:#a78bfa; border:none; color:#fff" onclick="exportLayout()">
              <span>üì•</span> Exportar
            </button>
            <button class="btn btn-whatsapp" onclick="shareWhatsApp()">
              <span>üì±</span> WhatsApp
            </button>
          </div>
        </div>

        <div class="canvas" id="canvas">
          <img src="assets/images/van.png" alt="Van" class="canvas-bg" id="vanBg">
          <div class="canvas-hint" id="hint">
            Clique em <strong>Adicionar Assento</strong> para come√ßar<br>
            Arraste para posicionar ‚Ä¢ Duplo clique para renomear
          </div>
        </div>

        <div class="canvas-info">
          <div class="info-item">
            <span class="info-label">Assentos configurados:</span>
            <span class="info-value" id="canvasCount">0</span>
          </div>
          <div class="info-item">
            <span class="info-label">Clique direito para travar/destravar</span>
          </div>
        </div>
      </section>

      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="side-card">
          <h3 class="side-title">‚ö° A√ß√µes R√°pidas</h3>
          <div class="quick-grid">
            <button class="btn" onclick="setAll('livre')">üü¢ Livre</button>
            <button class="btn" onclick="setAll('reservado')">üü† Reservado</button>
            <button class="btn" onclick="setAll('confirmado')">‚úÖ Confirmado</button>
            <button class="btn" onclick="setAll('bloqueado')">‚õî Bloqueado</button>
          </div>
        </div>

        <div class="side-card">
          <h3 class="side-title">üë• Passageiros</h3>
          <div class="passenger-list" id="passengerList"></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast">
    <span id="toastIcon">‚úÖ</span>
    <span id="toastMsg">Sucesso</span>
  </div>

  <!-- EXPORT MODAL -->
  <div id="exportModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üì• Exportar Layout</h3>
        <button class="modal-close" onclick="closeExportModal()">‚úï</button>
      </div>
      <div class="modal-content">
        <p style="margin-bottom:20px; color:var(--text-tertiary)">
          Escolha o formato de exporta√ß√£o do layout da van com os assentos e passageiros:
        </p>
        <div class="export-options">
          <button class="export-btn" onclick="exportAsPDF()">
            <span class="export-icon">üìÑ</span>
            <div class="export-info">
              <strong>PDF Completo (Otimizado)</strong>
              <small>Van vertical otimizada + lista de passageiros (1920x1080px)</small>
            </div>
          </button>
          <button class="export-btn" onclick="exportAsImage()">
            <span class="export-icon">üñºÔ∏è</span>
            <div class="export-info">
              <strong>Imagem PNG</strong>
              <small>Apenas o layout visual dos assentos</small>
            </div>
          </button>
          <button class="export-btn" onclick="exportAsExcel()">
            <span class="export-icon">üìä</span>
            <div class="export-info">
              <strong>Planilha Excel</strong>
              <small>Lista completa de passageiros</small>
            </div>
          </button>
          <button class="export-btn" onclick="exportAsJSON()">
            <span class="export-icon">üíæ</span>
            <div class="export-info">
              <strong>Backup JSON</strong>
              <small>Arquivo de backup completo</small>
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- PRESETS MODAL -->
  <div id="presetsModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">‚≠ê Gerenciar Presets</h3>
        <button class="modal-close" onclick="closePresetsModal()">‚úï</button>
      </div>
      <div class="modal-content">
        <p style="margin-bottom:20px; color:var(--text-tertiary)">
          Salve layouts como presets para reutilizar rapidamente:
        </p>

        <div style="margin-bottom:24px">
          <label style="display:block; font-size:13px; font-weight:700; color:var(--text-tertiary); margin-bottom:8px">
            SALVAR PRESET ATUAL
          </label>
          <div style="display:flex; gap:10px">
            <input
              type="text"
              id="presetName"
              placeholder="Nome do preset (ex: Van 15 lugares)"
              style="flex:1; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:8px; padding:12px; color:var(--text-primary); font-size:13px; font-weight:600; font-family:var(--font-family)"
            />
            <button class="btn btn-primary" onclick="savePreset()">
              <span>üíæ</span> Salvar
            </button>
          </div>
        </div>

        <label style="display:block; font-size:13px; font-weight:700; color:var(--text-tertiary); margin-bottom:12px">
          PRESETS SALVOS
        </label>
        <div id="presetsList" style="display:flex; flex-direction:column; gap:10px; max-height:300px; overflow-y:auto">
          <p style="color:var(--text-muted); font-size:13px; text-align:center; padding:20px">
            Nenhum preset salvo ainda
          </p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
  // TODO O JAVASCRIPT PERMANECE EXATAMENTE IGUAL - SEM ALTERA√á√ïES
  const GRID = 2;
  let snap = true;
  let vanOpacity = 0.3;
  let locked = false;
  let counter = 1;
  let seats = [];

  let __scrollY = 0;
  function lockBodyScroll(){
    __scrollY = window.scrollY || window.pageYOffset || 0;
    document.body.classList.add('dragging-seat');
    document.body.style.top = `-${__scrollY}px`;
  }
  function unlockBodyScroll(){
    document.body.classList.remove('dragging-seat');
    const top = document.body.style.top;
    document.body.style.top = '';
    const y = top ? parseInt(top.replace('-', '').replace('px','') || '0', 10) : __scrollY;
    window.scrollTo(0, y || 0);
  }

  function toast(msg, icon = '‚úÖ'){
    const t = document.getElementById('toast');
    document.getElementById('toastIcon').textContent = icon;
    document.getElementById('toastMsg').textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2400);
  }

  function toggleSnap(){
    snap = !snap;
    document.getElementById('btnSnap').innerHTML =
      `<span>üß≤</span> Snap: ${snap ? 'ON' : 'OFF'}`;
    toast(snap ? 'Snap ativado' : 'Snap desativado', 'üß≤');
  }

  function toggleVan(){
    const img = document.getElementById('vanBg');

    if(vanOpacity === 0.3){
      vanOpacity = 0.5;
    }else if(vanOpacity === 0.5){
      vanOpacity = 0.7;
    }else{
      vanOpacity = 0.3;
    }

    img.style.opacity = vanOpacity;
    document.getElementById('btnVan').innerHTML =
      `<span>üñºÔ∏è</span> Van: ${Math.round(vanOpacity * 100)}%`;
    toast(`Opacidade: ${Math.round(vanOpacity * 100)}%`, 'üñºÔ∏è');
  }

  function toggleLock(){
    locked = !locked;
    document.getElementById('btnLock').innerHTML =
      locked ? '<span>üîí</span> Travado' : '<span>üîì</span> Destravado';
    toast(locked ? 'Editor travado' : 'Editor destravado', locked ? 'üîí' : 'üîì');
  }

  function addSeat(){
    const canvas = document.getElementById('canvas');
    const hint = document.getElementById('hint');
    if(hint) hint.style.display = 'none';

    const seat = document.createElement('div');
    seat.className = 'seat status-livre';
    seat.id = `seat-${counter}`;
    seat.innerHTML = `
      <div class="seat-num">#${counter}</div>
      <div class="seat-tag">ASSENTO</div>
      <div class="seat-delete" onclick="removeSeat('${seat.id}')">‚úï</div>
    `;

    const rect = canvas.getBoundingClientRect();
    const x = (rect.width / 2) - 22;
    const y = (rect.height / 2) - 24;

    seat.style.left = x + 'px';
    seat.style.top = y + 'px';

    canvas.appendChild(seat);
    makeDraggable(seat);

    seats.push({
      id: seat.id,
      number: counter,
      x: x,
      y: y,
      status: 'livre',
      name: '',
      rg: '',
      cpf: '',
      nomeCompleto: '',
      dataNascimento: '',
      locked: false
    });

    counter++;
    updateAll();
    toast(`Assento #${counter - 1} criado`, '‚ûï');
  }

  function removeSeat(id){
    if(locked){
      toast('Editor travado', 'üîí');
      return;
    }

    const seat = document.getElementById(id);
    if(seat){
      seat.remove();
      seats = seats.filter(s => s.id !== id);
      updateAll();
      toast('Assento removido', 'üóëÔ∏è');

      if(seats.length === 0){
        document.getElementById('hint').style.display = 'block';
      }
    }
  }

  function clearAll(){
    if(!confirm('Limpar todos os assentos?')) return;

    document.querySelectorAll('.seat').forEach(s => s.remove());
    seats = [];
    counter = 1;
    updateAll();
    document.getElementById('hint').style.display = 'block';
    toast('Layout limpo', 'üóëÔ∏è');
  }

  function saveLayout(){
    if(seats.length === 0){
      toast('Nenhum assento para salvar', '‚ö†Ô∏è');
      return;
    }

    const data = {
      seats,
      config: { snap, vanOpacity, locked },
      timestamp: new Date().toISOString()
    };

    localStorage.setItem('vanLayoutNobreak', JSON.stringify(data));
    toast('Layout salvo com sucesso!', 'üíæ');
  }

  function loadLayout(){
    const saved = localStorage.getItem('vanLayoutNobreak');
    if(!saved) return;

    try{
      const data = JSON.parse(saved);
      const canvas = document.getElementById('canvas');

      document.querySelectorAll('.seat').forEach(s => s.remove());

      if(data.config){
        snap = data.config.snap ?? true;
        vanOpacity = data.config.vanOpacity ?? 0.3;
        locked = data.config.locked ?? false;

        document.getElementById('vanBg').style.opacity = vanOpacity;
        document.getElementById('btnSnap').innerHTML =
          `<span>üß≤</span> Snap: ${snap ? 'ON' : 'OFF'}`;
        document.getElementById('btnVan').innerHTML =
          `<span>üñºÔ∏è</span> Van: ${Math.round(vanOpacity * 100)}%`;
        document.getElementById('btnLock').innerHTML =
          locked ? '<span>üîí</span> Travado' : '<span>üîì</span> Destravado';
      }

      data.seats.forEach(sd => {
        const seat = document.createElement('div');
        seat.className = `seat status-${sd.status}`;
        seat.id = sd.id;
        seat.innerHTML = `
          <div class="seat-num">#${sd.number}</div>
          <div class="seat-tag">ASSENTO</div>
          <div class="seat-delete" onclick="removeSeat('${sd.id}')">‚úï</div>
        `;

        seat.style.left = sd.x + 'px';
        seat.style.top = sd.y + 'px';

        if(sd.locked) seat.classList.add('locked');

        canvas.appendChild(seat);
        makeDraggable(seat);
      });

      seats = data.seats;
      counter = Math.max(...seats.map(s => s.number), 0) + 1;

      if(seats.length > 0){
        document.getElementById('hint').style.display = 'none';
      }

      updateAll();
      toast('Layout carregado', '‚úÖ');
    }catch(e){
      console.error('Erro ao carregar layout:', e);
      toast('Erro ao carregar layout', '‚ùå');
    }
  }

  function makeDraggable(el){
    let dragging = false;
    let offsetX = 0, offsetY = 0;
    let pointerId = null;

    el.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      const sd = seats.find(s => s.id === el.id);
      if(sd){
        sd.locked = !sd.locked;
        el.classList.toggle('locked', sd.locked);
        toast(sd.locked ? `#${sd.number} travado` : `#${sd.number} destravado`, sd.locked ? 'üîí' : 'üîì');
      }
    });

    el.addEventListener('pointerdown', (e) => {
      if(e.target.classList.contains('seat-delete')) return;
      if(locked) return;

      const sd = seats.find(s => s.id === el.id);
      if(sd?.locked) return;

      dragging = true;
      pointerId = e.pointerId;

      lockBodyScroll();

      const rect = el.getBoundingClientRect();
      offsetX = e.clientX - rect.left;
      offsetY = e.clientY - rect.top;

      el.classList.add('dragging');
      el.setPointerCapture(pointerId);

      e.preventDefault();
    }, { passive:false });

    el.addEventListener('pointermove', (e) => {
      if(!dragging) return;
      if(pointerId !== e.pointerId) return;

      const canvas = document.getElementById('canvas');
      const rect = canvas.getBoundingClientRect();

      let x = e.clientX - rect.left - offsetX;
      let y = e.clientY - rect.top - offsetY;

      x = Math.max(0, Math.min(x, rect.width - el.offsetWidth));
      y = Math.max(0, Math.min(y, rect.height - el.offsetHeight));

      if(snap){
        x = Math.round((x + el.offsetWidth/2) / GRID) * GRID - el.offsetWidth/2;
        y = Math.round((y + el.offsetHeight/2) / GRID) * GRID - el.offsetHeight/2;
        x = Math.max(0, Math.min(x, rect.width - el.offsetWidth));
        y = Math.max(0, Math.min(y, rect.height - el.offsetHeight));
      }

      el.style.left = x + 'px';
      el.style.top = y + 'px';

      e.preventDefault();
    }, { passive:false });

    const endDrag = (e) => {
      if(!dragging) return;
      if(pointerId !== null && e.pointerId !== pointerId) return;

      dragging = false;
      el.classList.remove('dragging');
      unlockBodyScroll();

      const sd = seats.find(s => s.id === el.id);
      if(sd){
        sd.x = parseFloat(el.style.left);
        sd.y = parseFloat(el.style.top);
      }

      pointerId = null;
    };

    el.addEventListener('pointerup', endDrag, { passive:true });
    el.addEventListener('pointercancel', endDrag, { passive:true });

    el.addEventListener('lostpointercapture', () => {
      if(dragging){
        dragging = false;
        el.classList.remove('dragging');
        unlockBodyScroll();
        pointerId = null;
      }
    });

    el.addEventListener('dblclick', () => {
      if(locked) return;

      const sd = seats.find(s => s.id === el.id);
      if(!sd) return;

      const num = prompt('Novo n√∫mero:', sd.number);
      if(!num) return;

      sd.number = parseInt(num);
      el.querySelector('.seat-num').textContent = '#' + num;

      renderList();
      toast(`Renomeado para #${num}`, '‚úèÔ∏è');
    });
  }

  function updateAll(){
    const total = seats.length;
    const livre = seats.filter(s => s.status === 'livre').length;
    const reservado = seats.filter(s => s.status === 'reservado').length;
    const confirmado = seats.filter(s => s.status === 'confirmado').length;
    const bloqueado = seats.filter(s => s.status === 'bloqueado').length;
    const ocupados = reservado + confirmado + bloqueado;

    const totalEl = document.getElementById('statTotal');
    const livresEl = document.getElementById('statLivres');
    const ocupadosEl = document.getElementById('statOcupados');
    const countEl = document.getElementById('canvasCount');

    if(totalEl) totalEl.textContent = total;
    if(livresEl) livresEl.textContent = livre;
    if(ocupadosEl) ocupadosEl.textContent = ocupados;
    if(countEl) countEl.textContent = total;

    renderList();
  }

  function renderList(){
    const list = document.getElementById('passengerList');
    list.innerHTML = '';

    seats
      .sort((a, b) => a.number - b.number)
      .forEach(s => {
        const card = document.createElement('div');
        card.className = `passenger-card status-${s.status}`;
        card.innerHTML = `
          <div class="passenger-header">
            <div class="passenger-num">#${s.number}</div>
            <input
              type="text"
              class="passenger-input"
              placeholder="Nome do passageiro"
              value="${s.name || ''}"
              onchange="updateField('${s.id}', 'name', this.value)"
            />
            <select class="passenger-select" onchange="updateStatus('${s.id}', this.value)">
              <option value="livre" ${s.status === 'livre' ? 'selected' : ''}>üü¢ Livre</option>
              <option value="reservado" ${s.status === 'reservado' ? 'selected' : ''}>üü† Reservado</option>
              <option value="confirmado" ${s.status === 'confirmado' ? 'selected' : ''}>‚úÖ Confirmado</option>
              <option value="bloqueado" ${s.status === 'bloqueado' ? 'selected' : ''}>‚õî Bloqueado</option>
            </select>
          </div>
          <div class="passenger-docs">
            <div class="doc-row">
              <input
                type="text"
                class="doc-input"
                placeholder="Nome Completo"
                value="${s.nomeCompleto || ''}"
                onchange="updateField('${s.id}', 'nomeCompleto', this.value)"
              />
              <div class="doc-field">
                <label class="doc-label">RG</label>
                <input
                  type="text"
                  class="doc-input"
                  placeholder="00.000.000-0"
                  value="${s.rg || ''}"
                  onchange="updateField('${s.id}', 'rg', this.value)"
                />
              </div>
            </div>
            <div class="doc-row">
              <input
                type="text"
                class="doc-input"
                placeholder="CPF: 000.000.000-00"
                value="${s.cpf || ''}"
                onchange="updateField('${s.id}', 'cpf', this.value)"
              />
              <div class="doc-field">
                <label class="doc-label">Data Nasc.</label>
                <input
                  type="date"
                  class="doc-input"
                  value="${s.dataNascimento || ''}"
                  onchange="updateField('${s.id}', 'dataNascimento', this.value)"
                />
              </div>
            </div>
          </div>
        `;
        list.appendChild(card);
      });
  }

  function updateField(id, field, value){
    const s = seats.find(x => x.id === id);
    if(s){
      s[field] = value;
      if(field === 'name') toast('Nome atualizado', 'üë§');
      else toast('Documento atualizado', 'üìÑ');
    }
  }

  function updateStatus(id, status){
    const s = seats.find(x => x.id === id);
    const el = document.getElementById(id);

    if(s && el){
      s.status = status;
      el.className = `seat status-${status}`;
      if(s.locked) el.classList.add('locked');

      updateAll();
      toast(`#${s.number} ‚Üí ${status}`, 'üé´');
    }
  }

  function setAll(status){
    seats.forEach(s => {
      s.status = status;
      const el = document.getElementById(s.id);
      if(el){
        el.className = `seat status-${status}`;
        if(s.locked) el.classList.add('locked');
      }
    });

    updateAll();
    toast(`Todos os assentos ‚Üí ${status}`, '‚ö°');
  }

  function exportLayout(){
    if(seats.length === 0){
      toast('Nenhum assento para exportar', '‚ö†Ô∏è');
      return;
    }
    document.getElementById('exportModal').style.display = 'flex';
  }

  function closeExportModal(){
    document.getElementById('exportModal').style.display = 'none';
  }

  async function exportAsPDF(){
    closeExportModal();
    toast('Gerando PDF em 1920x1080...', '‚è≥');

    try{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('portrait', 'mm', 'a4');

      doc.setFillColor(20, 24, 37);
      doc.rect(0, 0, 210, 35, 'F');

      doc.setTextColor(167, 139, 250);
      doc.setFontSize(24);
      doc.setFont('helvetica', 'bold');
      doc.text('VAN VOLTZ', 105, 16, { align: 'center' });

      doc.setTextColor(148, 163, 184);
      doc.setFontSize(9);
      doc.text('Layout de Assentos', 105, 23, { align: 'center' });
      doc.text(new Date().toLocaleDateString('pt-BR', {
        day: '2-digit',
        month: 'long',
        year: 'numeric'
      }), 105, 29, { align: 'center' });

      const total = seats.length;
      const livre = seats.filter(s => s.status === 'livre').length;
      const reservado = seats.filter(s => s.status === 'reservado').length;
      const confirmado = seats.filter(s => s.status === 'confirmado').length;
      const bloqueado = seats.filter(s => s.status === 'bloqueado').length;
      const ocupados = reservado + confirmado + bloqueado;

      doc.setFillColor(26, 31, 46);
      doc.roundedRect(15, 40, 180, 12, 3, 3, 'F');

      doc.setTextColor(241, 245, 249);
      doc.setFontSize(8);
      doc.setFont('helvetica', 'bold');
      doc.text(`TOTAL: ${total}`, 35, 48);
      doc.setTextColor(16, 185, 129);
      doc.text(`LIVRES: ${livre}`, 95, 48);
      doc.setTextColor(245, 158, 11);
      doc.text(`OCUPADOS: ${ocupados}`, 155, 48);

      const canvas = document.getElementById('canvas');
      const hint = document.getElementById('hint');
      const hintWasVisible = hint && hint.style.display !== 'none';
      if(hint) hint.style.display = 'none';

      const TARGET_WIDTH = 1920;
      const TARGET_HEIGHT = 1080;

      const canvasElement = document.getElementById('canvas');
      const currentWidth = canvasElement.offsetWidth;
      const currentHeight = canvasElement.offsetHeight;

      const scaleX = TARGET_WIDTH / currentWidth;
      const scaleY = TARGET_HEIGHT / currentHeight;
      const scale = Math.min(scaleX, scaleY);

      const screenshot = await html2canvas(canvas, {
        backgroundColor: '#1a1f2e',
        scale: scale,
        width: currentWidth,
        height: currentHeight,
        useCORS: true,
        allowTaint: true,
        logging: false
      });

      if(hint && hintWasVisible) hint.style.display = 'block';

      const imgData = screenshot.toDataURL('image/png');

      const pageWidth = 210;
      const pageHeight = 297;
      const headerHeight = 57;
      const sideMargin = 8;
      const topMargin = 3;
      const bottomMargin = 10;

      const availableWidth = pageWidth - (sideMargin * 2);
      const availableHeight = pageHeight - headerHeight - topMargin - bottomMargin;

      const imgRatio = screenshot.width / screenshot.height;

      let pdfWidth, pdfHeight;

      if(imgRatio < (availableWidth / availableHeight)){
        pdfHeight = availableHeight;
        pdfWidth = pdfHeight * imgRatio;
      }else{
        pdfWidth = availableWidth;
        pdfHeight = pdfWidth / imgRatio;
      }

      const xPos = (pageWidth - pdfWidth) / 2;
      const remainingSpace = availableHeight - pdfHeight;
      const yPos = headerHeight + topMargin + (remainingSpace / 2);

      doc.addImage(imgData, 'PNG', xPos, yPos, pdfWidth, pdfHeight);

      doc.addPage('portrait');

      let y = 20;

      doc.setTextColor(167, 139, 250);
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('Lista de Passageiros', 105, y, { align: 'center' });

      y += 12;

      const sortedSeats = [...seats].sort((a, b) => a.number - b.number);

      doc.setFillColor(15, 20, 30);
      doc.rect(10, y - 5, 190, 8, 'F');

      doc.setTextColor(167, 139, 250);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(7);
      doc.text('#', 13, y);
      doc.text('NOME', 22, y);
      doc.text('NOME COMPLETO', 55, y);
      doc.text('RG', 100, y);
      doc.text('CPF', 125, y);
      doc.text('NASC', 155, y);
      doc.text('STATUS', 180, y);

      y += 10;

      sortedSeats.forEach((s, idx) => {
        if(y > 270){
          doc.addPage();
          y = 20;

          doc.setFillColor(15, 20, 30);
          doc.rect(10, y - 5, 190, 8, 'F');
          doc.setTextColor(167, 139, 250);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(7);
          doc.text('#', 13, y);
          doc.text('NOME', 22, y);
          doc.text('NOME COMPLETO', 55, y);
          doc.text('RG', 100, y);
          doc.text('CPF', 125, y);
          doc.text('NASC', 155, y);
          doc.text('STATUS', 180, y);
          y += 10;
        }

        if(idx % 2 === 0){
          doc.setFillColor(20, 25, 35);
          doc.rect(10, y - 6, 190, 11, 'F');
        }else{
          doc.setFillColor(15, 20, 30);
          doc.rect(10, y - 6, 190, 11, 'F');
        }

        const statusColors = {
          livre: [59, 130, 246],
          reservado: [245, 158, 11],
          confirmado: [16, 185, 129],
          bloqueado: [239, 68, 68]
        };

        const color = statusColors[s.status] || [148, 163, 184];

        doc.setFillColor(...color);
        doc.circle(13, y - 2, 1.5, 'F');

        doc.setTextColor(241, 245, 249);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8);
        doc.text(`${s.number}`, 13, y, { align: 'center' });

        doc.setFont('helvetica', 'normal');
        doc.setTextColor(220, 225, 235);
        doc.setFontSize(7);
        const name = s.name || '‚Äî';
        doc.text(name.substring(0, 18), 22, y);

        const nomeCompleto = s.nomeCompleto || '‚Äî';
        doc.text(nomeCompleto.substring(0, 22), 55, y);

        const rg = s.rg || '‚Äî';
        doc.text(rg.substring(0, 12), 100, y);

        const cpf = s.cpf || '‚Äî';
        doc.text(cpf.substring(0, 14), 125, y);

        const dataNasc = s.dataNascimento ? new Date(s.dataNascimento + 'T00:00').toLocaleDateString('pt-BR') : '‚Äî';
        doc.text(dataNasc, 155, y);

        doc.setTextColor(...color);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(7);
        const statusText = {
          livre: 'LIVRE',
          reservado: 'RESERV',
          confirmado: 'CONF',
          bloqueado: 'BLOQ'
        }[s.status];
        doc.text(statusText, 180, y);

        y += 11;
      });

      const pageCount = doc.internal.getNumberOfPages();
      for(let i = 1; i <= pageCount; i++){
        doc.setPage(i);
        doc.setFontSize(7);
        doc.setTextColor(100, 116, 139);
        doc.text(
          `Sistema Van Voltz ‚Ä¢ Gerado em ${new Date().toLocaleString('pt-BR')} ‚Ä¢ Imagem: 1920x1080px`,
          105,
          287,
          { align: 'center' }
        );
        doc.text(`P√°gina ${i} de ${pageCount}`, 105, 292, { align: 'center' });
      }

      doc.save(`van-layout-vertical-${Date.now()}.pdf`);
      toast('PDF exportado (vertical otimizado)!', 'üìÑ');
    }catch(e){
      console.error('Erro no PDF:', e);
      toast('Erro ao gerar PDF', '‚ùå');
    }
  }

  async function exportAsImage(){
    closeExportModal();
    toast('Gerando imagem...', '‚è≥');

    try{
      const canvas = document.getElementById('canvas');
      const canvasData = await html2canvas(canvas, {
        backgroundColor: '#1a1f2e',
        scale: 3
      });

      canvasData.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `van-layout-${Date.now()}.png`;
        a.click();
        URL.revokeObjectURL(url);
        toast('Imagem exportada com sucesso!', 'üñºÔ∏è');
      });
    }catch(e){
      console.error(e);
      toast('Erro ao gerar imagem', '‚ùå');
    }
  }

  function exportAsExcel(){
    closeExportModal();
    toast('Gerando planilha...', '‚è≥');

    try{
      const sortedSeats = seats.sort((a, b) => a.number - b.number);

      const data = sortedSeats.map(s => ({
        'Assento': `#${s.number}`,
        'Passageiro': s.name || 'Sem passageiro',
        'Status': {
          livre: 'Livre',
          reservado: 'Reservado',
          confirmado: 'Confirmado',
          bloqueado: 'Bloqueado'
        }[s.status],
        'Travado': s.locked ? 'Sim' : 'N√£o'
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      ws['!cols'] = [
        { wch: 10 },
        { wch: 25 },
        { wch: 15 },
        { wch: 10 }
      ];

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Passageiros');

      const summary = [
        ['RESUMO DO LAYOUT'],
        [''],
        ['Total de Assentos', seats.length],
        ['Assentos Livres', seats.filter(s => s.status === 'livre').length],
        ['Assentos Reservados', seats.filter(s => s.status === 'reservado').length],
        ['Assentos Confirmados', seats.filter(s => s.status === 'confirmado').length],
        ['Assentos Bloqueados', seats.filter(s => s.status === 'bloqueado').length],
        [''],
        ['Gerado em', new Date().toLocaleString('pt-BR')]
      ];

      const wsSummary = XLSX.utils.aoa_to_sheet(summary);
      wsSummary['!cols'] = [{ wch: 25 }, { wch: 15 }];
      XLSX.utils.book_append_sheet(wb, wsSummary, 'Resumo');

      XLSX.writeFile(wb, `van-passageiros-${Date.now()}.xlsx`);
      toast('Planilha exportada com sucesso!', 'üìä');
    }catch(e){
      console.error(e);
      toast('Erro ao gerar planilha', '‚ùå');
    }
  }

  function exportAsJSON(){
    closeExportModal();
    toast('Gerando backup...', '‚è≥');

    try{
      const backup = {
        metadata: {
          exportDate: new Date().toISOString(),
          totalSeats: seats.length,
          version: '1.0'
        },
        config: { snap, vanOpacity, locked },
        seats: seats.map(s => ({
          id: s.id,
          number: s.number,
          x: s.x,
          y: s.y,
          status: s.status,
          name: s.name,
          locked: s.locked
        }))
      };

      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `van-backup-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);

      toast('Backup exportado com sucesso!', 'üíæ');
    }catch(e){
      console.error(e);
      toast('Erro ao gerar backup', '‚ùå');
    }
  }

  function managePresets(){
    document.getElementById('presetsModal').style.display = 'flex';
    loadPresetsList();
  }

  function closePresetsModal(){
    document.getElementById('presetsModal').style.display = 'none';
    document.getElementById('presetName').value = '';
  }

  function savePreset(){
    if(seats.length === 0){
      toast('Adicione assentos antes de salvar preset', '‚ö†Ô∏è');
      return;
    }

    const name = document.getElementById('presetName').value.trim();
    if(!name){
      toast('Digite um nome para o preset', '‚ö†Ô∏è');
      return;
    }

    const presets = JSON.parse(localStorage.getItem('vanPresets') || '[]');

    const preset = {
      id: Date.now(),
      name: name,
      seats: seats.map(s => ({...s})),
      config: { snap, vanOpacity, locked },
      createdAt: new Date().toISOString(),
      totalSeats: seats.length
    };

    presets.push(preset);
    localStorage.setItem('vanPresets', JSON.stringify(presets));

    document.getElementById('presetName').value = '';
    loadPresetsList();
    toast(`Preset "${name}" salvo!`, '‚≠ê');
  }

  function loadPresetsList(){
    const presets = JSON.parse(localStorage.getItem('vanPresets') || '[]');
    const list = document.getElementById('presetsList');

    if(presets.length === 0){
      list.innerHTML = `
        <p style="color:var(--text-muted); font-size:13px; text-align:center; padding:20px">
          Nenhum preset salvo ainda
        </p>
      `;
      return;
    }

    list.innerHTML = presets.map(p => `
      <div class="preset-item">
        <div class="preset-info">
          <strong>${p.name}</strong>
          <small>${p.totalSeats} assentos ‚Ä¢ ${new Date(p.createdAt).toLocaleDateString('pt-BR')}</small>
        </div>
        <div class="preset-actions">
          <button class="preset-btn load" onclick="loadPreset(${p.id})" title="Carregar">üìÇ</button>
          <button class="preset-btn delete" onclick="deletePreset(${p.id})" title="Excluir">üóëÔ∏è</button>
        </div>
      </div>
    `).join('');
  }

  function loadPreset(id){
    const presets = JSON.parse(localStorage.getItem('vanPresets') || '[]');
    const preset = presets.find(p => p.id === id);

    if(!preset){
      toast('Preset n√£o encontrado', '‚ùå');
      return;
    }

    if(!confirm(`Carregar preset "${preset.name}"? O layout atual ser√° substitu√≠do.`)){
      return;
    }

    document.querySelectorAll('.seat').forEach(s => s.remove());

    snap = preset.config.snap ?? true;
    vanOpacity = preset.config.vanOpacity ?? 0.3;
    locked = preset.config.locked ?? false;

    document.getElementById('vanBg').style.opacity = vanOpacity;
    document.getElementById('btnSnap').innerHTML =
      `<span>üß≤</span> Snap: ${snap ? 'ON' : 'OFF'}`;
    document.getElementById('btnVan').innerHTML =
      `<span>üñºÔ∏è</span> Van: ${Math.round(vanOpacity * 100)}%`;
    document.getElementById('btnLock').innerHTML =
      locked ? '<span>üîí</span> Travado' : '<span>üîì</span> Destravado';

    const canvas = document.getElementById('canvas');
    preset.seats.forEach(sd => {
      const seat = document.createElement('div');
      seat.className = `seat status-${sd.status}`;
      seat.id = sd.id;
      seat.innerHTML = `
        <div class="seat-num">#${sd.number}</div>
        <div class="seat-tag">ASSENTO</div>
        <div class="seat-delete" onclick="removeSeat('${sd.id}')">‚úï</div>
      `;

      seat.style.left = sd.x + 'px';
      seat.style.top = sd.y + 'px';

      if(sd.locked) seat.classList.add('locked');

      canvas.appendChild(seat);
      makeDraggable(seat);
    });

    seats = preset.seats.map(s => ({...s}));
    counter = Math.max(...seats.map(s => s.number), 0) + 1;

    document.getElementById('hint').style.display = 'none';

    updateAll();
    closePresetsModal();
    toast(`Preset "${preset.name}" carregado!`, '‚≠ê');
  }

  function deletePreset(id){
    const presets = JSON.parse(localStorage.getItem('vanPresets') || '[]');
    const preset = presets.find(p => p.id === id);

    if(!preset){
      toast('Preset n√£o encontrado', '‚ùå');
      return;
    }

    if(!confirm(`Excluir preset "${preset.name}"?`)){
      return;
    }

    const filtered = presets.filter(p => p.id !== id);
    localStorage.setItem('vanPresets', JSON.stringify(filtered));

    loadPresetsList();
    toast('Preset exclu√≠do', 'üóëÔ∏è');
  }

  async function shareWhatsApp(){
    if(seats.length === 0){
      toast('Nenhum assento para compartilhar', '‚ö†Ô∏è');
      return;
    }

    toast('Gerando PDF para WhatsApp...', '‚è≥');

    try{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('portrait', 'mm', 'a4');

      doc.setFillColor(20, 24, 37);
      doc.rect(0, 0, 210, 35, 'F');

      doc.setTextColor(167, 139, 250);
      doc.setFontSize(24);
      doc.setFont('helvetica', 'bold');
      doc.text('VAN VOLTZ', 105, 16, { align: 'center' });

      doc.setTextColor(148, 163, 184);
      doc.setFontSize(9);
      doc.text('Layout de Assentos', 105, 23, { align: 'center' });
      doc.text(new Date().toLocaleDateString('pt-BR', {
        day: '2-digit',
        month: 'long',
        year: 'numeric'
      }), 105, 29, { align: 'center' });

      const total = seats.length;
      const livre = seats.filter(s => s.status === 'livre').length;
      const reservado = seats.filter(s => s.status === 'reservado').length;
      const confirmado = seats.filter(s => s.status === 'confirmado').length;
      const bloqueado = seats.filter(s => s.status === 'bloqueado').length;
      const ocupados = reservado + confirmado + bloqueado;

      doc.setFillColor(26, 31, 46);
      doc.roundedRect(15, 40, 180, 12, 3, 3, 'F');

      doc.setTextColor(241, 245, 249);
      doc.setFontSize(8);
      doc.setFont('helvetica', 'bold');
      doc.text(`TOTAL: ${total}`, 35, 48);
      doc.setTextColor(16, 185, 129);
      doc.text(`LIVRES: ${livre}`, 95, 48);
      doc.setTextColor(245, 158, 11);
      doc.text(`OCUPADOS: ${ocupados}`, 155, 48);

      const canvas = document.getElementById('canvas');
      const hint = document.getElementById('hint');
      const hintWasVisible = hint && hint.style.display !== 'none';
      if(hint) hint.style.display = 'none';

      const TARGET_WIDTH = 1920;
      const TARGET_HEIGHT = 1080;

      const canvasElement = document.getElementById('canvas');
      const currentWidth = canvasElement.offsetWidth;
      const currentHeight = canvasElement.offsetHeight;

      const scaleX = TARGET_WIDTH / currentWidth;
      const scaleY = TARGET_HEIGHT / currentHeight;
      const scale = Math.min(scaleX, scaleY);

      const screenshot = await html2canvas(canvas, {
        backgroundColor: '#1a1f2e',
        scale: scale,
        width: currentWidth,
        height: currentHeight,
        useCORS: true,
        allowTaint: true,
        logging: false
      });

      if(hint && hintWasVisible) hint.style.display = 'block';

      const imgData = screenshot.toDataURL('image/png');

      const pageWidth = 210;
      const pageHeight = 297;
      const headerHeight = 57;
      const sideMargin = 8;
      const topMargin = 3;
      const bottomMargin = 10;

      const availableWidth = pageWidth - (sideMargin * 2);
      const availableHeight = pageHeight - headerHeight - topMargin - bottomMargin;

      const imgRatio = screenshot.width / screenshot.height;

      let pdfWidth, pdfHeight;

      if(imgRatio < (availableWidth / availableHeight)){
        pdfHeight = availableHeight;
        pdfWidth = pdfHeight * imgRatio;
      }else{
        pdfWidth = availableWidth;
        pdfHeight = pdfWidth / imgRatio;
      }

      const xPos = (pageWidth - pdfWidth) / 2;
      const remainingSpace = availableHeight - pdfHeight;
      const yPos = headerHeight + topMargin + (remainingSpace / 2);

      doc.addImage(imgData, 'PNG', xPos, yPos, pdfWidth, pdfHeight);

      doc.addPage('portrait');
      let y = 20;

      doc.setTextColor(167, 139, 250);
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('Lista de Passageiros', 105, y, { align: 'center' });
      y += 12;

      const sortedSeats = [...seats].sort((a, b) => a.number - b.number);

      doc.setFillColor(26, 31, 46);
      doc.rect(15, y - 5, 180, 8, 'F');
      doc.setTextColor(148, 163, 184);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(9);
      doc.text('ASSENTO', 25, y);
      doc.text('PASSAGEIRO', 55, y);
      doc.text('STATUS', 160, y);
      y += 10;

      sortedSeats.forEach((s, idx) => {
        if(y > 275){
          doc.addPage();
          y = 20;
          doc.setFillColor(26, 31, 46);
          doc.rect(15, y - 5, 180, 8, 'F');
          doc.setTextColor(148, 163, 184);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.text('ASSENTO', 25, y);
          doc.text('PASSAGEIRO', 55, y);
          doc.text('STATUS', 160, y);
          y += 10;
        }

        if(idx % 2 === 0){
          doc.setFillColor(22, 27, 40);
          doc.rect(15, y - 6, 180, 9, 'F');
        }

        const statusColors = {
          livre: [59, 130, 246],
          reservado: [245, 158, 11],
          confirmado: [16, 185, 129],
          bloqueado: [239, 68, 68]
        };

        const color = statusColors[s.status] || [148, 163, 184];
        doc.setFillColor(...color);
        doc.circle(20, y - 2, 2, 'F');

        doc.setTextColor(241, 245, 249);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.text(`#${s.number}`, 27, y);

        doc.setFont('helvetica', 'normal');
        doc.setTextColor(200, 210, 225);
        const name = s.name || '‚Äî';
        doc.text(name.substring(0, 35), 55, y);

        doc.setTextColor(...color);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        const statusText = {
          livre: 'LIVRE',
          reservado: 'RESERVADO',
          confirmado: 'CONFIRMADO',
          bloqueado: 'BLOQUEADO'
        }[s.status];
        doc.text(statusText, 160, y);

        y += 9;
      });

      const pageCount = doc.internal.getNumberOfPages();
      for(let i = 1; i <= pageCount; i++){
        doc.setPage(i);
        doc.setFontSize(7);
        doc.setTextColor(100, 116, 139);
        doc.text(
          `Sistema Van Voltz ‚Ä¢ ${new Date().toLocaleString('pt-BR')} ‚Ä¢ 1920x1080px`,
          105,
          287,
          { align: 'center' }
        );
        doc.text(`P√°gina ${i} de ${pageCount}`, 105, 292, { align: 'center' });
      }

      const pdfBlob = doc.output('blob');
      const file = new File([pdfBlob], `van-layout-${Date.now()}.pdf`, { type: 'application/pdf' });

      if(navigator.share && navigator.canShare && navigator.canShare({ files: [file] })){
        await navigator.share({
          title: 'Layout Van Voltz',
          text: `Layout da van com ${total} assentos (${livre} livres, ${ocupados} ocupados)`,
          files: [file]
        });
        toast('Compartilhado com sucesso!', '‚úÖ');
      }else{
        const url = URL.createObjectURL(pdfBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `van-layout-${Date.now()}.pdf`;
        a.click();
        URL.revokeObjectURL(url);

        setTimeout(() => {
          alert('PDF baixado! Abra o WhatsApp e envie o arquivo baixado.');
        }, 500);
        toast('PDF baixado - envie pelo WhatsApp', 'üì±');
      }
    }catch(e){
      console.error('Erro no WhatsApp:', e);
      toast('Erro ao gerar PDF', '‚ùå');
    }
  }

  window.addSeat = addSeat;
  window.removeSeat = removeSeat;
  window.clearAll = clearAll;
  window.saveLayout = saveLayout;
  window.toggleSnap = toggleSnap;
  window.toggleVan = toggleVan;
  window.toggleLock = toggleLock;
  window.setAll = setAll;
  window.updateField = updateField;
  window.updateStatus = updateStatus;
  window.exportLayout = exportLayout;
  window.closeExportModal = closeExportModal;
  window.exportAsPDF = exportAsPDF;
  window.exportAsImage = exportAsImage;
  window.exportAsExcel = exportAsExcel;
  window.exportAsJSON = exportAsJSON;
  window.managePresets = managePresets;
  window.closePresetsModal = closePresetsModal;
  window.savePreset = savePreset;
  window.loadPreset = loadPreset;
  window.deletePreset = deletePreset;
  window.shareWhatsApp = shareWhatsApp;

  window.addEventListener('DOMContentLoaded', () => {
    loadLayout();
    updateAll();
  });
  </script>
</body>
</html>
