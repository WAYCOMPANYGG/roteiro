<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>VIP Admin | OFF Company</title>

<style>
  @font-face{
    font-family:"Rokiest";
    src:url("https://waycompanygg.github.io/roteiro/assets/fonts/Rokiest-Extrabold.otf") format("opentype");
    font-weight:800; font-display:swap;
  }
  :root{
    --bg1:#05060b; --bg2:#0b1020;
    --panel: rgba(14,18,32,.66);
    --panel2: rgba(14,18,32,.50);
    --stroke: rgba(255,255,255,.10);
    --text:#e5e7eb; --muted: rgba(229,231,235,.62);
    --blue:#7c3aed; --cyan:#06b6d4; --green:#22c55e; --amber:#f59e0b; --red:#ef4444;
    --shadow: 0 24px 90px rgba(0,0,0,.72);
    --glow: 0 0 0 1px rgba(124,58,237,.25), 0 22px 90px rgba(124,58,237,.18);
  }
  *{ box-sizing:border-box }
  body{
    margin:0; min-height:100vh;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--text);
    background:
      radial-gradient(1200px 680px at 12% 12%, rgba(124,58,237,.20), transparent 60%),
      radial-gradient(1000px 640px at 86% 18%, rgba(6,182,212,.14), transparent 60%),
      radial-gradient(1200px 760px at 60% 98%, rgba(34,197,94,.10), transparent 55%),
      linear-gradient(135deg, var(--bg1), var(--bg2));
    overflow-x:hidden;
  }

  /* ===== layout ===== */
  .shell{
    display:grid;
    grid-template-columns: 86px 1fr;
    min-height:100vh;
  }
  @media(max-width:980px){
    .shell{ grid-template-columns: 1fr; }
  }

  /* ===== sidebar ===== */
  .side{
    position:sticky; top:0;
    height:100vh;
    padding:18px 14px;
    border-right:1px solid rgba(255,255,255,.08);
    background: linear-gradient(180deg, rgba(10,12,20,.76), rgba(10,12,20,.38));
    backdrop-filter: blur(10px);
  }
  @media(max-width:980px){
    .side{
      position:relative; height:auto;
      display:flex; gap:10px;
      border-right:none; border-bottom:1px solid rgba(255,255,255,.08);
      align-items:center; justify-content:space-between;
    }
  }
  .logo{
    width:48px; height:48px; border-radius:16px;
    display:flex; align-items:center; justify-content:center;
    background: rgba(124,58,237,.16);
    border:1px solid rgba(124,58,237,.22);
    box-shadow: var(--glow);
    font-family:Rokiest; letter-spacing:.8px;
  }
  .nav{
    margin-top:18px;
    display:flex; flex-direction:column; gap:10px;
  }
  @media(max-width:980px){
    .nav{ flex-direction:row; margin-top:0; }
  }
  .navbtn{
    width:52px; height:52px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    color:#fff;
    cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    transition: .18s ease;
    position:relative;
  }
  .navbtn:hover{ transform: translateY(-2px); box-shadow: 0 18px 40px rgba(0,0,0,.35); }
  .navbtn.active{
    background: rgba(124,58,237,.18);
    border-color: rgba(124,58,237,.35);
    box-shadow: var(--glow);
  }
  .navbtn .tip{
    position:absolute;
    left:70px;
    opacity:0; transform: translateX(-6px);
    pointer-events:none;
    transition:.15s ease;
    padding:8px 10px;
    background: rgba(17,24,39,.92);
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;
    font-weight:900;
    font-size:12px;
    white-space:nowrap;
  }
  .navbtn:hover .tip{ opacity:1; transform: translateX(0); }
  @media(max-width:980px){
    .navbtn .tip{ display:none; }
  }

  /* ===== main ===== */
  .main{
    padding:22px;
  }
  .topbar{
    display:flex; align-items:flex-end; justify-content:space-between;
    gap:14px; flex-wrap:wrap;
    margin-bottom:14px;
  }
  .title{
    display:flex; flex-direction:column; gap:6px;
  }
  h1{
    margin:0;
    font-family:Rokiest;
    letter-spacing:1px;
    font-size:34px;
  }
  .sub{
    color: var(--muted);
    font-size:13px;
  }

  .actions{
    display:flex; gap:10px; flex-wrap:wrap;
    align-items:center;
  }
  .pill{
    display:inline-flex;
    gap:8px; align-items:center;
    padding:10px 12px;
    border:1px solid rgba(255,255,255,.10);
    border-radius:999px;
    background: rgba(255,255,255,.04);
    color: rgba(229,231,235,.72);
    font-size:12px; font-weight:900;
  }

  /* ===== cards ===== */
  .grid{
    display:grid;
    grid-template-columns: 1.2fr .8fr;
    gap:12px;
  }
  @media(max-width:1100px){ .grid{ grid-template-columns: 1fr; } }

  .card{
    background: var(--panel);
    border:1px solid rgba(255,255,255,.10);
    border-radius:22px;
    box-shadow: var(--shadow);
    padding:16px;
    backdrop-filter: blur(12px);
    animation: enter .35s ease both;
  }
  .card.soft{
    background: var(--panel2);
    box-shadow: 0 20px 70px rgba(0,0,0,.55);
  }
  @keyframes enter{
    from{ opacity:0; transform: translateY(10px) scale(.99); }
    to{ opacity:1; transform: translateY(0) scale(1); }
  }
  .cardTitle{
    display:flex; justify-content:space-between; align-items:center;
    gap:10px;
    margin-bottom:10px;
  }
  .cardTitle h2{
    margin:0;
    font-family:Rokiest;
    letter-spacing:.7px;
    font-size:18px;
  }
  .muted{ color: var(--muted); font-size:12px; }

  /* ===== inputs/buttons ===== */
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
  .field{ flex:1 1 220px; display:flex; flex-direction:column; gap:6px; }
  label{ font-size:12px; color: rgba(229,231,235,.72); font-weight:900; }
  input, select{
    height:44px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(2,6,23,.55);
    color: var(--text);
    padding: 10px 12px;
    outline:none;
    transition:.15s ease;
  }
  input:focus, select:focus{
    border-color: rgba(124,58,237,.55);
    box-shadow: 0 0 0 4px rgba(124,58,237,.16);
  }

  .btn{
    height:44px;
    border-radius:14px;
    border:0;
    padding:0 14px;
    font-weight:900;
    cursor:pointer;
    color:#fff;
    transition:.16s ease;
    white-space:nowrap;
  }
  .btn:hover{ transform: translateY(-2px); }
  .btn:active{ transform: translateY(0); opacity:.92; }
  .btn.purple{ background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(6,182,212,.70)); box-shadow: var(--glow); }
  .btn.green{ background: rgba(34,197,94,.92); box-shadow: 0 16px 40px rgba(34,197,94,.15); }
  .btn.amber{ background: rgba(245,158,11,.92); color:#111827; box-shadow: 0 16px 40px rgba(245,158,11,.16); }
  .btn.ghost{ background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); }
  .btn.danger{ background: rgba(239,68,68,.18); border:1px solid rgba(239,68,68,.35); }

  /* ===== KPIs ===== */
  .kpis{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:10px;
    margin-top:10px;
  }
  @media(max-width:980px){ .kpis{ grid-template-columns: 1fr 1fr; } }
  @media(max-width:560px){ .kpis{ grid-template-columns: 1fr; } }

  .kpi{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(2,6,23,.35);
    border-radius:18px;
    padding:12px;
    position:relative;
    overflow:hidden;
  }
  .kpi:before{
    content:"";
    position:absolute; inset:-60px -80px auto auto;
    width:160px; height:160px;
    background: radial-gradient(circle, rgba(124,58,237,.30), transparent 60%);
    filter: blur(2px);
  }
  .kpi .t{ font-size:12px; color: rgba(229,231,235,.65); font-weight:900; }
  .kpi .v{ font-size:24px; font-weight:900; margin-top:6px; letter-spacing:.3px; }
  .kpi .s{ font-size:12px; color: rgba(229,231,235,.65); margin-top:6px; }

  /* ===== slots grid ===== */
  .slotsHeader{
    display:flex; justify-content:space-between; align-items:center;
    gap:10px; flex-wrap:wrap;
    margin-top:14px;
  }
  .slotsGrid{
    display:grid;
    grid-template-columns: repeat(6, 1fr);
    gap:10px;
    margin-top:12px;
  }
  @media(max-width:980px){ .slotsGrid{ grid-template-columns: repeat(3,1fr); } }
  @media(max-width:560px){ .slotsGrid{ grid-template-columns: repeat(2,1fr); } }

  .slot{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(2,6,23,.45);
    border-radius:18px;
    padding:12px;
    min-height: 150px;
    display:flex; flex-direction:column; justify-content:space-between;
    transition:.16s ease;
    position:relative;
    overflow:hidden;
  }
  .slot:hover{ transform: translateY(-2px); box-shadow: 0 18px 44px rgba(0,0,0,.40); }
  .slot:before{
    content:"";
    position:absolute; inset:auto -60px -80px auto;
    width:140px; height:140px;
    background: radial-gradient(circle, rgba(6,182,212,.18), transparent 60%);
    transform: rotate(18deg);
  }
  .topRow{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .num{ font-weight:900; color: rgba(229,231,235,.92); }
  .badge{
    font-size:12px; font-weight:900;
    padding:6px 10px; border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
    display:inline-flex; align-items:center; gap:8px;
  }
  .chip{
    font-size:12px; font-weight:900;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(124,58,237,.25);
    background: rgba(124,58,237,.10);
    color: rgba(229,231,235,.92);
  }

  .bLivre{ border-color: rgba(34,197,94,.22); background: rgba(34,197,94,.06); }
  .bOcup { border-color: rgba(245,158,11,.20); background: rgba(245,158,11,.07); }
  .bBloq { border-color: rgba(239,68,68,.22); background: rgba(239,68,68,.06); }
  .bConf { border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.14); }

  .info{ margin-top:8px; font-size:12px; color: rgba(229,231,235,.80); line-height:1.25; }
  .miniActions{ display:flex; gap:8px; margin-top:10px; }
  .miniBtn{
    flex:1 1 auto;
    height:34px;
    border-radius:12px;
    padding:0;
    font-weight:900;
    font-size:13px;
    border:1px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.06);
    cursor:pointer;
    transition:.15s ease;
    color:#fff;
  }
  .miniBtn:hover{ transform: translateY(-1px); opacity:.96; }
  .miniBlue{ border-color: rgba(6,182,212,.30); background: rgba(6,182,212,.16); }
  .miniGreen{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.16); }
  .miniRed{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.16); }

  /* ===== overlay / modal ===== */
  .overlay{
    position:fixed; inset:0;
    display:none;
    align-items:center; justify-content:center;
    background: rgba(0,0,0,.60);
    backdrop-filter: blur(12px);
    z-index:99999;
    padding:18px;
  }
  .modal{
    width: min(980px, 96vw);
    border-radius: 22px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(10,14,26,.92);
    box-shadow: 0 24px 90px rgba(0,0,0,.75);
    padding: 16px;
    animation: pop .18s ease both;
  }
  @keyframes pop{ from{ opacity:0; transform: scale(.985); } to{ opacity:1; transform: scale(1); } }
  .modalHead{
    display:flex; justify-content:space-between; align-items:center; gap:10px;
    margin-bottom:10px;
  }
  .modalHead .t{
    font-family:Rokiest; letter-spacing:.7px; font-size:18px;
  }
  .close{
    height:38px; border-radius:12px;
    padding:0 12px;
  }

  .table{
    margin-top:12px;
    border:1px solid rgba(255,255,255,.10);
    border-radius:18px;
    overflow:hidden;
  }
  .tr{
    display:grid;
    grid-template-columns: 90px 120px 1fr 160px;
    gap:10px;
    padding:10px 12px;
    align-items:center;
    border-bottom:1px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.02);
  }
  .tr.head{
    background: rgba(255,255,255,.04);
    font-size:12px;
    color: rgba(229,231,235,.70);
    font-weight:900;
  }
  .tr:last-child{ border-bottom:none; }
  .small{ font-size:12px; color: rgba(229,231,235,.70); }
  @media(max-width:860px){
    .tr{ grid-template-columns: 70px 110px 1fr; }
    .tr .colCode{ display:none; }
  }

  /* ===== loader toast ===== */
  .loading{
    width:56px; height:56px;
    border-radius:999px;
    border:3px solid rgba(255,255,255,.16);
    border-top-color: rgba(124,58,237,.92);
    animation: spin .9s linear infinite;
    margin: 6px auto 10px;
  }
  @keyframes spin{ to{ transform: rotate(360deg); } }

  .toast{
    position:fixed; bottom:18px; left:50%;
    transform:translateX(-50%);
    background: rgba(17,24,39,.95);
    border:1px solid rgba(255,255,255,.12);
    padding:10px 12px;
    border-radius:12px;
    font-weight:900;
    opacity:0; pointer-events:none;
    transition:.2s;
    z-index:100000;
    box-shadow: 0 14px 40px rgba(0,0,0,.45);
  }
  .toast.show{ opacity:1; }

  /* ===== skeleton ===== */
  .skeleton{
    position:relative;
    overflow:hidden;
    background: rgba(255,255,255,.05);
  }
  .skeleton:after{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent);
    transform: translateX(-100%);
    animation: shimmer 1.2s ease infinite;
  }
  @keyframes shimmer{
    100%{ transform: translateX(100%); }
  }
</style>
</head>

<body>
<div class="shell">
  <!-- SIDEBAR -->
  <aside class="side">
    <div class="logo">OFF</div>

    <div class="nav">
      <button class="navbtn active" id="tabDashboard" onclick="setTab('dashboard')" aria-label="Dashboard">
        üß† <span class="tip">Dashboard</span>
      </button>
      <button class="navbtn" id="tabPool" onclick="setTab('pool')" aria-label="Pool">
        üß© <span class="tip">Pool</span>
      </button>
      <button class="navbtn" id="tabCodes" onclick="setTab('codes')" aria-label="C√≥digos">
        üîë <span class="tip">C√≥digos</span>
      </button>
      <button class="navbtn" id="tabSlots" onclick="setTab('slots')" aria-label="Slots">
        üéüÔ∏è <span class="tip">Slots</span>
      </button>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div class="title">
        <h1>VIP Admin</h1>
        <div class="sub">OFF Company ‚Ä¢ Desenvolvido por Lucas Santos</div>
      </div>

      <div class="actions">
        <span class="pill">üîí √Årea restrita</span>
        <button class="btn purple" onclick="openResumo()">üìä Resumo (ocupados / livres)</button>
        <button class="btn ghost" onclick="hardRefresh()">‚Üª Atualizar tudo</button>
      </div>
    </div>

    <!-- DASHBOARD KPIs -->
    <section class="card soft" id="sectionDashboard">
      <div class="cardTitle">
        <h2>Dashboard</h2>
        <div class="muted">Contadores e vis√£o geral</div>
      </div>

      <div class="row">
        <div class="field">
          <label>Senha Admin</label>
          <input id="adminPass" type="password" placeholder="Sua senha admin">
        </div>
        <button class="btn green" onclick="hardRefresh()">Conectar / Carregar</button>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="t">Total slots</div>
          <div class="v" id="kTotal">‚Äî</div>
          <div class="s" id="kTotalS">VIP (geral)</div>
        </div>
        <div class="kpi">
          <div class="t">Livres</div>
          <div class="v" id="kFree">‚Äî</div>
          <div class="s">prontos pra usar</div>
        </div>
        <div class="kpi">
          <div class="t">Ocupados</div>
          <div class="v" id="kBusy">‚Äî</div>
          <div class="s">reservados</div>
        </div>
        <div class="kpi">
          <div class="t">Confirmados</div>
          <div class="v" id="kConf">‚Äî</div>
          <div class="s">VIP ok (verde)</div>
        </div>
      </div>

      <div class="kpis" style="margin-top:10px">
        <div class="kpi">
          <div class="t">Bloqueados</div>
          <div class="v" id="kBlock">‚Äî</div>
          <div class="s">n√£o pode reservar</div>
        </div>
        <div class="kpi">
          <div class="t">C√≥digos criados</div>
          <div class="v" id="kCodes">‚Äî</div>
          <div class="s">na aba CODES</div>
        </div>
        <div class="kpi">
          <div class="t">Œ£ slotsAllowed</div>
          <div class="v" id="kAllowed">‚Äî</div>
          <div class="s">limite total</div>
        </div>
        <div class="kpi">
          <div class="t">Œ£ slotsAssigned</div>
          <div class="v" id="kAssigned">‚Äî</div>
          <div class="s">atrelados a c√≥digos</div>
        </div>
      </div>
    </section>

    <div class="grid" style="margin-top:12px">
      <!-- POOL -->
      <section class="card" id="sectionPool">
        <div class="cardTitle">
          <h2>Pool (slots gerais)</h2>
          <div class="muted">Criar pool e ver slots livres do pool</div>
        </div>

        <div class="row">
          <div class="field" style="flex:0 0 220px">
            <label>Total no Pool</label>
            <input id="poolTotal" type="number" min="0" value="50">
          </div>
          <button class="btn purple" onclick="setPool()">Aplicar Pool</button>
          <button class="btn ghost" onclick="loadPool()">Ver Pool</button>
        </div>

        <div class="slotsHeader">
          <div>
            <div class="muted">Pool = slots com <b>code vazio</b></div>
          </div>
          <div class="pill">üß© Pool: <span id="poolCount">‚Äî</span></div>
        </div>

        <div id="poolGrid" class="slotsGrid"></div>
      </section>

      <!-- CODES -->
      <section class="card" id="sectionCodes">
        <div class="cardTitle">
          <h2>C√≥digos</h2>
          <div class="muted">Criar e atrelar slots do pool</div>
        </div>

        <div class="row">
          <div class="field" style="flex:0 0 170px">
            <label>Minutos</label>
            <input id="mins" type="number" min="1" value="60">
          </div>
          <div class="field" style="flex:0 0 200px">
            <label>slotsAllowed</label>
            <input id="slotsAllowed" type="number" min="0" value="3">
          </div>
          <button class="btn amber" onclick="createCode()">Criar c√≥digo</button>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>C√≥digo gerado (clique para copiar)</label>
            <input id="codeOut" readonly placeholder="(vai aparecer aqui)">
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field" style="flex:1 1 320px">
            <label>Selecionar c√≥digo</label>
            <select id="codeSelect"></select>
          </div>
          <button class="btn green" onclick="loadCodeSlots()">Ver slots do c√≥digo</button>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn purple" onclick="assignSelected()">Atribuir slots selecionados</button>
          <button class="btn danger" onclick="unassignSelected()">Devolver slots selecionados</button>
        </div>

        <div class="muted" style="margin-top:10px">
          Dica: selecione slots no Pool (aba Pool) e depois atribua aqui.
        </div>
      </section>
    </div>

    <!-- SLOTS DO C√ìDIGO -->
    <section class="card soft" id="sectionSlots" style="margin-top:12px">
      <div class="slotsHeader">
        <div>
          <div class="cardTitle" style="margin:0">
            <h2 style="margin:0;font-family:Rokiest;letter-spacing:.7px;font-size:18px">Slots do c√≥digo</h2>
          </div>
          <div class="muted">Sem blur ‚Ä¢ Ocupado mostra c√≥digo ‚Ä¢ Confirmado fica verde</div>
        </div>
        <button class="btn ghost" onclick="loadCodeSlots()">Atualizar</button>
      </div>

      <div id="codeSlotsGrid" class="slotsGrid"></div>
    </section>

    <div class="toast" id="toast">‚úÖ</div>
  </main>
</div>

<!-- LOADING OVERLAY -->
<div class="overlay" id="loadingOverlay">
  <div class="modal" style="max-width:520px;text-align:center">
    <div class="loading"></div>
    <div style="font-family:Rokiest;letter-spacing:.7px;font-size:20px">Carregando‚Ä¶</div>
    <div class="muted" style="margin-top:6px">Aguarde</div>
  </div>
</div>

<!-- RESUMO MODAL -->
<div class="overlay" id="resumoOverlay">
  <div class="modal">
    <div class="modalHead">
      <div class="t">Resumo de Slots (Ocupados / Livres)</div>
      <button class="btn ghost close" onclick="closeResumo()">‚úñ</button>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="t">Total</div><div class="v" id="rTotal">‚Äî</div><div class="s">geral</div></div>
      <div class="kpi"><div class="t">Livres</div><div class="v" id="rFree">‚Äî</div><div class="s">dispon√≠veis</div></div>
      <div class="kpi"><div class="t">Ocupados</div><div class="v" id="rBusy">‚Äî</div><div class="s">reservados</div></div>
      <div class="kpi"><div class="t">Confirmados</div><div class="v" id="rConf">‚Äî</div><div class="s">VIP ok</div></div>
    </div>

    <div class="table" id="busyTable">
      <div class="tr head">
        <div>#Slot</div>
        <div>Status</div>
        <div>Nome</div>
        <div class="colCode">C√≥digo</div>
      </div>
      <div class="tr">
        <div class="small">‚Äî</div>
        <div class="small">‚Äî</div>
        <div class="small">‚Äî</div>
        <div class="small colCode">‚Äî</div>
      </div>
    </div>
  </div>
</div>

<script>
  // ========= COLE SUA URL /exec AQUI =========
  const API_URL = "https://script.google.com/macros/s/AKfycbyyU0eLff_-CRNBi6G_BfjGZA9G3kEylVHuhM0N9HqNFD2vsR8A2NeF_g0jV921Q4MG/exec"; // ex: https://script.google.com/macros/s/XXXXX/exec

  // estado
  let poolRows = [];
  let codeRows = [];
  let codeSlots = [];
  const selectedPoolSlots = new Set(); // sele√ß√£o no pool

  // util UI
  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1800);
  }
  function loading(on){
    document.getElementById("loadingOverlay").style.display = on ? "flex" : "none";
  }
  function adminPass(){ return document.getElementById("adminPass").value || ""; }

  function normalizeCode(s){
    s = String(s||"").trim().toUpperCase();
    const m = s.match(/[A-Z0-9]{4,12}/);
    return m ? m[0] : "";
  }
  function currentCode(){
    const sel = document.getElementById("codeSelect");
    return normalizeCode(sel ? sel.value : "");
  }

  async function api(fn, payload){
    const controller = new AbortController();
    const timeout = setTimeout(()=>controller.abort(), 20000);
    try{
      const res = await fetch(API_URL, {
        method:"POST",
        cache:"no-store",
        body: JSON.stringify({ fn, payload }),
        signal: controller.signal
      });
      const text = await res.text();
      try { return JSON.parse(text); }
      catch { return { ok:false, error:"Resposta inv√°lida: " + text.slice(0,160) }; }
    }catch(err){
      return { ok:false, error:(err.name==="AbortError" ? "Timeout (20s)" : String(err)) };
    }finally{
      clearTimeout(timeout);
    }
  }

  // tabs (visual)
  function setTab(name){
    ["tabDashboard","tabPool","tabCodes","tabSlots"].forEach(id=>document.getElementById(id).classList.remove("active"));
    document.getElementById("tab" + name.charAt(0).toUpperCase() + name.slice(1)).classList.add("active");

    const map = {
      dashboard: ["sectionDashboard"],
      pool: ["sectionPool"],
      codes: ["sectionCodes"],
      slots: ["sectionSlots"]
    };
    const allSections = ["sectionDashboard","sectionPool","sectionCodes","sectionSlots"];
    allSections.forEach(id => document.getElementById(id).style.display = "none");
    (map[name]||["sectionDashboard"]).forEach(id => document.getElementById(id).style.display = "block");

    // dashboard sempre vis√≠vel tamb√©m? (se quiser)
    if(name !== "dashboard") document.getElementById("sectionDashboard").style.display = "block";
  }

  // anima contador
  function animateNumber(el, to){
    const from = Number(String(el.textContent||"0").replace(/\D/g,"")) || 0;
    const start = performance.now();
    const dur = 520;
    function tick(t){
      const p = Math.min(1, (t-start)/dur);
      const v = Math.round(from + (to-from)*p);
      el.textContent = String(v);
      if(p<1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  // ===== carregamento geral =====
  async function hardRefresh(){
    if(!API_URL || API_URL.includes("COLE_AQUI")) return toast("‚ùå Cole seu API_URL /exec no VIP Admin HTML");
    loading(true);
    try{
      await refreshCodes();
      await refreshDashboardCounts();
      await loadPool();
      await loadCodeSlots();
      toast("‚úÖ Atualizado");
    } finally {
      loading(false);
    }
  }

  // ===== dashboard counts (usa vipAdminGet e vipAdminListCodes) =====
  async function refreshDashboardCounts(){
    const r = await api("vipAdminGet", { adminPass: adminPass() });
    if(!r.ok) return toast("‚ùå " + r.error);

    const rows = r.rows || [];
    let total = rows.length;
    let free = 0, busy = 0, block = 0, conf = 0;

    for(const s of rows){
      const st = String(s.status||"").toUpperCase();
      if(st === "CONFIRMADO") conf++;
      else if(st === "LIVRE") free++;
      else if(st === "OCUPADO") busy++;
      else if(st === "BLOQUEADO") block++;
      else if(st === "CONFIRMADO") conf++;
    }

    animateNumber(document.getElementById("kTotal"), total);
    animateNumber(document.getElementById("kFree"), free);
    animateNumber(document.getElementById("kBusy"), busy);
    animateNumber(document.getElementById("kConf"), conf);
    animateNumber(document.getElementById("kBlock"), block);

    // codes kpis
    const c = await api("vipAdminListCodes", { adminPass: adminPass() });
    if(!c.ok) return toast("‚ùå " + c.error);

    animateNumber(document.getElementById("kCodes"), (c.totalCodes|| (c.rows||[]).length || 0));
    animateNumber(document.getElementById("kAllowed"), (c.totalAllowed||0));
    animateNumber(document.getElementById("kAssigned"), (c.totalAssigned||0));
  }

  // ===== POOL =====
  async function setPool(){
    const total = Number(document.getElementById("poolTotal").value||0);
    loading(true);
    const r = await api("vipAdminSetPool", { adminPass: adminPass(), total });
    loading(false);
    if(!r.ok) return toast("‚ùå " + r.error);
    toast("‚úÖ Pool aplicado");
    await loadPool();
    await refreshDashboardCounts();
  }

  function renderPool(){
    const grid = document.getElementById("poolGrid");
    document.getElementById("poolCount").textContent = String(poolRows.length);

    if(!poolRows.length){
      grid.innerHTML = `<div class="card soft" style="grid-column:1/-1">
        <b>Pool vazio.</b>
        <div class="muted" style="margin-top:6px">Aumente o total e clique em ‚ÄúAplicar Pool‚Äù.</div>
      </div>`;
      return;
    }

    grid.innerHTML = poolRows.map(s=>{
      const st = String(s.status||"LIVRE").toUpperCase();
      const selected = selectedPoolSlots.has(String(s.slot));
      const cls = st==="LIVRE" ? "bLivre" : (st==="BLOQUEADO" ? "bBloq" : "bOcup");

      return `
        <div class="slot ${cls}" style="${selected ? "outline:2px solid rgba(124,58,237,.65); box-shadow: var(--glow);" : ""}">
          <div>
            <div class="topRow">
              <div class="num">#${esc(s.slot)}</div>
              <div class="badge">${esc(st)}</div>
            </div>
            <div class="info muted">Pool (sem c√≥digo)</div>
          </div>
          <div class="miniActions">
            <button class="miniBtn miniBlue" onclick="toggleSelectPool('${escJS(s.slot)}')">${selected ? "‚úì Selecionado" : "Selecionar"}</button>
          </div>
        </div>
      `;
    }).join("");
  }

  async function loadPool(){
    const grid = document.getElementById("poolGrid");
    // skeleton
    grid.innerHTML = Array.from({length:12}).map(()=>`<div class="slot skeleton"></div>`).join("");

    const r = await api("vipAdminGetPool", { adminPass: adminPass() });
    if(!r.ok) return toast("‚ùå " + r.error);

    poolRows = (r.rows || []).filter(x => String(x.status||"").toUpperCase() === "LIVRE");
    // mant√©m sele√ß√£o s√≥ dos que ainda existem
    [...selectedPoolSlots].forEach(id => {
      if(!poolRows.some(s=>String(s.slot)===String(id))) selectedPoolSlots.delete(id);
    });

    renderPool();
  }

  function toggleSelectPool(slotId){
    slotId = String(slotId);
    if(selectedPoolSlots.has(slotId)) selectedPoolSlots.delete(slotId);
    else selectedPoolSlots.add(slotId);
    renderPool();
  }

  // ===== CODES =====
  async function refreshCodes(){
    const r = await api("vipAdminListCodes", { adminPass: adminPass() });
    if(!r.ok) return toast("‚ùå " + r.error);

    codeRows = r.rows || [];
    const sel = document.getElementById("codeSelect");
    const keep = sel.value;

    sel.innerHTML = codeRows.length
      ? codeRows.map(x => `<option value="${esc(x.code)}">${esc(x.code)} ‚Ä¢ allowed:${x.slotsAllowed} ‚Ä¢ assigned:${x.slotsAssigned}${x.expired?" ‚Ä¢ EXPIRADO":""}${!x.active?" ‚Ä¢ OFF":""}</option>`).join("")
      : `<option value="">(nenhum c√≥digo)</option>`;

    if(keep) sel.value = keep;
  }

  async function createCode(){
    const minutes = Number(document.getElementById("mins").value||60);
    const slotsAllowed = Number(document.getElementById("slotsAllowed").value||0);

    loading(true);
    const r = await api("vipAdminCreateCode", { adminPass: adminPass(), minutes, slotsAllowed });
    loading(false);
    if(!r.ok) return toast("‚ùå " + r.error);

    const out = document.getElementById("codeOut");
    out.value = `${r.code} (allowed ${r.slotsAllowed}, expira ${new Date(r.expiresAt).toLocaleString("pt-BR")})`;
    toast("‚úÖ C√≥digo criado");
    await refreshCodes();
    await refreshDashboardCounts();
  }

  document.getElementById("codeOut").addEventListener("click", async ()=>{
    const v = document.getElementById("codeOut").value || "";
    const code = normalizeCode(v);
    if(!code) return;
    try{
      await navigator.clipboard.writeText(code);
      toast("üìã Copiado: " + code);
    } catch {
      toast("‚ùå N√£o deu pra copiar");
    }
  });

  // atribuir slots selecionados
  async function assignSelected(){
    const code = currentCode();
    if(!code) return toast("Selecione um c√≥digo");
    const slotIds = [...selectedPoolSlots];
    if(!slotIds.length) return toast("Selecione slots no Pool");

    loading(true);
    const r = await api("vipAdminAssignSlotsToCode", { adminPass: adminPass(), code, slotIds });
    loading(false);
    if(!r.ok) return toast("‚ùå " + r.error);

    toast(`‚úÖ Atribu√≠dos: ${r.assigned} (pulados: ${r.skipped})`);
    selectedPoolSlots.clear();
    await loadPool();
    await refreshCodes();
    await loadCodeSlots();
    await refreshDashboardCounts();
  }

  async function unassignSelected(){
    const code = currentCode();
    if(!code) return toast("Selecione um c√≥digo");
    // aqui devolvemos slots selecionados no GRID DO C√ìDIGO (sele√ß√£o pr√≥pria)
    const slotIds = [...selectedCodeSlots];
    if(!slotIds.length) return toast("Selecione slots do c√≥digo para devolver");

    loading(true);
    const r = await api("vipAdminUnassignSlotsToPool", { adminPass: adminPass(), slotIds });
    loading(false);
    if(!r.ok) return toast("‚ùå " + r.error);

    toast(`‚úÖ Devolvidos: ${r.returned} (pulados: ${r.skipped})`);
    selectedCodeSlots.clear();
    await loadPool();
    await refreshCodes();
    await loadCodeSlots();
    await refreshDashboardCounts();
  }

  // ===== SLOTS DO C√ìDIGO =====
  const selectedCodeSlots = new Set();

  async function loadCodeSlots(){
    const grid = document.getElementById("codeSlotsGrid");
    const code = currentCode();
    if(!code){
      grid.innerHTML = `<div class="card soft" style="grid-column:1/-1">
        <b>Selecione um c√≥digo</b>
        <div class="muted" style="margin-top:6px">Abra a aba ‚ÄúC√≥digos‚Äù e selecione um c√≥digo.</div>
      </div>`;
      return;
    }

    grid.innerHTML = Array.from({length:12}).map(()=>`<div class="slot skeleton"></div>`).join("");

    const r = await api("vipAdminGetByCode", { adminPass: adminPass(), code });
    if(!r.ok) return toast("‚ùå " + r.error);

    codeSlots = r.rows || [];
    // limpa sele√ß√£o que n√£o existe mais
    [...selectedCodeSlots].forEach(id=>{
      if(!codeSlots.some(s=>String(s.slot)===String(id))) selectedCodeSlots.delete(id);
    });

    renderCodeSlots(code);
  }

  function renderCodeSlots(code){
    const grid = document.getElementById("codeSlotsGrid");
    if(!codeSlots.length){
      grid.innerHTML = `<div class="card soft" style="grid-column:1/-1">
        <b>Nenhum slot nesse c√≥digo.</b>
        <div class="muted" style="margin-top:6px">Atribua slots do Pool para esse c√≥digo.</div>
      </div>`;
      return;
    }

    grid.innerHTML = codeSlots.map(s=>{
      const st = String(s.status||"LIVRE").toUpperCase();
      const selected = selectedCodeSlots.has(String(s.slot));

      const cls =
        st==="LIVRE" ? "bLivre" :
        st==="BLOQUEADO" ? "bBloq" :
        st==="CONFIRMADO" ? "bConf" : "bOcup";

      const line1 = (st==="LIVRE" || st==="BLOQUEADO")
        ? `<div class="info muted">‚Äî</div>`
        : `<div class="info"><b>${esc(s.nome||"")}</b><br><span class="muted">RG:</span> ${esc(s.rg||"")} <span class="muted">CPF:</span> ${esc(s.cpf||"")}</div>`;

      const line2 = (st==="LIVRE" || st==="BLOQUEADO") ? "" :
        `<div class="info muted">Ve√≠culo: ${esc(s.veiculo||"NAO")} ‚Ä¢ Placa: ${esc(s.placa||"")} ‚Ä¢ ${esc(s.cor||"")} ‚Ä¢ ${esc(s.modelo||"")}</div>`;

      const codeChip = `<span class="chip">#${esc(code)}</span>`;

      return `
        <div class="slot ${cls}" style="${selected ? "outline:2px solid rgba(124,58,237,.65); box-shadow: var(--glow);" : ""}">
          <div>
            <div class="topRow">
              <div class="num">#${esc(s.slot)}</div>
              <div style="display:flex; gap:8px; align-items:center;">
                <span class="badge">${esc(st)}</span>
                ${codeChip}
              </div>
            </div>
            ${line1}
            ${line2}
          </div>
          <div class="miniActions">
            <button class="miniBtn miniBlue" onclick="toggleSelectCode('${escJS(s.slot)}')">${selected ? "‚úì Selecionado" : "Selecionar"}</button>
            <button class="miniBtn miniGreen" onclick="confirmSlot('${escJS(s.slot)}')">‚úÖ</button>
            <button class="miniBtn miniRed" onclick="clearSlot('${escJS(s.slot)}')">üßπ</button>
          </div>
        </div>
      `;
    }).join("");
  }

  function toggleSelectCode(slotId){
    slotId = String(slotId);
    if(selectedCodeSlots.has(slotId)) selectedCodeSlots.delete(slotId);
    else selectedCodeSlots.add(slotId);
    renderCodeSlots(currentCode());
  }

  async function confirmSlot(slotId){
    loading(true);
    const r = await api("vipAdminConfirmSlot", { adminPass: adminPass(), slotId });
    loading(false);
    if(!r.ok) return toast("‚ùå " + r.error);
    toast("‚úÖ Confirmado (toggle)");
    await loadCodeSlots();
    await refreshDashboardCounts();
  }

  async function clearSlot(slotId){
    loading(true);
    const r = await api("vipAdminClearSlot", { adminPass: adminPass(), slotId });
    loading(false);
    if(!r.ok) return toast("‚ùå " + r.error);
    toast("‚úÖ Slot limpo");
    await loadCodeSlots();
    await refreshDashboardCounts();
  }

  // ===== RESUMO =====
  async function openResumo(){
    if(!API_URL || API_URL.includes("COLE_AQUI")) return toast("‚ùå Cole seu API_URL /exec no VIP Admin HTML");

    document.getElementById("resumoOverlay").style.display = "flex";
    // skeleton table
    const table = document.getElementById("busyTable");
    table.innerHTML = `
      <div class="tr head">
        <div>#Slot</div><div>Status</div><div>Nome</div><div class="colCode">C√≥digo</div>
      </div>
      ${Array.from({length:6}).map(()=>`
        <div class="tr">
          <div class="skeleton" style="height:14px;border-radius:10px"></div>
          <div class="skeleton" style="height:14px;border-radius:10px"></div>
          <div class="skeleton" style="height:14px;border-radius:10px"></div>
          <div class="skeleton colCode" style="height:14px;border-radius:10px"></div>
        </div>
      `).join("")}
    `;

    loading(true);
    const r = await api("vipAdminGet", { adminPass: adminPass() });
    loading(false);
    if(!r.ok) return toast("‚ùå " + r.error);

    const rows = r.rows || [];
    let total = rows.length;
    let free=0, busy=0, conf=0;

    const busyRows = [];
    for(const s of rows){
      const st = String(s.status||"").toUpperCase();
      if(st==="LIVRE") free++;
      if(st==="OCUPADO") busy++;
      if(st==="CONFIRMADO"){ conf++; busyRows.push(s); }
      if(st==="OCUPADO") busyRows.push(s);
    }

    animateNumber(document.getElementById("rTotal"), total);
    animateNumber(document.getElementById("rFree"), free);
    animateNumber(document.getElementById("rBusy"), busy);
    animateNumber(document.getElementById("rConf"), conf);

    // render list (ocupados + confirmados) com c√≥digo
    table.innerHTML = `
      <div class="tr head">
        <div>#Slot</div><div>Status</div><div>Nome</div><div class="colCode">C√≥digo</div>
      </div>
      ${busyRows.length ? busyRows.map(s=>{
        const st = String(s.status||"").toUpperCase();
        const name = (s.nome && String(s.nome).trim()) ? esc(s.nome) : "(sem nome)";
        const code = s.code ? ("#" + esc(String(s.code))) : "(sem c√≥digo)";
        return `
          <div class="tr">
            <div><b>#${esc(s.slot)}</b></div>
            <div class="small">${st==="CONFIRMADO" ? "‚úÖ CONFIRMADO" : "‚ö†Ô∏è OCUPADO"}</div>
            <div>${name}</div>
            <div class="colCode"><span class="chip">${code}</span></div>
          </div>
        `;
      }).join("") : `
        <div class="tr">
          <div class="small">‚Äî</div><div class="small">‚Äî</div><div class="small">Nenhum ocupado</div><div class="small colCode">‚Äî</div>
        </div>
      `}
    `;
  }

  function closeResumo(){
    document.getElementById("resumoOverlay").style.display = "none";
  }
  document.getElementById("resumoOverlay").addEventListener("click", (e)=>{
    if(e.target.id === "resumoOverlay") closeResumo();
  });

  // helpers
  function esc(s){
    return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }
  function escJS(s){ return String(s??"").replace(/['\\]/g, "\\$&"); }

  // init
  window.addEventListener("DOMContentLoaded", ()=>{
    setTab("dashboard");
  });
</script>
</body>
</html>
