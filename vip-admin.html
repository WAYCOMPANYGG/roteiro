<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>VIP Admin | Lalai√°</title>

<style>
  @font-face{
    font-family:"Rokiest";
    src:url("https://waycompanygg.github.io/roteiro/assets/fonts/Rokiest-Extrabold.otf") format("opentype");
    font-weight:800; font-display:swap;
  }
  :root{
    --bg1:#0b0f19; --bg2:#0f172a;
    --panel:rgba(11,18,32,.82);
    --stroke:rgba(255,255,255,.10);
    --text:#e5e7eb; --muted:rgba(229,231,235,.65);
    --blue:#2563eb; --green:#22c55e; --red:#ef4444; --amber:#f59e0b;
    --shadow:0 24px 70px rgba(0,0,0,.65);
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--text);
    background:
      radial-gradient(900px 520px at 10% 10%, rgba(37,99,235,.20), transparent 60%),
      radial-gradient(900px 520px at 90% 15%, rgba(34,197,94,.14), transparent 60%),
      linear-gradient(135deg,var(--bg1),var(--bg2));
    display:flex; align-items:center; justify-content:center;
    padding:22px;
  }
  .home{
    position:fixed; top:16px; left:16px;
    background:rgba(17,24,39,.92);
    border:1px solid rgba(255,255,255,.12);
    color:#fff; text-decoration:none;
    font-weight:900; font-size:14px;
    padding:10px 12px;
    border-radius:12px;
    box-shadow:0 12px 30px rgba(0,0,0,.45);
    transition:.15s;
    z-index:10;
  }
  .home:hover{transform:translateY(-1px); opacity:.92}

  .wrap{
    width:min(1100px,100%);
    background:var(--panel);
    border:1px solid var(--stroke);
    border-radius:22px;
    box-shadow:var(--shadow);
    padding:18px;
    backdrop-filter:blur(10px);
    animation: in .45s ease both;
  }
  @keyframes in{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  h1{font-family:"Rokiest"; margin:0; letter-spacing:.8px}
  .sub{margin:6px 0 14px; color:var(--muted); font-size:13px}

  .card{
    background:rgba(255,255,255,.04);
    border:1px solid var(--stroke);
    border-radius:18px;
    padding:14px;
  }
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:end}
  .field{display:flex; flex-direction:column; gap:6px; flex:1 1 220px}
  label{font-size:12px; color:rgba(229,231,235,.72)}
  input, select{
    height:44px; border-radius:12px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(2,6,23,.55);
    color:var(--text);
    padding:10px 12px;
    outline:none;
    transition:.15s;
  }
  input:focus, select:focus{
    border-color: rgba(37,99,235,.55);
    box-shadow: 0 0 0 4px rgba(37,99,235,.18);
  }

  button{
    height:44px; border-radius:12px; border:0;
    padding:0 14px; font-weight:900;
    cursor:pointer; color:#fff;
    transition:.15s;
    white-space:nowrap;
  }
  button:hover{transform:translateY(-1px); opacity:.95}
  button:active{transform:translateY(0); opacity:.9}
  .b{background:var(--blue); box-shadow:0 10px 26px rgba(37,99,235,.24)}
  .g{background:var(--green); box-shadow:0 10px 26px rgba(34,197,94,.18)}
  .a{background:var(--amber); color:#111827; box-shadow:0 10px 26px rgba(245,158,11,.20)}
  .ghost{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10)}
  .divider{height:1px; background:rgba(255,255,255,.08); margin:14px 0}

  .kpis{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
    margin-top:10px;
  }
  .kpi{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(2,6,23,.35);
    border-radius:16px;
    padding:12px;
  }
  .kpi .t{font-size:12px; color:rgba(229,231,235,.65); font-weight:900}
  .kpi .v{font-size:22px; font-weight:900; margin-top:6px}
  @media(max-width: 900px){ .kpis{grid-template-columns:1fr} }

  /* slots grid */
  .grid{
    display:grid;
    grid-template-columns: repeat(6, 1fr);
    gap:10px;
    margin-top:12px;
  }
  .slot{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(2,6,23,.45);
    border-radius:16px;
    padding:12px;
    transition:.15s;
    min-height: 140px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .slot:hover{transform:translateY(-1px); opacity:.98}
  .topRow{display:flex; justify-content:space-between; align-items:center; gap:8px}
  .num{font-weight:900; color:rgba(229,231,235,.9)}
  .badge{
    font-size:12px; font-weight:900;
    padding:6px 10px; border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.04);
  }
  .bLivre{ border-color: rgba(34,197,94,.25); background: rgba(34,197,94,.08); }
  .bOcup{ border-color: rgba(245,158,11,.22); background: rgba(245,158,11,.08); }
  .bBloq{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.08); }
  .bConf{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.16); }

  .info{
    margin-top:8px;
    font-size:12px;
    color: rgba(229,231,235,.78);
    line-height:1.25;
  }
  .muted{color: rgba(229,231,235,.55)}

  .miniActions{
    display:flex; gap:8px; margin-top:10px;
  }
  .miniBtn{
    flex:1 1 auto;
    height:34px;
    border-radius:10px;
    padding:0;
    font-weight:900;
    font-size:13px;
  }
  .miniRed{ background:rgba(239,68,68,.18); border:1px solid rgba(239,68,68,.35); }
  .miniBlue{ background:rgba(37,99,235,.22); border:1px solid rgba(37,99,235,.35); }
  .miniGreen{ background:rgba(34,197,94,.20); border:1px solid rgba(34,197,94,.38); }

  /* overlay + loader */
  .overlay{
    position:fixed; inset:0;
    display:none;
    align-items:center; justify-content:center;
    background:rgba(0,0,0,.55);
    backdrop-filter:blur(10px);
    z-index:99999;
    padding:18px;
  }
  .modal{
    width:min(520px, 96vw);
    border-radius:18px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(11,18,32,.92);
    box-shadow:0 20px 70px rgba(0,0,0,.70);
    padding:16px;
    text-align:center;
    animation: pop .22s ease both;
  }
  @keyframes pop{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}
  .ring{
    width:56px; height:56px;
    border-radius:999px;
    border:3px solid rgba(255,255,255,.18);
    border-top-color:rgba(245,158,11,.95);
    margin:10px auto 12px;
    animation:spin .9s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  .toast{
    position:fixed; bottom:18px; left:50%;
    transform:translateX(-50%);
    background:rgba(17,24,39,.95);
    border:1px solid rgba(255,255,255,.12);
    padding:10px 12px;
    border-radius:12px;
    font-weight:900;
    opacity:0; pointer-events:none;
    transition:.2s;
    box-shadow:0 12px 30px rgba(0,0,0,.45);
    z-index: 999999;
  }
  .toast.show{opacity:1}

  @media (max-width: 980px){ .grid{grid-template-columns: repeat(3, 1fr);} }
  @media (max-width: 560px){ .grid{grid-template-columns: repeat(2, 1fr);} }
</style>
</head>

<body>
<a class="home" href="index.html">üè† Home</a>

<div id="overlay" class="overlay">
  <div class="modal">
    <div class="ring"></div>
    <div style="font-family:Rokiest;letter-spacing:.6px;font-size:22px;">Processando‚Ä¶</div>
    <div style="margin-top:6px;color:rgba(229,231,235,.7);font-size:13px;">Aguarde</div>
  </div>
</div>

<div class="wrap">
  <h1>VIP Admin</h1>
  <div class="sub">Gerencie c√≥digos (slotsAllowed) e slots por c√≥digo (sem blur) + confirmar VIP.</div>

  <div class="card">
    <div class="row">
      <div class="field">
        <label>Senha Admin</label>
        <input id="adminPass" type="password" placeholder="Sua senha admin">
      </div>

      <div class="field" style="flex:0 0 210px;">
        <label>Minutos do c√≥digo</label>
        <input id="mins" type="number" min="1" value="60">
      </div>

      <div class="field" style="flex:0 0 210px;">
        <label>Slots liberados (slotsAllowed)</label>
        <input id="slotsAllowed" type="number" min="0" value="3">
      </div>

      <button class="a" onclick="gerarCodigo()">Gerar c√≥digo</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <div class="field" style="flex:1 1 380px;">
        <label>C√≥digo gerado (clique para copiar)</label>
        <input id="codeOut" readonly placeholder="(vai aparecer aqui)">
      </div>

      <button class="b" onclick="gerarSlotsDoCodigo()">Gerar slots do c√≥digo</button>
      <button class="ghost" onclick="atualizarPainel()">Atualizar painel</button>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="field" style="flex:1 1 360px;">
        <label>Selecionar c√≥digo</label>
        <select id="codeSelect" onchange="carregarSlotsDoCodigo()">
          <option value="">‚Äî Selecione um c√≥digo ‚Äî</option>
        </select>
      </div>

      <div class="field" style="flex:1 1 360px;">
        <label>Ou colar c√≥digo</label>
        <input id="codeManual" placeholder="Ex: WPF47K">
      </div>

      <button class="g" onclick="carregarSlotsDoCodigo()">Ver slots do c√≥digo</button>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="t">C√≥digos criados</div>
        <div class="v" id="kpiCodes">0</div>
      </div>
      <div class="kpi">
        <div class="t">Slots liberados (total slotsAllowed)</div>
        <div class="v" id="kpiAllowed">0</div>
      </div>
      <div class="kpi">
        <div class="t">Slots criados (total slotsCreated)</div>
        <div class="v" id="kpiCreated">0</div>
      </div>
    </div>
  </div>

  <div id="grid" class="grid"></div>
</div>

<div id="toast" class="toast">‚úÖ</div>

<script>
  // ======= COLE SUA URL /exec AQUI =======
  const API_URL = "https://script.google.com/macros/s/AKfycbyyU0eLff_-CRNBi6G_BfjGZA9G3kEylVHuhM0N9HqNFD2vsR8A2NeF_g0jV921Q4MG/exec";

  let currentCode = "";
  let slots = [];

  function toast(msg){
    const t=document.getElementById("toast");
    t.textContent=msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1500);
  }
  function overlay(on){
    document.getElementById("overlay").style.display = on ? "flex" : "none";
  }
  function adminPass(){
    return document.getElementById("adminPass").value || "";
  }
  function normalizeCode(s){
    s = String(s||"").trim().toUpperCase();
    const m = s.match(/[A-Z0-9]{4,12}/);
    return m ? m[0] : "";
  }

  async function api(fn, payload){
    const controller = new AbortController();
    const timeout = setTimeout(()=>controller.abort(), 20000);
    try{
      const res = await fetch(API_URL, {
        method:"POST",
        cache:"no-store",
        body: JSON.stringify({ fn, payload }),
        signal: controller.signal
      });
      const text = await res.text();
      try { return JSON.parse(text); }
      catch { return { ok:false, error:"Resposta inv√°lida: " + text.slice(0,160) }; }
    }catch(err){
      return { ok:false, error:(err.name==="AbortError" ? "Timeout (20s)" : String(err)) };
    }finally{
      clearTimeout(timeout);
    }
  }

  async function atualizarPainel(){
    overlay(true);
    const r = await api("vipAdminListCodes", { adminPass: adminPass() });
    overlay(false);

    if(!r.ok) return toast("‚ùå " + r.error);

    const rows = r.rows || [];
    document.getElementById("kpiCodes").textContent = String(rows.length);
    document.getElementById("kpiAllowed").textContent = String(r.totalAllowed || 0);
    document.getElementById("kpiCreated").textContent = String(r.totalCreated || 0);

    const sel = document.getElementById("codeSelect");
    const keep = sel.value;
    sel.innerHTML = `<option value="">‚Äî Selecione um c√≥digo ‚Äî</option>` + rows
      .map(x => `<option value="${escapeHtml(x.code)}">${escapeHtml(x.code)} ‚Ä¢ allowed:${x.slotsAllowed} ‚Ä¢ created:${x.slotsCreated}</option>`)
      .join("");

    if(keep) sel.value = keep;
  }

  async function gerarCodigo(){
    const minutes = Number(document.getElementById("mins").value||60);
    const slotsAllowed = Number(document.getElementById("slotsAllowed").value||0);

    overlay(true);
    const r = await api("vipAdminCreateOrUpdateCode", {
      adminPass: adminPass(),
      minutes,
      slotsAllowed
    });
    overlay(false);

    if(!r.ok) return toast("‚ùå " + r.error);

    const out = document.getElementById("codeOut");
    out.value = `${r.code} (allowed ${r.slotsAllowed}, expira ${new Date(r.expiresAt).toLocaleString("pt-BR")})`;
    currentCode = r.code;

    toast("‚úÖ C√≥digo gerado");
    atualizarPainel();
  }

  document.getElementById("codeOut").addEventListener("click", async ()=>{
    const v = document.getElementById("codeOut").value || "";
    if(!v) return;
    const only = normalizeCode(v);
    try{
      await navigator.clipboard.writeText(only);
      toast("üìã Copiado: " + only);
    }catch{
      toast("‚ùå N√£o deu pra copiar");
    }
  });

  function pickCode(){
    const fromSelect = normalizeCode(document.getElementById("codeSelect").value || "");
    const fromManual = normalizeCode(document.getElementById("codeManual").value || "");
    const code = fromManual || fromSelect || currentCode;
    return code;
  }

  async function gerarSlotsDoCodigo(){
    const code = pickCode();
    if(!code) return toast("Informe/seleciona um c√≥digo");

    overlay(true);
    const r = await api("vipAdminEnsureSlotsForCode", { adminPass: adminPass(), code });
    overlay(false);

    if(!r.ok) return toast("‚ùå " + r.error);

    toast(`‚úÖ Slots criados: +${r.created} (total do c√≥digo: ${r.totalForCode})`);
    currentCode = code;
    await atualizarPainel();
    await carregarSlotsDoCodigo();
  }

  async function carregarSlotsDoCodigo(){
    const code = pickCode();
    if(!code) return toast("Selecione ou cole um c√≥digo");

    currentCode = code;

    overlay(true);
    const r = await api("vipAdminGetByCode", { adminPass: adminPass(), code });
    overlay(false);

    if(!r.ok) return toast("‚ùå " + r.error);

    slots = r.rows || [];
    renderSlots();
    toast("‚úÖ Slots carregados");
  }

  function renderSlots(){
    const grid = document.getElementById("grid");
    if(!slots.length){
      grid.innerHTML = `<div class="card" style="grid-column:1/-1">
        <b>Nenhum slot encontrado para este c√≥digo.</b>
        <div class="sub" style="margin-top:6px">Clique em <b>Gerar slots do c√≥digo</b> para criar os slots (at√© slotsAllowed).</div>
      </div>`;
      return;
    }

    grid.innerHTML = slots.map(s=>{
      const rawStatus = String(s.status||"LIVRE").toUpperCase();
      const status = s.confirmed ? "CONFIRMADO" : rawStatus;

      const cls =
        status==="LIVRE" ? "bLivre" :
        status==="BLOQUEADO" ? "bBloq" :
        status==="CONFIRMADO" ? "bConf" : "bOcup";

      const badge =
        status==="LIVRE" ? "Livre" :
        status==="BLOQUEADO" ? "Bloqueado" :
        status==="CONFIRMADO" ? "Confirmado" : "Ocupado";

      const line1 = (status==="LIVRE" || status==="BLOQUEADO")
        ? `<div class="info muted">‚Äî</div>`
        : `<div class="info"><b>${escapeHtml(s.nome||"")}</b><br><span class="muted">RG:</span> ${escapeHtml(s.rg||"")} <span class="muted">CPF:</span> ${escapeHtml(s.cpf||"")}</div>`;

      const line2 = (status==="LIVRE" || status==="BLOQUEADO") ? "" :
        `<div class="info muted">Ve√≠culo: ${escapeHtml(s.veiculo||"NAO")} | Placa: ${escapeHtml(s.placa||"")} | ${escapeHtml(s.cor||"")} | ${escapeHtml(s.modelo||"")}</div>`;

      const codeTag = `<div class="info muted">C√≥digo: <b>#${escapeHtml(currentCode)}</b></div>`;

      return `
        <div class="slot ${cls}">
          <div>
            <div class="topRow">
              <div class="num">#${escapeHtml(s.slot)}</div>
              <div class="badge">${badge}</div>
            </div>
            ${line1}
            ${line2}
            ${codeTag}
          </div>

          <div class="miniActions">
            <button class="miniBtn miniRed" onclick="deleteSlot('${escapeJs(s.slot)}')" title="Excluir slot">üóëÔ∏è</button>
            <button class="miniBtn miniBlue" onclick="clearSlot('${escapeJs(s.slot)}')" title="Limpar dados">üßπ</button>
            <button class="miniBtn miniGreen" onclick="confirmSlot('${escapeJs(s.slot)}')" title="Confirmar VIP">‚úÖ</button>
          </div>
        </div>
      `;
    }).join("");
  }

  async function clearSlot(slotId){
    if(!currentCode) return toast("Selecione um c√≥digo");
    overlay(true);
    const r = await api("vipAdminClearSlot", { adminPass: adminPass(), code: currentCode, slotId });
    overlay(false);
    if(!r.ok) return toast("‚ùå " + r.error);
    toast("‚úÖ Slot limpo");
    carregarSlotsDoCodigo();
  }

  async function confirmSlot(slotId){
    if(!currentCode) return toast("Selecione um c√≥digo");
    overlay(true);
    const r = await api("vipAdminConfirmSlot", { adminPass: adminPass(), code: currentCode, slotId });
    overlay(false);
    if(!r.ok) return toast("‚ùå " + r.error);
    toast("‚úÖ Confirmado");
    carregarSlotsDoCodigo();
  }

  async function deleteSlot(slotId){
    if(!currentCode) return toast("Selecione um c√≥digo");
    overlay(true);
    const r = await api("vipAdminDeleteSlot", { adminPass: adminPass(), code: currentCode, slotId });
    overlay(false);
    if(!r.ok) return toast("‚ùå " + r.error);
    toast("‚úÖ Exclu√≠do");
    atualizarPainel();
    carregarSlotsDoCodigo();
  }

  function escapeHtml(s){
    return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }
  function escapeJs(s){
    return String(s??"").replace(/['\\]/g, "\\$&");
  }

  // carrega painel ao abrir
  window.addEventListener("DOMContentLoaded", ()=> atualizarPainel());
</script>
</body>
</html>
