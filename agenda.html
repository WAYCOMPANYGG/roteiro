<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Agenda | OFF Company</title>

<style>
  @font-face{
    font-family:"Rokiest";
    src:url("https://waycompanygg.github.io/roteiro/assets/fonts/Rokiest-Extrabold.otf") format("opentype");
    font-weight:800; font-display:swap;
  }

  :root{
    --bg1:#060812; --bg2:#0b1220;
    --panel:rgba(10,16,28,.78);
    --panel2:rgba(13,20,34,.78);
    --stroke:rgba(255,255,255,.10);
    --stroke2:rgba(255,255,255,.06);

    --text:#e5e7eb;
    --muted:rgba(229,231,235,.62);

    --purple:#8b5cf6;
    --purple2:#a78bfa;
    --cyan:#06b6d4;
    --pink:#ec4899;
    --green:#22c55e;
    --amber:#f59e0b;
    --red:#ef4444;

    --shadow:0 24px 80px rgba(0,0,0,.68);
    --shadow2:0 18px 50px rgba(0,0,0,.55);
    --radius:20px;
    --radius2:14px;

    --drawerW: 420px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--text);
    background:
      radial-gradient(900px 520px at 14% 12%, rgba(139,92,246,.20), transparent 60%),
      radial-gradient(900px 520px at 86% 18%, rgba(6,182,212,.15), transparent 60%),
      radial-gradient(900px 520px at 70% 90%, rgba(236,72,153,.10), transparent 60%),
      linear-gradient(135deg,var(--bg1),var(--bg2));
    overflow-x:hidden;
  }

  /* ambient glow blobs */
  .glow{
    position:fixed; inset:-20%;
    pointer-events:none;
    background:
      radial-gradient(420px 320px at 15% 30%, rgba(139,92,246,.18), transparent 60%),
      radial-gradient(480px 360px at 75% 20%, rgba(6,182,212,.12), transparent 60%),
      radial-gradient(520px 420px at 60% 80%, rgba(236,72,153,.10), transparent 60%);
    filter: blur(20px) saturate(120%);
    opacity:.9;
    animation: floatGlow 10s ease-in-out infinite alternate;
  }
  @keyframes floatGlow{
    from{ transform: translate3d(0,0,0) scale(1); }
    to{ transform: translate3d(10px,-8px,0) scale(1.02); }
  }

  /* layout shell */
  .shell{
    width:min(1320px, 100%);
    margin:0 auto;
    padding:18px 18px 40px;
  }

  /* topbar */
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:14px;
    padding:16px 16px;
    border-radius:var(--radius);
    border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow2);
    position:sticky;
    top:12px;
    z-index:50;
  }

  .brand{
    display:flex; align-items:flex-end; gap:14px; min-width:280px;
  }
  .logo{
    width:44px; height:44px;
    border-radius:14px;
    display:grid; place-items:center;
    background:linear-gradient(135deg, rgba(139,92,246,.95), rgba(6,182,212,.55));
    box-shadow: 0 14px 36px rgba(139,92,246,.22);
    font-weight:900;
    letter-spacing:.6px;
  }
  .titles{display:flex; flex-direction:column; gap:4px}
  .titles h1{
    margin:0;
    font-family:"Rokiest";
    letter-spacing:.8px;
    font-size:30px;
    line-height:1;
  }
  .titles .sub{
    font-size:12px;
    color:var(--muted);
  }

  .actions{
    display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    justify-content:flex-end;
  }

  .search{
    display:flex; align-items:center; gap:10px;
    padding:10px 12px;
    height:44px;
    width:min(420px, 48vw);
    border-radius:999px;
    border:1px solid var(--stroke2);
    background:rgba(2,6,23,.40);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
  }
  .search svg{opacity:.8}
  .search input{
    width:100%;
    border:0; outline:0;
    background:transparent;
    color:var(--text);
    font-weight:700;
  }
  .search input::placeholder{color:rgba(229,231,235,.45)}

  .btn{
    height:44px;
    border-radius:999px;
    border:1px solid var(--stroke2);
    background:rgba(255,255,255,.06);
    color:var(--text);
    font-weight:900;
    padding:0 14px;
    cursor:pointer;
    transition:.16s ease;
    display:inline-flex;
    align-items:center;
    gap:10px;
    user-select:none;
  }
  .btn:hover{transform:translateY(-1px); opacity:.98}
  .btn:active{transform:translateY(0px); opacity:.92}
  .btnPrimary{
    border:0;
    background:linear-gradient(135deg, rgba(139,92,246,.95), rgba(6,182,212,.55));
    box-shadow:0 14px 36px rgba(139,92,246,.20);
  }
  .btnGhost{
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.10);
  }

  /* toolbar */
  .toolbar{
    margin-top:14px;
    padding:14px;
    border-radius:var(--radius);
    border:1px solid var(--stroke);
    background:rgba(10,16,28,.66);
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow2);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }

  .leftTools, .rightTools{
    display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  }

  .select{
    height:44px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(2,6,23,.55);
    color:var(--text);
    padding:10px 14px;
    outline:none;
    font-weight:900;
    cursor:pointer;
    transition:.15s;
  }
  .select:focus{
    border-color: rgba(139,92,246,.55);
    box-shadow: 0 0 0 4px rgba(139,92,246,.18);
  }

  .chips{
    display:flex; gap:8px; flex-wrap:wrap;
  }
  .chip{
    height:36px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
    padding:0 12px;
    display:inline-flex;
    align-items:center;
    gap:8px;
    font-weight:900;
    font-size:12px;
    cursor:pointer;
    transition:.16s ease;
    user-select:none;
  }
  .chip:hover{transform:translateY(-1px); opacity:.98}
  .chip:active{transform:translateY(0px); opacity:.92}
  .chip .dot{
    width:10px; height:10px; border-radius:999px;
    box-shadow:0 0 0 4px rgba(255,255,255,.06);
  }
  .chip.active{
    border-color: rgba(139,92,246,.45);
    background: rgba(139,92,246,.14);
    box-shadow: 0 12px 30px rgba(139,92,246,.12);
  }

  /* month header */
  .monthHeader{
    margin-top:14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .monthTitle{
    display:flex;
    align-items:baseline;
    gap:10px;
  }
  .monthTitle .m{
    font-family:"Rokiest";
    letter-spacing:.7px;
    font-size:22px;
  }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
    color:rgba(229,231,235,.75);
    font-weight:900;
    font-size:12px;
  }

  .navMonth{
    display:flex; gap:8px; align-items:center;
  }
  .iconBtn{
    width:44px; height:44px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.05);
    display:grid; place-items:center;
    cursor:pointer;
    transition:.16s ease;
  }
  .iconBtn:hover{transform:translateY(-1px)}
  .iconBtn:active{transform:translateY(0px); opacity:.92}

  /* calendar */
  .calendarWrap{
    margin-top:12px;
    border-radius:var(--radius);
    border:1px solid var(--stroke);
    background:rgba(10,16,28,.66);
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .dow{
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    background:rgba(255,255,255,.03);
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .dow div{
    padding:12px 12px;
    font-size:12px;
    font-weight:900;
    color:rgba(229,231,235,.62);
    letter-spacing:.4px;
    text-transform:lowercase;
  }
  .grid{
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    min-height: 72vh; /* calend√°rio protagonista */
  }

  .cell{
    border-right:1px solid rgba(255,255,255,.05);
    border-bottom:1px solid rgba(255,255,255,.05);
    padding:10px 10px 10px;
    position:relative;
    background:rgba(2,6,23,.20);
    transition: background .18s ease, transform .18s ease;
    overflow:hidden;
  }
  .cell:nth-child(7n){border-right:0}
  .cell:hover{
    background:rgba(139,92,246,.06);
  }
  .cellHeader{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:8px;
  }
  .dayNum{
    font-weight:900;
    color:rgba(229,231,235,.85);
  }
  .tagToday{
    font-size:11px;
    font-weight:900;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(139,92,246,.35);
    background:rgba(139,92,246,.14);
    color:rgba(229,231,235,.92);
  }
  .mutedDay .dayNum{color:rgba(229,231,235,.35)}
  .mutedDay{background:rgba(2,6,23,.14)}
  .cellContent{
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .event{
    position:relative;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
    padding:10px 10px;
    cursor:pointer;
    transition:.16s ease;
    overflow:hidden;
  }
  .event:hover{transform:translateY(-1px); border-color: rgba(255,255,255,.16)}
  .event:active{transform:translateY(0px); opacity:.92}

  .event::before{
    content:"";
    position:absolute; left:0; top:0; bottom:0;
    width:6px;
    background:var(--accent, rgba(139,92,246,.9));
    box-shadow: 0 0 0 1px rgba(255,255,255,.04);
  }

  .eventTop{
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:center;
    margin-bottom:6px;
  }
  .eventTitle{
    font-weight:900;
    font-size:12px;
    letter-spacing:.2px;
    max-width: 70%;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .badge{
    font-size:11px;
    font-weight:900;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
    color:rgba(229,231,235,.82);
    white-space:nowrap;
  }
  .meta{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    color:rgba(229,231,235,.65);
    font-size:11px;
    font-weight:800;
  }
  .meta span{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 8px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(2,6,23,.30);
  }

  /* drawer overlay */
  .overlay{
    position:fixed;
    inset:0;
    display:none;
    align-items:stretch;
    justify-content:flex-end;
    background:rgba(0,0,0,.50);
    backdrop-filter: blur(10px);
    z-index:1000;
  }
  .overlay.show{display:flex; animation:fadeIn .18s ease both}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}

  .drawer{
    width:var(--drawerW);
    max-width:92vw;
    background:rgba(10,16,28,.86);
    border-left:1px solid rgba(255,255,255,.10);
    box-shadow: -20px 0 70px rgba(0,0,0,.55);
    padding:16px;
    transform:translateX(14px);
    animation:drawerIn .22s ease both;
  }
  @keyframes drawerIn{
    from{opacity:0; transform:translateX(18px)}
    to{opacity:1; transform:translateX(0px)}
  }

  .drawerHeader{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    padding-bottom:12px;
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .drawerHeader .t{
    font-family:"Rokiest";
    letter-spacing:.6px;
    font-size:18px;
    margin:0;
  }
  .closeX{
    width:40px; height:40px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.06);
    color:var(--text);
    cursor:pointer;
    display:grid; place-items:center;
    transition:.15s ease;
  }
  .closeX:hover{transform:translateY(-1px)}
  .closeX:active{transform:translateY(0px); opacity:.92}

  .drawerBody{
    padding-top:12px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  @media(max-width:560px){ .row2{grid-template-columns:1fr} }

  .field{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .field label{
    font-size:12px;
    color:rgba(229,231,235,.72);
    font-weight:900;
  }
  .inp, .txt{
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(2,6,23,.55);
    color:var(--text);
    padding:10px 12px;
    outline:none;
    font-weight:800;
    transition:.15s ease;
  }
  .inp{height:44px}
  .txt{min-height:92px; resize:none}
  .inp:focus, .txt:focus{
    border-color: rgba(139,92,246,.55);
    box-shadow: 0 0 0 4px rgba(139,92,246,.18);
  }

  .statusRow{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }
  .miniTag{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
    font-weight:900;
    font-size:12px;
  }
  .miniDot{width:10px;height:10px;border-radius:999px; background:var(--accent)}
  .switch{
    margin-top:6px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.03);
  }
  .switch .sTitle{font-weight:900}
  .toggle{
    width:52px; height:30px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.08);
    position:relative;
    cursor:pointer;
    transition:.16s ease;
    flex:0 0 auto;
  }
  .toggle::after{
    content:"";
    position:absolute;
    top:50%;
    left:4px;
    width:22px; height:22px;
    border-radius:999px;
    transform:translateY(-50%);
    background:rgba(229,231,235,.90);
    transition:.16s ease;
    box-shadow:0 10px 20px rgba(0,0,0,.35);
  }
  .toggle.on{
    background:rgba(34,197,94,.22);
    border-color:rgba(34,197,94,.35);
  }
  .toggle.on::after{ left:26px }

  .drawerActions{
    display:flex;
    gap:10px;
    margin-top:8px;
  }
  .btnDanger{
    border:1px solid rgba(239,68,68,.35);
    background:rgba(239,68,68,.18);
  }

  /* small footer note */
  .note{
    margin-top:10px;
    font-size:12px;
    color:rgba(229,231,235,.55);
    line-height:1.35;
  }

  /* responsive */
  @media(max-width:980px){
    .search{width:min(520px, 92vw)}
    .grid{min-height: 64vh}
  }
  @media(max-width:560px){
    .topbar{position:static}
    .titles h1{font-size:26px}
    .brand{min-width:auto}
    .grid{min-height: 62vh}
  }

  /* micro animations: pop cards on load */
  .popIn{
    animation: popIn .35s ease both;
  }
  @keyframes popIn{
    from{opacity:0; transform:translateY(10px)}
    to{opacity:1; transform:translateY(0)}
  }
</style>
</head>

<body>
<div class="glow"></div>

<div class="shell">
  <!-- TOPBAR -->
  <div class="topbar popIn">
    <div class="brand">
      <div class="logo">OFF</div>
      <div class="titles">
        <h1>Agenda</h1>
        <div class="sub">OFF Company ‚Ä¢ Calend√°rio mensal com gest√£o visual (modo visual)</div>
      </div>
    </div>

    <div class="actions">
      <div class="search" title="Buscar por t√≠tulo, local, contratante...">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M10.5 19a8.5 8.5 0 1 1 0-17 8.5 8.5 0 0 1 0 17Z" stroke="currentColor" stroke-width="2" opacity=".85"/>
          <path d="M16.8 16.8 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".85"/>
        </svg>
        <input id="q" placeholder="Buscar compromisso, local, contratante..." />
      </div>

      <button class="btn btnGhost" id="btnToday">Hoje</button>
      <button class="btn btnPrimary" id="btnNew">Ôºã Novo compromisso</button>
      <a class="btn btnGhost" href="index.html" style="text-decoration:none">üè† Home</a>
    </div>
  </div>

  <!-- TOOLBAR -->
  <div class="toolbar popIn" style="animation-delay:.04s">
    <div class="leftTools">
      <select id="artistFilter" class="select" title="Filtrar por artista">
        <option value="ALL">Todos artistas</option>
      </select>

      <div class="chips" id="statusChips">
        <!-- chips injected -->
      </div>
    </div>

    <div class="rightTools">
      <div class="monthHeader" style="margin:0">
        <div class="monthTitle">
          <div class="m" id="monthLabel">‚Äî</div>
          <div class="pill" id="countLabel">0 compromissos</div>
        </div>
      </div>

      <div class="navMonth">
        <div class="iconBtn" id="prevMonth" title="M√™s anterior">‚Üê</div>
        <div class="iconBtn" id="nextMonth" title="Pr√≥ximo m√™s">‚Üí</div>
      </div>
    </div>
  </div>

  <!-- CALENDAR -->
  <div class="calendarWrap popIn" style="animation-delay:.08s">
    <div class="dow">
      <div>domingo</div><div>segunda</div><div>ter√ßa</div><div>quarta</div><div>quinta</div><div>sexta</div><div>s√°bado</div>
    </div>
    <div class="grid" id="grid"></div>
  </div>

  <div class="note">
    *Tudo aqui √© <b>visual</b> (dados ficam no navegador). Depois a gente integra com planilha / Apps Script.
  </div>
</div>

<!-- DRAWER -->
<div class="overlay" id="overlay">
  <div class="drawer" role="dialog" aria-modal="true" aria-label="Detalhes do compromisso">
    <div class="drawerHeader">
      <div>
        <div class="t" id="drawerTitle">Detalhes</div>
        <div class="sub" id="drawerSub" style="margin-top:6px">‚Äî</div>
      </div>
      <button class="closeX" id="closeDrawer" title="Fechar">‚úï</button>
    </div>

    <div class="drawerBody">
      <div class="statusRow">
        <span class="miniTag" id="tagArtist"><span class="miniDot" style="--accent:var(--purple)"></span><span>ARTISTA</span></span>
        <span class="miniTag" id="tagStatus"><span class="miniDot" style="--accent:var(--cyan)"></span><span>STATUS</span></span>
      </div>

      <div class="row2">
        <div class="field">
          <label>Data</label>
          <input class="inp" id="fDate" type="date" />
        </div>
        <div class="field">
          <label>Hora do show</label>
          <input class="inp" id="fTime" type="time" />
        </div>
      </div>

      <div class="field">
        <label>T√≠tulo</label>
        <input class="inp" id="fTitle" placeholder="Ex: Evento - Pub / Camarote / Reuni√£o..." />
      </div>

      <div class="row2">
        <div class="field">
          <label>Local / Cidade</label>
          <input class="inp" id="fCity" placeholder="Ex: Centro ‚Ä¢ MG" />
        </div>
        <div class="field">
          <label>Endere√ßo</label>
          <input class="inp" id="fAddress" placeholder="Ex: Rua X, 123" />
        </div>
      </div>

      <div class="row2">
        <div class="field">
          <label>Contratante</label>
          <input class="inp" id="fClient" placeholder="Nome do contratante" />
        </div>
        <div class="field">
          <label>N√∫mero</label>
          <input class="inp" id="fPhone" placeholder="(xx) xxxxx-xxxx" />
        </div>
      </div>

      <div class="switch">
        <div>
          <div class="sTitle">Contrato enviado?</div>
          <div class="sub" style="margin-top:4px">Marque para controle interno</div>
        </div>
        <div class="toggle" id="fContract"></div>
      </div>

      <div class="field">
        <label>Observa√ß√µes</label>
        <textarea class="txt" id="fNotes" placeholder="Ex: aguardando resposta, alinhado cachet, rider, etc."></textarea>
      </div>

      <div class="drawerActions">
        <button class="btn btnDanger" id="btnDelete">Excluir (visual)</button>
        <button class="btn btnPrimary" id="btnSave">Salvar (visual)</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ====================== MODELO (VISUAL) ======================
  // artistas com cores de contraste (voc√™ pediu X/Y/Z com cores tipo amarelo/laranja etc.)
  const ARTISTS = [
    { id:"AX", name:"Artista X", color:"#f59e0b" },   // amarelo/amber
    { id:"AY", name:"Artista Y", color:"#fb923c" },   // laranja
    { id:"AZ", name:"Artista Z", color:"#8b5cf6" }    // roxo
  ];

  const STATUSES = [
    { id:"CONFIRMADO", label:"Confirmado", color:"#22c55e" },
    { id:"RESERVADO",  label:"Reservado",  color:"#8b5cf6" },
    { id:"NEGOCIANDO", label:"Negociando", color:"#f59e0b" },
    { id:"LEMBRETE",   label:"Lembrete",   color:"#06b6d4" },
    { id:"RADIO_TV",   label:"R√°dio/TV",   color:"#ec4899" },
    { id:"OUTROS",     label:"Outros",     color:"rgba(229,231,235,.55)" }
  ];

  // seed visual
  let events = [
    {
      id: cryptoId(),
      date: "2026-02-02",
      time: "16:00",
      title: "Reuni√£o ‚Ä¢ Briefing",
      city: "Online",
      address: "",
      status: "LEMBRETE",
      artist: "AY",
      client: "",
      phone: "",
      contractSent: false,
      notes: ""
    },
    {
      id: cryptoId(),
      date: "2026-02-04",
      time: "00:30",
      title: "Show ‚Ä¢ Camarote",
      city: "Sapuca√≠ ‚Ä¢ RJ",
      address: "",
      status: "CONFIRMADO",
      artist: "AZ",
      client: "Produtora",
      phone: "",
      contractSent: true,
      notes: "Rider ok"
    },
    {
      id: cryptoId(),
      date: "2026-02-07",
      time: "22:30",
      title: "Evento ‚Ä¢ Pub",
      city: "Centro ‚Ä¢ MG",
      address: "",
      status: "NEGOCIANDO",
      artist: "AX",
      client: "Contratante",
      phone: "",
      contractSent: false,
      notes: "Aguardando resposta"
    }
  ];

  // ====================== STATE ======================
  const state = {
    viewDate: new Date(),            // m√™s atual
    statusFilter: new Set(),         // vazio = todos
    artistFilter: "ALL",
    query: "",
    selectedId: null,                // evento selecionado (drawer)
    creatingDate: null               // para criar no dia clicado
  };

  // ====================== DOM ======================
  const gridEl = document.getElementById("grid");
  const monthLabel = document.getElementById("monthLabel");
  const countLabel = document.getElementById("countLabel");
  const statusChips = document.getElementById("statusChips");
  const artistSelect = document.getElementById("artistFilter");
  const qEl = document.getElementById("q");

  const overlay = document.getElementById("overlay");
  const closeDrawerBtn = document.getElementById("closeDrawer");

  // drawer fields
  const tagArtist = document.getElementById("tagArtist");
  const tagStatus = document.getElementById("tagStatus");
  const drawerSub = document.getElementById("drawerSub");

  const fDate = document.getElementById("fDate");
  const fTime = document.getElementById("fTime");
  const fTitle = document.getElementById("fTitle");
  const fCity = document.getElementById("fCity");
  const fAddress = document.getElementById("fAddress");
  const fClient = document.getElementById("fClient");
  const fPhone = document.getElementById("fPhone");
  const fNotes = document.getElementById("fNotes");
  const fContract = document.getElementById("fContract");

  const btnSave = document.getElementById("btnSave");
  const btnDelete = document.getElementById("btnDelete");

  // nav
  document.getElementById("prevMonth").addEventListener("click", ()=> shiftMonth(-1));
  document.getElementById("nextMonth").addEventListener("click", ()=> shiftMonth(+1));
  document.getElementById("btnToday").addEventListener("click", ()=> goToday());
  document.getElementById("btnNew").addEventListener("click", ()=> newEvent());

  // close drawer interactions
  closeDrawerBtn.addEventListener("click", closeDrawer);
  overlay.addEventListener("click", (e)=>{ if(e.target.id==="overlay") closeDrawer(); });
  window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeDrawer(); });

  // search
  qEl.addEventListener("input", ()=>{
    state.query = (qEl.value||"").trim().toLowerCase();
    render();
  });

  // contract toggle
  fContract.addEventListener("click", ()=>{
    fContract.classList.toggle("on");
  });

  btnSave.addEventListener("click", ()=>{
    if(!state.selectedId) return;
    const idx = events.findIndex(x=>x.id===state.selectedId);
    if(idx<0) return;

    events[idx] = {
      ...events[idx],
      date: fDate.value || events[idx].date,
      time: fTime.value || "",
      title: fTitle.value || "",
      city: fCity.value || "",
      address: fAddress.value || "",
      client: fClient.value || "",
      phone: fPhone.value || "",
      notes: fNotes.value || "",
      contractSent: fContract.classList.contains("on")
    };

    // se mudou de data pro outro m√™s, mant√©m render
    closeDrawer();
    render();
  });

  btnDelete.addEventListener("click", ()=>{
    if(!state.selectedId) return;
    events = events.filter(x=>x.id!==state.selectedId);
    closeDrawer();
    render();
  });

  // ====================== INIT UI ======================
  function init(){
    // artist dropdown
    artistSelect.innerHTML = `
      <option value="ALL">Todos artistas</option>
      ${ARTISTS.map(a=>`<option value="${a.id}">${escapeHtml(a.name)}</option>`).join("")}
    `;
    artistSelect.addEventListener("change", ()=>{
      state.artistFilter = artistSelect.value;
      render();
    });

    // chips status
    statusChips.innerHTML = STATUSES.map(s=>{
      return `
        <div class="chip" data-status="${s.id}" title="Filtrar: ${escapeHtml(s.label)}">
          <span class="dot" style="background:${s.color}"></span>
          <span>${escapeHtml(s.label)}</span>
        </div>
      `;
    }).join("");

    statusChips.querySelectorAll(".chip").forEach(ch=>{
      ch.addEventListener("click", ()=>{
        const st = ch.getAttribute("data-status");
        if(state.statusFilter.has(st)){
          state.statusFilter.delete(st);
          ch.classList.remove("active");
        }else{
          state.statusFilter.add(st);
          ch.classList.add("active");
        }
        render();
      });
    });

    render();
  }

  // ====================== RENDER ======================
  function render(){
    const view = state.viewDate;
    const y = view.getFullYear();
    const m = view.getMonth();

    const monthName = view.toLocaleString("pt-BR", { month:"long" });
    monthLabel.textContent = cap(monthName) + " ‚Ä¢ " + y;

    const filteredAll = getFilteredEventsForMonth(y, m);
    countLabel.textContent = `${filteredAll.length} compromissos`;

    // build calendar matrix (starts on Sunday)
    const first = new Date(y, m, 1);
    const startDow = first.getDay(); // 0 Sunday
    const daysInMonth = new Date(y, m+1, 0).getDate();

    // we render 42 cells (6 weeks)
    const totalCells = 42;
    const cells = [];

    for(let i=0;i<totalCells;i++){
      const dayIndex = i - startDow + 1;
      const dateObj = new Date(y, m, dayIndex);
      const inMonth = (dateObj.getMonth()===m);
      const dateStr = toISO(dateObj);

      const isToday = isSameDay(dateObj, new Date());
      const dayEvents = getFilteredEventsForDate(dateStr);

      cells.push({
        dateObj,
        dateStr,
        inMonth,
        isToday,
        dayEvents
      });
    }

    gridEl.innerHTML = cells.map(c=>{
      const cls = [
        "cell",
        (!c.inMonth ? "mutedDay" : "")
      ].join(" ");

      const dayNum = c.dateObj.getDate();

      const todayTag = c.isToday ? `<span class="tagToday">hoje</span>` : "";

      const eventsHtml = c.dayEvents
        .slice(0, 3) // limite por c√©lula (p/ n√£o ficar bagun√ßa)
        .map(ev => renderEventCard(ev))
        .join("");

      const moreCount = Math.max(0, c.dayEvents.length - 3);
      const moreHtml = moreCount>0
        ? `<div class="event" style="--accent:rgba(229,231,235,.35)" data-id="" data-date="${c.dateStr}">
             <div class="eventTop">
               <div class="eventTitle">+ ${moreCount} mais</div>
               <div class="badge">ver</div>
             </div>
             <div class="meta"><span>clique</span></div>
           </div>`
        : "";

      return `
        <div class="${cls}" data-date="${c.dateStr}">
          <div class="cellHeader">
            <div class="dayNum">${dayNum}</div>
            ${todayTag}
          </div>
          <div class="cellContent">
            ${eventsHtml}
            ${moreHtml}
          </div>
        </div>
      `;
    }).join("");

    // events click handlers
    gridEl.querySelectorAll(".event").forEach(el=>{
      el.addEventListener("click", (e)=>{
        e.stopPropagation();
        const id = el.getAttribute("data-id");
        const date = el.getAttribute("data-date");
        if(id){
          openDrawer(id);
        }else{
          // "+ mais" -> abre primeiro do dia no drawer (ou cria)
          const dayList = getFilteredEventsForDate(date);
          if(dayList.length) openDrawer(dayList[0].id);
          else newEvent(date);
        }
      });
    });

    // click on empty cell -> create event for that date
    gridEl.querySelectorAll(".cell").forEach(cell=>{
      cell.addEventListener("click", ()=>{
        const d = cell.getAttribute("data-date");
        newEvent(d);
      });
    });
  }

  function renderEventCard(ev){
    const artist = ARTISTS.find(a=>a.id===ev.artist) || ARTISTS[0];
    const st = STATUSES.find(s=>s.id===ev.status) || STATUSES[0];

    const t = (ev.time||"").trim();
    const city = (ev.city||"").trim();

    const metaPieces = [];
    if(t) metaPieces.push(`<span>‚è± ${escapeHtml(t)}</span>`);
    if(city) metaPieces.push(`<span>üìç ${escapeHtml(city)}</span>`);
    metaPieces.push(`<span>üé§ ${escapeHtml(artist.name)}</span>`);

    return `
      <div class="event" style="--accent:${artist.color}" data-id="${ev.id}">
        <div class="eventTop">
          <div class="eventTitle">${escapeHtml(ev.title || "Compromisso")}</div>
          <div class="badge" style="border-color: rgba(255,255,255,.10);">
            <span style="display:inline-flex; align-items:center; gap:8px;">
              <span style="width:8px;height:8px;border-radius:999px;background:${st.color};box-shadow:0 0 0 4px rgba(255,255,255,.04)"></span>
              ${escapeHtml(st.label)}
            </span>
          </div>
        </div>
        <div class="meta">
          ${metaPieces.join("")}
        </div>
      </div>
    `;
  }

  // ====================== FILTERING ======================
  function getFilteredEventsForMonth(y, m){
    return events
      .filter(ev=>{
        const d = new Date(ev.date+"T00:00:00");
        return d.getFullYear()===y && d.getMonth()===m;
      })
      .filter(matchesFilters)
      .sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time));
  }

  function getFilteredEventsForDate(dateStr){
    return events
      .filter(ev=>ev.date===dateStr)
      .filter(matchesFilters)
      .sort((a,b)=> (a.time||"").localeCompare(b.time||""));
  }

  function matchesFilters(ev){
    // artist
    if(state.artistFilter!=="ALL" && ev.artist!==state.artistFilter) return false;

    // status
    if(state.statusFilter.size>0 && !state.statusFilter.has(ev.status)) return false;

    // query
    if(state.query){
      const blob = [
        ev.title, ev.city, ev.address, ev.client, ev.phone, ev.notes,
        (ARTISTS.find(a=>a.id===ev.artist)||{}).name,
        (STATUSES.find(s=>s.id===ev.status)||{}).label
      ].join(" ").toLowerCase();
      if(!blob.includes(state.query)) return false;
    }

    return true;
  }

  // ====================== DRAWER ======================
  function openDrawer(id){
    const ev = events.find(x=>x.id===id);
    if(!ev) return;

    state.selectedId = id;

    const artist = ARTISTS.find(a=>a.id===ev.artist) || ARTISTS[0];
    const st = STATUSES.find(s=>s.id===ev.status) || STATUSES[0];

    document.getElementById("drawerTitle").textContent = "Detalhes";
    drawerSub.textContent = `${artist.name} ‚Ä¢ ${st.label}`;

    tagArtist.innerHTML = `<span class="miniDot" style="--accent:${artist.color}"></span><span>${escapeHtml(artist.name)}</span>`;
    tagStatus.innerHTML = `<span class="miniDot" style="--accent:${st.color}"></span><span>${escapeHtml(st.label)}</span>`;

    fDate.value = ev.date || "";
    fTime.value = ev.time || "";
    fTitle.value = ev.title || "";
    fCity.value = ev.city || "";
    fAddress.value = ev.address || "";
    fClient.value = ev.client || "";
    fPhone.value = ev.phone || "";
    fNotes.value = ev.notes || "";

    fContract.classList.toggle("on", !!ev.contractSent);

    overlay.classList.add("show");
  }

  function closeDrawer(){
    overlay.classList.remove("show");
    state.selectedId = null;
    state.creatingDate = null;
  }

  // ====================== ACTIONS ======================
  function shiftMonth(delta){
    const d = state.viewDate;
    state.viewDate = new Date(d.getFullYear(), d.getMonth()+delta, 1);
    render();
  }

  function goToday(){
    state.viewDate = new Date();
    render();
    // micro: highlight today by opening create on today? n√£o.
  }

  function newEvent(dateStr){
    const baseDate = dateStr || toISO(new Date());
    const defaultArtist = (state.artistFilter!=="ALL") ? state.artistFilter : ARTISTS[0].id;

    const ev = {
      id: cryptoId(),
      date: baseDate,
      time: "20:00",
      title: "Novo compromisso",
      city: "",
      address: "",
      status: "RESERVADO",
      artist: defaultArtist,
      client: "",
      phone: "",
      contractSent: false,
      notes: ""
    };
    events.push(ev);

    // se o evento foi criado num m√™s diferente do view, muda o view pro m√™s dele
    const d = new Date(ev.date+"T00:00:00");
    state.viewDate = new Date(d.getFullYear(), d.getMonth(), 1);

    render();
    openDrawer(ev.id);
  }

  // ====================== UTILS ======================
  function toISO(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function isSameDay(a,b){
    return a.getFullYear()===b.getFullYear()
      && a.getMonth()===b.getMonth()
      && a.getDate()===b.getDate();
  }
  function cap(s){
    s = String(s||"");
    return s ? s[0].toUpperCase()+s.slice(1) : s;
  }
  function escapeHtml(s){
    return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }
  function cryptoId(){
    try{
      const a = new Uint8Array(8);
      crypto.getRandomValues(a);
      return Array.from(a).map(x=>x.toString(16).padStart(2,"0")).join("");
    }catch{
      return String(Math.random()).slice(2)+String(Date.now());
    }
  }

  // ====================== START ======================
  init();
</script>
</body>
</html>
