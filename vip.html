<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbyjet56tIcHrvvHXpZDC9GcUwi08x6fb8vwhq6MvKF0zaT0O425e-oKj0MAKk3u-byK/exec";

  let currentSlots = [];
  let selectedSlot = null;
  let pollTimer = null;

  function toast(msg){
    const t = document.getElementById("toast");
    if(!t){ alert(msg); return; }
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1800);
  }

  function loading(on){
    const el = document.getElementById("loading");
    if(el) el.style.display = on ? "flex" : "none";
  }

  function showOverlay(on){
    const el = document.getElementById("overlay");
    if(el) el.style.display = on ? "flex" : "none";
  }

  function normalizeCode(s){
    s = String(s||"").trim().toUpperCase();
    const m = s.match(/[A-Z0-9]{4,12}/);
    return m ? m[0] : "";
  }

  function toggleVeiculo(){
    const veic = document.getElementById("veiculo");
    const yes = veic && veic.value === "SIM";
    ["placa","cor","modelo"].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.disabled = !yes;
      if(!yes) el.value = "";
    });
  }

  async function api(fn, payload){
    const controller = new AbortController();
    const timeout = setTimeout(()=>controller.abort(), 20000);

    try{
      const res = await fetch(API_URL, {
        method: "POST",
        cache: "no-store",
        body: JSON.stringify({ fn, payload }),
        signal: controller.signal
      });

      const text = await res.text();
      try { return JSON.parse(text); }
      catch { return { ok:false, error:"Resposta inválida da API (não é JSON)" }; }

    } catch (err){
      return { ok:false, error:(err.name==="AbortError" ? "Timeout da API" : "Erro de conexão (Failed to fetch)") };
    } finally {
      clearTimeout(timeout);
    }
  }

  async function entrar(){
    const raw = (document.getElementById("code")?.value || "");
    const code = normalizeCode(raw);
    if(!code) return toast("Digite/cole um código válido");

    const codeInput = document.getElementById("code");
    if(codeInput) codeInput.value = code;

    loading(true);
    const r = await api("vipPublicGet", { code });
    loading(false);

    if(!r.ok) return toast("❌ " + (r.error || "Erro"));

    currentSlots = r.slots || [];
    renderGrid();
    toast("✅ Acesso liberado");

    if(pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(async ()=>{
      const c = normalizeCode(document.getElementById("code")?.value || "");
      if(!c) return;
      const rr = await api("vipPublicGet", { code: c });
      if(rr.ok){
        currentSlots = rr.slots || [];
        renderGrid();
      }
    }, 4000);
  }

  function renderGrid(){
    const grid = document.getElementById("grid");
    if(!grid) return;

    grid.innerHTML = (currentSlots || []).map(s=>{
      const status = String(s.status||"LIVRE").toUpperCase();

      const cls =
        status==="LIVRE" ? "bLivre" :
        status==="BLOQUEADO" ? "bBloq" :
        status==="CONFIRMADO" ? "bLivre" : "bOcup";

      const badge =
        status==="LIVRE" ? "Livre" :
        status==="BLOQUEADO" ? "Bloqueado" :
        status==="CONFIRMADO" ? "Confirmado" : "Ocupado";

      const codeChip = (s.codeTag && (status==="OCUPADO" || status==="CONFIRMADO"))
        ? `<span class="badge" style="margin-left:8px">${s.codeTag}</span>`
        : "";

      const name =
        (status==="OCUPADO" || status==="CONFIRMADO")
          ? `<div class="name blurName">${s.nomeMasked||"Ocupado"}</div>`
          : `<div class="name">—</div>`;

      return `
        <div class="slot ${cls}" data-slot="${String(s.slot)}" data-status="${status}">
          <div class="topRow">
            <div class="num">#${String(s.slot)}</div>
            <div style="display:flex; gap:8px;">
              <div class="badge">${badge}</div>
              ${codeChip}
            </div>
          </div>
          ${name}
        </div>
      `;
    }).join("");

    // eventos de clique (sem inline onclick)
    [...grid.querySelectorAll(".slot")].forEach(el=>{
      el.onclick = ()=>{
        const slot = el.getAttribute("data-slot");
        const status = el.getAttribute("data-status");
        clickSlot(slot, status);
      };
    });
  }

  function clickSlot(slot, status){
    if(status !== "LIVRE"){
      return toast(
        status==="BLOQUEADO" ? "⛔ Slot bloqueado" :
        status==="CONFIRMADO" ? "✅ Slot confirmado" :
        "⚠️ Slot ocupado"
      );
    }
    selectedSlot = slot;
    const slotNum = document.getElementById("slotNum");
    if(slotNum) slotNum.textContent = "#" + slot;
    showOverlay(true);
  }

  function fechar(){
    showOverlay(false);
    selectedSlot = null;
  }

  async function confirmar(){
    const code = normalizeCode(document.getElementById("code")?.value || "");
    if(!code) return toast("Código inválido");

    const nome = (document.getElementById("nome")?.value || "").trim();
    const rg   = (document.getElementById("rg")?.value || "").trim();
    const cpf  = (document.getElementById("cpf")?.value || "").trim();
    if(!nome || !rg || !cpf) return toast("Preencha Nome, RG e CPF");

    const veiculo = (document.getElementById("veiculo")?.value === "SIM");

    const payload = {
      code,
      slot: selectedSlot,
      nome, rg, cpf,
      veiculo,
      placa: document.getElementById("placa")?.value || "",
      cor: document.getElementById("cor")?.value || "",
      modelo: document.getElementById("modelo")?.value || ""
    };

    loading(true);
    const r = await api("vipReserve", payload);
    loading(false);

    if(!r.ok) return toast("❌ " + (r.error || "Erro"));

    showOverlay(false);
    selectedSlot = null;

    const g = await api("vipPublicGet", { code });
    if(g.ok){
      currentSlots = g.slots || [];
      renderGrid();
    }

    toast("✅ Reservado!");
  }

    // expõe pro HTML (se ainda usa onclick nos botões)
    window.entrar = entrar;
    window.confirmar = confirmar;
    window.fechar = fechar;
    window.toggleVeiculo = toggleVeiculo;
  });
</script>
